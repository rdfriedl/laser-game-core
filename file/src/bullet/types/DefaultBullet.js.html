<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../../">
  <title data-ice="title">src/bullet/types/DefaultBullet.js | Lazer Game Core</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="The core logic for lazer-game"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="Lazer Game Core"><meta property="twitter:description" content="The core logic for lazer-game"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/rdfriedl/lazer-game-core"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-buildCollisions">buildCollisions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-clipDecimals">clipDecimals</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-lerp">lerp</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-COLLISION_GROUPS">COLLISION_GROUPS</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#bullet">bullet</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bullet/Bullet.js~Bullet.html">Bullet</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bullet/BulletManager.js~BulletManager.html">BulletManager</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#bullet-types">bullet/types</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/bullet/types/DefaultBullet.js~DefaultBullet.html">DefaultBullet</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#game">game</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/game/Game.js~Game.html">Game</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#player">player</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/player/Player.js~Player.html">Player</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/player/PlayerManager.js~PlayerManager.html">PlayerManager</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#tilemap">tilemap</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/tilemap/Tilemap.js~Tilemap.html">Tilemap</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/bullet/types/DefaultBullet.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import p2 from &quot;p2&quot;;
import { lerp } from &quot;../../utils&quot;;
import Bullet from &quot;../Bullet&quot;;
import { COLLISION_GROUPS } from &quot;../../const&quot;;

export default class DefaultBullet extends Bullet {
	init() {
		super.init();

		// init data
		this.data.speed = 500;
		this.data.pathPosition = 0;
		this.data.position = { x: 0, y: 0 };
		this.data.path = DefaultBullet.calcPath(this.game.world, {
			start: [this.props.start.x, this.props.start.y],
			direction: this.props.direction,
		});
		this.data.pathLength = this.data.path.length ? this.data.path[this.data.path.length - 1][2] : 0;
	}
	update(d) {
		// move along the path
		this.data.pathPosition += this.data.speed * d;

		// set position
		this.data.position = DefaultBullet.pointOnPath(this.data.path, this.data.pathPosition);

		// set the direction
		this.data.direction = DefaultBullet.directionOnPath(this.data.path, this.data.pathPosition);

		// die if the bullet is at the end of the path
		if (this.data.pathPosition &gt; this.data.pathLength &amp;&amp; this.game.isMaster) this.die();
	}

	static calcPath(world, opts = {}) {
		if (!world) return [];
		opts = Object.assign(
			{},
			{
				maxDistance: 1000,
				maxBounces: 5,
				start: [0, 0],
				direction: 0,
			},
			opts,
		);

		let path = [],
			currentLength = 0;
		let ray = (this.calcPath.ray =
			this.calcPath.ray ||
			new p2.Ray({
				mode: p2.Ray.CLOSEST,
				collisionGroup: COLLISION_GROUPS.BULLET,
				collisionMask: COLLISION_GROUPS.WALLS,
			}));
		let result = (this.calcPath.result = this.calcPath.result || new p2.RaycastResult());
		let hitPoint = (this.calcPath.hitPoint = this.calcPath.hitPoint || p2.vec2.create());

		// set the rays direction
		ray.from[0] = opts.start[0];
		ray.from[1] = opts.start[1];
		ray.direction[0] = Math.cos(opts.direction);
		ray.direction[1] = Math.sin(opts.direction);

		ray.to[0] = ray.from[0] + ray.direction[0] * (opts.maxDistance - currentLength);
		ray.to[1] = ray.from[1] + ray.direction[1] * (opts.maxDistance - currentLength);

		ray.update();

		// cast
		path = [[opts.start[0], opts.start[1], 0]];
		let hits = 0;
		while (currentLength &lt; opts.maxDistance &amp;&amp; hits &lt; opts.maxBounces) {
			if (world.raycast(result, ray)) {
				hits++;
				result.getHitPoint(hitPoint, ray);
				// add the path segment
				path.push([hitPoint[0], hitPoint[1], (currentLength += result.getHitDistance(ray))]);

				// move start to the hit point
				p2.vec2.copy(ray.from, hitPoint);

				// reflect the direction
				p2.vec2.reflect(ray.direction, ray.direction, result.normal);

				// move the ray out a bit
				ray.from[0] += ray.direction[0] * 0.001;
				ray.from[1] += ray.direction[1] * 0.001;
				ray.to[0] = ray.from[0] + ray.direction[0] * (opts.maxDistance - currentLength);
				ray.to[1] = ray.from[1] + ray.direction[1] * (opts.maxDistance - currentLength);
				ray.update();
				result.reset();
			} else {
				let distanceLeft = opts.maxDistance - currentLength;
				path.push([ray.to[0], ray.to[1], (currentLength += distanceLeft)]);
			}
		}

		return path;
	}

	/**
	 * @param path
	 * @param {Number} position - a number between 0 and 1
	 */
	static pointOnPath(path, position = 0) {
		let pos = {};
		let prev,
			next = path.find(point =&gt; point[2] &gt; position);
		for (let i = path.length - 1; i &gt;= 0; i--) {
			if (path[i][2] &lt;= position) {
				prev = path[i];
				break;
			}
		}
		if (next) {
			let delta = (position - prev[2]) / (next[2] - prev[2]);
			pos.x = lerp(prev[0], next[0], delta);
			pos.y = lerp(prev[1], next[1], delta);
		} else {
			pos.x = prev[0];
			pos.y = prev[1];
		}

		return pos;
	}

	/**
	 * returns the bullets directions on a point on the path
	 * @param path
	 * @param position
	 * @return {number} - the rotation is in radians
	 */
	static directionOnPath(path, position = 0) {
		let prev,
			next = path.find(point =&gt; point[2] &gt; position);
		for (let i = path.length - 1; i &gt;= 0; i--) {
			if (path[i][2] &lt;= position) {
				prev = path[i];
				break;
			}
		}

		if (next) return Math.atan2(next[0] - prev[0], next[1] - prev[1]);

		return 0;
	}
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.0.4)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
