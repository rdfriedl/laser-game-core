import Hashids from"hashids";import{Emitter}from"regexp-events";import p2 from"p2";var classCallCheck=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,a,r){return a&&t(e.prototype,a),r&&t(e,r),e}}(),get=function t(e,a,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,a);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,a,r)}if("value"in o)return o.value;var s=o.get;return void 0!==s?s.call(r):void 0},inherits=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},possibleConstructorReturn=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},bulletIds=new Hashids("bullets"),Bullet=function(t){function e(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};classCallCheck(this,e);var o=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return o.manager=t,o.id=bulletIds.encode(Date.now()),o.info=Object.assign({owner:void 0},a),o.props=Object.assign({},r),o.data={},o.init(),o}return inherits(e,Emitter),createClass(e,[{key:"init",value:function(){}},{key:"setProp",value:function(t,e){if(t instanceof Object){for(var a in t)this.props[a]=t[a];this.emit("props-changed",this.props)}else this.props[t]=e,this.emit("props-changed",this.props);return this}},{key:"getProp",value:function(t){return this.props[t]}},{key:"update",value:function(t){}},{key:"destroy",value:function(){return this.manager.removeBullet(this),this}},{key:"die",value:function(){return this.destroy()}},{key:"toJSON",value:function(){var t={id:this.id,info:this.info,props:this.props,type:this.type};return this.emit("to-json",t),t}},{key:"fromJSON",value:function(t){return this.id=t.id||this.id,t.info&&Object.assign(this.info,t.info),t.props&&Object.assign(this.props,t.props),this.init(),this}},{key:"emit",value:function(t){for(var e,a,r,o=arguments.length,i=Array(o>1?o-1:0),s=1;s<o;s++)i[s-1]=arguments[s];var n=(e=Emitter.prototype.emit).call.apply(e,[this,t].concat(i));return(a=this.manager).emit.apply(a,["bullet-"+t,this].concat(i)),(r=this.manager).emit.apply(r,["bullet-"+this.id+"-"+t,this].concat(i)),n}},{key:"game",get:function(){return this.manager.game}},{key:"player",get:function(){return this.game.players.getPlayer(this.info.owner)}},{key:"type",get:function(){return this.manager.getBulletType(this)}}]),e}();function lerp(t,e,a){return t*(1-a)+e*a}function clipDecimals(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return Math.round(t*Math.pow(10,e))/Math.pow(10,e)}var COLLISION_GROUPS={PLAYER:Math.pow(2,0),WALLS:Math.pow(2,1),BULLET:Math.pow(2,2)};COLLISION_GROUPS.ALL=Object.keys(COLLISION_GROUPS).map(function(t){return COLLISION_GROUPS[t]}).reduce(function(t,e){return t|e});var DefaultBullet=function(t){function e(){return classCallCheck(this,e),possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return inherits(e,Bullet),createClass(e,[{key:"init",value:function(){get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"init",this).call(this),this.data.speed=500,this.data.pathPosition=0,this.data.position={x:0,y:0},this.data.path=e.calcPath(this.game.world,{start:[this.props.start.x,this.props.start.y],direction:this.props.direction}),this.data.pathLength=this.data.path.length?this.data.path[this.data.path.length-1][2]:0}},{key:"update",value:function(t){this.data.pathPosition+=this.data.speed*t,this.data.position=e.pointOnPath(this.data.path,this.data.pathPosition),this.data.direction=e.directionOnPath(this.data.path,this.data.pathPosition),this.data.pathPosition>this.data.pathLength&&this.game.isMaster&&this.die()}}],[{key:"calcPath",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t)return[];e=Object.assign({},{maxDistance:1e3,maxBounces:5,start:[0,0],direction:0},e);var a=[],r=0,o=this.calcPath.ray=this.calcPath.ray||new p2.Ray({mode:p2.Ray.CLOSEST,collisionGroup:COLLISION_GROUPS.BULLET,collisionMask:COLLISION_GROUPS.WALLS}),i=this.calcPath.result=this.calcPath.result||new p2.RaycastResult,s=this.calcPath.hitPoint=this.calcPath.hitPoint||p2.vec2.create();o.from[0]=e.start[0],o.from[1]=e.start[1],o.direction[0]=Math.cos(e.direction),o.direction[1]=Math.sin(e.direction),o.to[0]=o.from[0]+o.direction[0]*(e.maxDistance-r),o.to[1]=o.from[1]+o.direction[1]*(e.maxDistance-r),o.update(),a=[[e.start[0],e.start[1],0]];for(var n=0;r<e.maxDistance&&n<e.maxBounces;)if(t.raycast(i,o))n++,i.getHitPoint(s,o),a.push([s[0],s[1],r+=i.getHitDistance(o)]),p2.vec2.copy(o.from,s),p2.vec2.reflect(o.direction,o.direction,i.normal),o.from[0]+=.001*o.direction[0],o.from[1]+=.001*o.direction[1],o.to[0]=o.from[0]+o.direction[0]*(e.maxDistance-r),o.to[1]=o.from[1]+o.direction[1]*(e.maxDistance-r),o.update(),i.reset();else{var c=e.maxDistance-r;a.push([o.to[0],o.to[1],r+=c])}return a}},{key:"pointOnPath",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a={},r=void 0,o=t.find(function(t){return t[2]>e}),i=t.length-1;i>=0;i--)if(t[i][2]<=e){r=t[i];break}if(o){var s=(e-r[2])/(o[2]-r[2]);a.x=lerp(r[0],o[0],s),a.y=lerp(r[1],o[1],s)}else a.x=r[0],a.y=r[1];return a}},{key:"directionOnPath",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=void 0,r=t.find(function(t){return t[2]>e}),o=t.length-1;o>=0;o--)if(t[o][2]<=e){a=t[o];break}return r?Math.atan2(r[0]-a[0],r[1]-a[1]):0}}]),e}(),BulletManager=function(t){function e(t){classCallCheck(this,e);var a=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.game=t,a.bullets=[],a}return inherits(e,Emitter),createClass(e,[{key:"createBullet",value:function(t,a,r){var o=e.BulletTypes[t];if(o){var i=new o(this,a,r);return this.bullets.push(i),this.emit("bullet-created",i),i}}},{key:"createFromJSON",value:function(t){var a=e.BulletTypes[t.type];if(a){var r=new a(this,t.info,t.props);return r.fromJSON(t),this.bullets.push(r),this.emit("bullet-created",r),r}}},{key:"getBullet",value:function(t){return t instanceof Bullet?this.bullets.includes(t)?t:void 0:this.bullets.find(function(e){return e.id==t})}},{key:"removeBullet",value:function(t){var e=this.getBullet(t);return this.bullets.includes(e)&&(this.bullets.splice(this.bullets.indexOf(e),1),this.emit("bullet-removed",e)),this}},{key:"clearBullets",value:function(){var t=this;return this.bullets.forEach(function(e){return t.removeBullet(e)}),this.bullets=[],this}},{key:"update",value:function(t){this.bullets.forEach(function(e){return e.update(t)})}},{key:"toJSON",value:function(){var t=this.bullets.map(function(t){return t.toJSON()});return this.emit("to-json",t),t}},{key:"fromJSON",value:function(t){var e=this;return this.clearBullets(),t.forEach(function(t){e.createBullet(t.type).fromJSON(t.data)}),this.emit("from-json",t),this}},{key:"getBulletType",value:function(t){for(var a in e.BulletTypes)if(t instanceof e.BulletTypes[a])return a}}]),e}();BulletManager.BulletTypes={default:DefaultBullet},BulletManager.BULLET_TYPE={DEFAULT:"default"};var playerIds=new Hashids("players"),Player=function(t){function e(t,a,r){classCallCheck(this,e);var o=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return o.manager=t,o.id=playerIds.encode(Date.now()),o.info={name:void 0,color:0},o.props={health:100,spawned:!1},o.position={x:0,y:0,vx:0,vy:0,direction:0},o.controls={moveX:0,moveY:0,shoot:!1,direction:0},o.body=new p2.Body({mass:10,damping:0,fixedRotation:!0}),o.body.addShape(new p2.Circle({radius:10})),o.body.shapes.forEach(function(t){t.collisionGroup=COLLISION_GROUPS.PLAYER,t.collisionMask=COLLISION_GROUPS.WALLS|COLLISION_GROUPS.BULLET|COLLISION_GROUPS.PLAYER}),o.cooldown=.15,o.tmp=0,a&&o.setInfo(a),r&&o.setProp(r),o}return inherits(e,Emitter),createClass(e,[{key:"setProp",value:function(t,e){if(t instanceof Object){for(var a in t)this.props[a]=t[a];this.emit("props-changed",this.props)}else this.props[t]=e,this.emit("props-changed",this.props);return this}},{key:"setInfo",value:function(t,e){if(t instanceof Object){for(var a in t)this.info[a]=t[a];this.emit("info-changed",this.info)}else this.info[t]=e,this.emit("info-changed",this.info);return this}},{key:"setControl",value:function(t,e){if(t instanceof Object){for(var a in t)this.controls[a]=t[a];this.emit("controls-changed",this.controls)}else this.controls[t]=e,this.emit("controls-changed",this.controls);return this}},{key:"getProp",value:function(t,e){return this.props[t]}},{key:"getInfo",value:function(t,e){return this.info[t]}},{key:"getControl",value:function(t,e){return this.controls[t]}},{key:"setPosition",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.body.position[0],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.body.position[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=arguments[4];this.body.position[0]=t,this.body.position[1]=e,this.body.velocity[0]=a,this.body.velocity[1]=r,this.position.direction=o,this._updatePosition()}},{key:"update",value:function(t){var e=this.game.config.player.movement,a=e.speed,r=e.excelerate,o=e.decelerate;0!==this.controls.moveX?this.body.velocity[0]=lerp(this.body.velocity[0],a*Math.sign(this.controls.moveX),r):this.body.velocity[0]*=o,0!==this.controls.moveY?this.body.velocity[1]=lerp(this.body.velocity[1],a*Math.sign(this.controls.moveY),r):this.body.velocity[1]*=o,this.tmp+=t,this.controls.shoot&&this.game.isMaster&&this.tmp>this.cooldown&&(this.tmp=0,this.game.bullets.createBullet(BulletManager.BULLET_TYPE.DEFAULT,{owner:this.id},{start:{x:this.position.x,y:this.position.y},direction:this.controls.direction+(Math.random()-.5)*(Math.PI/32)})),this._updatePosition(),this.emit("update",t)}},{key:"_updatePosition",value:function(){this.position.x=clipDecimals(this.body.position[0]),this.position.y=clipDecimals(this.body.position[1]),this.position.vx=clipDecimals(this.body.velocity[0]),this.position.vy=clipDecimals(this.body.velocity[1])}},{key:"toJSON",value:function(){var t={id:this.id,info:this.info,props:this.props,position:this.position,controls:this.controls};return this.emit("to-json",t),t}},{key:"fromJSON",value:function(t){return this.id=t.id,this.setInfo(t.info),this.setProp(t.props),this.setControl(t.controls),Object.assign(this.position,t.position),this.emit("from-json",t),this}},{key:"emit",value:function(t){for(var e,a,r,o=arguments.length,i=Array(o>1?o-1:0),s=1;s<o;s++)i[s-1]=arguments[s];var n=(e=Emitter.prototype.emit).call.apply(e,[this,t].concat(i));return(a=this.manager).emit.apply(a,["player-"+t,this].concat(i)),(r=this.manager).emit.apply(r,["player-"+this.id+"-"+t,this].concat(i)),n}},{key:"game",get:function(){return this.manager.game}}]),e}(),PlayerManager=function(t){function e(t){classCallCheck(this,e);var a=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.game=t,a.players=[],a}return inherits(e,Emitter),createClass(e,[{key:"getPlayer",value:function(t){return t instanceof Player?this.players.includes(t)?t:void 0:this.players.find(function(e){return e.id===t})}},{key:"createPlayer",value:function(t,e){var a=new Player(this,t,e);return this.players.push(a),this.game.world.addBody(a.body),this.emit("player-created",a),a}},{key:"createFromJSON",value:function(t){var e=new Player(this,t.info,t.props);return e.fromJSON(t),this.players.push(e),this.game.world.addBody(e.body),this.emit("player-created",e),e}},{key:"removePlayer",value:function(t){var e=this.getPlayer(t);return this.players.includes(e)&&(this.players.splice(this.players.indexOf(e),1),this.game.world.removeBody(e.body),this.emit("player-removed",e)),this}},{key:"clearPlayers",value:function(){var t=Array.from(this.players);return this.players.forEach(this.removePlayer.bind(this)),this.emit("players-cleared",t),this}},{key:"update",value:function(t){this.players.forEach(function(e){return e.update(t)})}},{key:"toJSON",value:function(){var t=this.players.map(function(t){return t.toJSON()});return this.emit("to-json",t),t}},{key:"fromJSON",value:function(t){var e=this;return this.clearPlayers(),t.forEach(function(t){e.createPlayer().fromJSON(t)}),this.emit("from-json",t),this}}]),e}();function listCacheClear(){this.__data__=[],this.size=0}var _listCacheClear=listCacheClear;function eq(t,e){return t===e||t!=t&&e!=e}var eq_1=eq;function assocIndexOf(t,e){for(var a=t.length;a--;)if(eq_1(t[a][0],e))return a;return-1}var _assocIndexOf=assocIndexOf,arrayProto=Array.prototype,splice=arrayProto.splice;function listCacheDelete(t){var e=this.__data__,a=_assocIndexOf(e,t);return!(a<0)&&(a==e.length-1?e.pop():splice.call(e,a,1),--this.size,!0)}var _listCacheDelete=listCacheDelete;function listCacheGet(t){var e=this.__data__,a=_assocIndexOf(e,t);return a<0?void 0:e[a][1]}var _listCacheGet=listCacheGet;function listCacheHas(t){return _assocIndexOf(this.__data__,t)>-1}var _listCacheHas=listCacheHas;function listCacheSet(t,e){var a=this.__data__,r=_assocIndexOf(a,t);return r<0?(++this.size,a.push([t,e])):a[r][1]=e,this}var _listCacheSet=listCacheSet;function ListCache(t){var e=-1,a=null==t?0:t.length;for(this.clear();++e<a;){var r=t[e];this.set(r[0],r[1])}}ListCache.prototype.clear=_listCacheClear,ListCache.prototype.delete=_listCacheDelete,ListCache.prototype.get=_listCacheGet,ListCache.prototype.has=_listCacheHas,ListCache.prototype.set=_listCacheSet;var _ListCache=ListCache;function stackClear(){this.__data__=new _ListCache,this.size=0}var _stackClear=stackClear;function stackDelete(t){var e=this.__data__,a=e.delete(t);return this.size=e.size,a}var _stackDelete=stackDelete;function stackGet(t){return this.__data__.get(t)}var _stackGet=stackGet;function stackHas(t){return this.__data__.has(t)}var _stackHas=stackHas,commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(t,e){return t(e={exports:{}},e.exports),e.exports}var freeGlobal="object"==typeof commonjsGlobal&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,_freeGlobal=freeGlobal,freeSelf="object"==typeof self&&self&&self.Object===Object&&self,root=_freeGlobal||freeSelf||Function("return this")(),_root=root,Symbol$1=_root.Symbol,_Symbol=Symbol$1,objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty,nativeObjectToString=objectProto.toString,symToStringTag=_Symbol?_Symbol.toStringTag:void 0;function getRawTag(t){var e=hasOwnProperty.call(t,symToStringTag),a=t[symToStringTag];try{t[symToStringTag]=void 0;var r=!0}catch(t){}var o=nativeObjectToString.call(t);return r&&(e?t[symToStringTag]=a:delete t[symToStringTag]),o}var _getRawTag=getRawTag,objectProto$1=Object.prototype,nativeObjectToString$1=objectProto$1.toString;function objectToString(t){return nativeObjectToString$1.call(t)}var _objectToString=objectToString,nullTag="[object Null]",undefinedTag="[object Undefined]",symToStringTag$1=_Symbol?_Symbol.toStringTag:void 0;function baseGetTag(t){return null==t?void 0===t?undefinedTag:nullTag:symToStringTag$1&&symToStringTag$1 in Object(t)?_getRawTag(t):_objectToString(t)}var _baseGetTag=baseGetTag;function isObject(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}var isObject_1=isObject,asyncTag="[object AsyncFunction]",funcTag="[object Function]",genTag="[object GeneratorFunction]",proxyTag="[object Proxy]";function isFunction(t){if(!isObject_1(t))return!1;var e=_baseGetTag(t);return e==funcTag||e==genTag||e==asyncTag||e==proxyTag}var isFunction_1=isFunction,coreJsData=_root["__core-js_shared__"],_coreJsData=coreJsData,maskSrcKey=function(){var t=/[^.]+$/.exec(_coreJsData&&_coreJsData.keys&&_coreJsData.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}();function isMasked(t){return!!maskSrcKey&&maskSrcKey in t}var _isMasked=isMasked,funcProto=Function.prototype,funcToString=funcProto.toString;function toSource(t){if(null!=t){try{return funcToString.call(t)}catch(t){}try{return t+""}catch(t){}}return""}var _toSource=toSource,reRegExpChar=/[\\^$.*+?()[\]{}|]/g,reIsHostCtor=/^\[object .+?Constructor\]$/,funcProto$1=Function.prototype,objectProto$2=Object.prototype,funcToString$1=funcProto$1.toString,hasOwnProperty$1=objectProto$2.hasOwnProperty,reIsNative=RegExp("^"+funcToString$1.call(hasOwnProperty$1).replace(reRegExpChar,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function baseIsNative(t){return!(!isObject_1(t)||_isMasked(t))&&(isFunction_1(t)?reIsNative:reIsHostCtor).test(_toSource(t))}var _baseIsNative=baseIsNative;function getValue(t,e){return null==t?void 0:t[e]}var _getValue=getValue;function getNative(t,e){var a=_getValue(t,e);return _baseIsNative(a)?a:void 0}var _getNative=getNative,Map=_getNative(_root,"Map"),_Map=Map,nativeCreate=_getNative(Object,"create"),_nativeCreate=nativeCreate;function hashClear(){this.__data__=_nativeCreate?_nativeCreate(null):{},this.size=0}var _hashClear=hashClear;function hashDelete(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e}var _hashDelete=hashDelete,HASH_UNDEFINED="__lodash_hash_undefined__",objectProto$3=Object.prototype,hasOwnProperty$2=objectProto$3.hasOwnProperty;function hashGet(t){var e=this.__data__;if(_nativeCreate){var a=e[t];return a===HASH_UNDEFINED?void 0:a}return hasOwnProperty$2.call(e,t)?e[t]:void 0}var _hashGet=hashGet,objectProto$4=Object.prototype,hasOwnProperty$3=objectProto$4.hasOwnProperty;function hashHas(t){var e=this.__data__;return _nativeCreate?void 0!==e[t]:hasOwnProperty$3.call(e,t)}var _hashHas=hashHas,HASH_UNDEFINED$1="__lodash_hash_undefined__";function hashSet(t,e){var a=this.__data__;return this.size+=this.has(t)?0:1,a[t]=_nativeCreate&&void 0===e?HASH_UNDEFINED$1:e,this}var _hashSet=hashSet;function Hash(t){var e=-1,a=null==t?0:t.length;for(this.clear();++e<a;){var r=t[e];this.set(r[0],r[1])}}Hash.prototype.clear=_hashClear,Hash.prototype.delete=_hashDelete,Hash.prototype.get=_hashGet,Hash.prototype.has=_hashHas,Hash.prototype.set=_hashSet;var _Hash=Hash;function mapCacheClear(){this.size=0,this.__data__={hash:new _Hash,map:new(_Map||_ListCache),string:new _Hash}}var _mapCacheClear=mapCacheClear;function isKeyable(t){var e=typeof t;return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==t:null===t}var _isKeyable=isKeyable;function getMapData(t,e){var a=t.__data__;return _isKeyable(e)?a["string"==typeof e?"string":"hash"]:a.map}var _getMapData=getMapData;function mapCacheDelete(t){var e=_getMapData(this,t).delete(t);return this.size-=e?1:0,e}var _mapCacheDelete=mapCacheDelete;function mapCacheGet(t){return _getMapData(this,t).get(t)}var _mapCacheGet=mapCacheGet;function mapCacheHas(t){return _getMapData(this,t).has(t)}var _mapCacheHas=mapCacheHas;function mapCacheSet(t,e){var a=_getMapData(this,t),r=a.size;return a.set(t,e),this.size+=a.size==r?0:1,this}var _mapCacheSet=mapCacheSet;function MapCache(t){var e=-1,a=null==t?0:t.length;for(this.clear();++e<a;){var r=t[e];this.set(r[0],r[1])}}MapCache.prototype.clear=_mapCacheClear,MapCache.prototype.delete=_mapCacheDelete,MapCache.prototype.get=_mapCacheGet,MapCache.prototype.has=_mapCacheHas,MapCache.prototype.set=_mapCacheSet;var _MapCache=MapCache,LARGE_ARRAY_SIZE=200;function stackSet(t,e){var a=this.__data__;if(a instanceof _ListCache){var r=a.__data__;if(!_Map||r.length<LARGE_ARRAY_SIZE-1)return r.push([t,e]),this.size=++a.size,this;a=this.__data__=new _MapCache(r)}return a.set(t,e),this.size=a.size,this}var _stackSet=stackSet;function Stack(t){var e=this.__data__=new _ListCache(t);this.size=e.size}Stack.prototype.clear=_stackClear,Stack.prototype.delete=_stackDelete,Stack.prototype.get=_stackGet,Stack.prototype.has=_stackHas,Stack.prototype.set=_stackSet;var _Stack=Stack,HASH_UNDEFINED$2="__lodash_hash_undefined__";function setCacheAdd(t){return this.__data__.set(t,HASH_UNDEFINED$2),this}var _setCacheAdd=setCacheAdd;function setCacheHas(t){return this.__data__.has(t)}var _setCacheHas=setCacheHas;function SetCache(t){var e=-1,a=null==t?0:t.length;for(this.__data__=new _MapCache;++e<a;)this.add(t[e])}SetCache.prototype.add=SetCache.prototype.push=_setCacheAdd,SetCache.prototype.has=_setCacheHas;var _SetCache=SetCache;function arraySome(t,e){for(var a=-1,r=null==t?0:t.length;++a<r;)if(e(t[a],a,t))return!0;return!1}var _arraySome=arraySome;function cacheHas(t,e){return t.has(e)}var _cacheHas=cacheHas,COMPARE_PARTIAL_FLAG=1,COMPARE_UNORDERED_FLAG=2;function equalArrays(t,e,a,r,o,i){var s=a&COMPARE_PARTIAL_FLAG,n=t.length,c=e.length;if(n!=c&&!(s&&c>n))return!1;var l=i.get(t);if(l&&i.get(e))return l==e;var u=-1,h=!0,p=a&COMPARE_UNORDERED_FLAG?new _SetCache:void 0;for(i.set(t,e),i.set(e,t);++u<n;){var y=t[u],f=e[u];if(r)var g=s?r(f,y,u,e,t,i):r(y,f,u,t,e,i);if(void 0!==g){if(g)continue;h=!1;break}if(p){if(!_arraySome(e,function(t,e){if(!_cacheHas(p,e)&&(y===t||o(y,t,a,r,i)))return p.push(e)})){h=!1;break}}else if(y!==f&&!o(y,f,a,r,i)){h=!1;break}}return i.delete(t),i.delete(e),h}var _equalArrays=equalArrays,Uint8Array=_root.Uint8Array,_Uint8Array=Uint8Array;function mapToArray(t){var e=-1,a=Array(t.size);return t.forEach(function(t,r){a[++e]=[r,t]}),a}var _mapToArray=mapToArray;function setToArray(t){var e=-1,a=Array(t.size);return t.forEach(function(t){a[++e]=t}),a}var _setToArray=setToArray,COMPARE_PARTIAL_FLAG$1=1,COMPARE_UNORDERED_FLAG$1=2,boolTag="[object Boolean]",dateTag="[object Date]",errorTag="[object Error]",mapTag="[object Map]",numberTag="[object Number]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",symbolTag="[object Symbol]",arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",symbolProto=_Symbol?_Symbol.prototype:void 0,symbolValueOf=symbolProto?symbolProto.valueOf:void 0;function equalByTag(t,e,a,r,o,i,s){switch(a){case dataViewTag:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case arrayBufferTag:return!(t.byteLength!=e.byteLength||!i(new _Uint8Array(t),new _Uint8Array(e)));case boolTag:case dateTag:case numberTag:return eq_1(+t,+e);case errorTag:return t.name==e.name&&t.message==e.message;case regexpTag:case stringTag:return t==e+"";case mapTag:var n=_mapToArray;case setTag:var c=r&COMPARE_PARTIAL_FLAG$1;if(n||(n=_setToArray),t.size!=e.size&&!c)return!1;var l=s.get(t);if(l)return l==e;r|=COMPARE_UNORDERED_FLAG$1,s.set(t,e);var u=_equalArrays(n(t),n(e),r,o,i,s);return s.delete(t),u;case symbolTag:if(symbolValueOf)return symbolValueOf.call(t)==symbolValueOf.call(e)}return!1}var _equalByTag=equalByTag;function arrayPush(t,e){for(var a=-1,r=e.length,o=t.length;++a<r;)t[o+a]=e[a];return t}var _arrayPush=arrayPush,isArray=Array.isArray,isArray_1=isArray;function baseGetAllKeys(t,e,a){var r=e(t);return isArray_1(t)?r:_arrayPush(r,a(t))}var _baseGetAllKeys=baseGetAllKeys;function arrayFilter(t,e){for(var a=-1,r=null==t?0:t.length,o=0,i=[];++a<r;){var s=t[a];e(s,a,t)&&(i[o++]=s)}return i}var _arrayFilter=arrayFilter;function stubArray(){return[]}var stubArray_1=stubArray,objectProto$5=Object.prototype,propertyIsEnumerable=objectProto$5.propertyIsEnumerable,nativeGetSymbols=Object.getOwnPropertySymbols,getSymbols=nativeGetSymbols?function(t){return null==t?[]:(t=Object(t),_arrayFilter(nativeGetSymbols(t),function(e){return propertyIsEnumerable.call(t,e)}))}:stubArray_1,_getSymbols=getSymbols;function baseTimes(t,e){for(var a=-1,r=Array(t);++a<t;)r[a]=e(a);return r}var _baseTimes=baseTimes;function isObjectLike(t){return null!=t&&"object"==typeof t}var isObjectLike_1=isObjectLike,argsTag="[object Arguments]";function baseIsArguments(t){return isObjectLike_1(t)&&_baseGetTag(t)==argsTag}var _baseIsArguments=baseIsArguments,objectProto$6=Object.prototype,hasOwnProperty$4=objectProto$6.hasOwnProperty,propertyIsEnumerable$1=objectProto$6.propertyIsEnumerable,isArguments=_baseIsArguments(function(){return arguments}())?_baseIsArguments:function(t){return isObjectLike_1(t)&&hasOwnProperty$4.call(t,"callee")&&!propertyIsEnumerable$1.call(t,"callee")},isArguments_1=isArguments;function stubFalse(){return!1}var stubFalse_1=stubFalse,isBuffer_1=createCommonjsModule(function(t,e){var a=e&&!e.nodeType&&e,r=a&&t&&!t.nodeType&&t,o=r&&r.exports===a?_root.Buffer:void 0,i=(o?o.isBuffer:void 0)||stubFalse_1;t.exports=i}),MAX_SAFE_INTEGER=9007199254740991,reIsUint=/^(?:0|[1-9]\d*)$/;function isIndex(t,e){var a=typeof t;return!!(e=null==e?MAX_SAFE_INTEGER:e)&&("number"==a||"symbol"!=a&&reIsUint.test(t))&&t>-1&&t%1==0&&t<e}var _isIndex=isIndex,MAX_SAFE_INTEGER$1=9007199254740991;function isLength(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=MAX_SAFE_INTEGER$1}var isLength_1=isLength,argsTag$1="[object Arguments]",arrayTag="[object Array]",boolTag$1="[object Boolean]",dateTag$1="[object Date]",errorTag$1="[object Error]",funcTag$1="[object Function]",mapTag$1="[object Map]",numberTag$1="[object Number]",objectTag="[object Object]",regexpTag$1="[object RegExp]",setTag$1="[object Set]",stringTag$1="[object String]",weakMapTag="[object WeakMap]",arrayBufferTag$1="[object ArrayBuffer]",dataViewTag$1="[object DataView]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]",typedArrayTags={};function baseIsTypedArray(t){return isObjectLike_1(t)&&isLength_1(t.length)&&!!typedArrayTags[_baseGetTag(t)]}typedArrayTags[float32Tag]=typedArrayTags[float64Tag]=typedArrayTags[int8Tag]=typedArrayTags[int16Tag]=typedArrayTags[int32Tag]=typedArrayTags[uint8Tag]=typedArrayTags[uint8ClampedTag]=typedArrayTags[uint16Tag]=typedArrayTags[uint32Tag]=!0,typedArrayTags[argsTag$1]=typedArrayTags[arrayTag]=typedArrayTags[arrayBufferTag$1]=typedArrayTags[boolTag$1]=typedArrayTags[dataViewTag$1]=typedArrayTags[dateTag$1]=typedArrayTags[errorTag$1]=typedArrayTags[funcTag$1]=typedArrayTags[mapTag$1]=typedArrayTags[numberTag$1]=typedArrayTags[objectTag]=typedArrayTags[regexpTag$1]=typedArrayTags[setTag$1]=typedArrayTags[stringTag$1]=typedArrayTags[weakMapTag]=!1;var _baseIsTypedArray=baseIsTypedArray;function baseUnary(t){return function(e){return t(e)}}var _baseUnary=baseUnary,_nodeUtil=createCommonjsModule(function(t,e){var a=e&&!e.nodeType&&e,r=a&&t&&!t.nodeType&&t,o=r&&r.exports===a&&_freeGlobal.process,i=function(){try{return o&&o.binding&&o.binding("util")}catch(t){}}();t.exports=i}),nodeIsTypedArray=_nodeUtil&&_nodeUtil.isTypedArray,isTypedArray=nodeIsTypedArray?_baseUnary(nodeIsTypedArray):_baseIsTypedArray,isTypedArray_1=isTypedArray,objectProto$7=Object.prototype,hasOwnProperty$5=objectProto$7.hasOwnProperty;function arrayLikeKeys(t,e){var a=isArray_1(t),r=!a&&isArguments_1(t),o=!a&&!r&&isBuffer_1(t),i=!a&&!r&&!o&&isTypedArray_1(t),s=a||r||o||i,n=s?_baseTimes(t.length,String):[],c=n.length;for(var l in t)!e&&!hasOwnProperty$5.call(t,l)||s&&("length"==l||o&&("offset"==l||"parent"==l)||i&&("buffer"==l||"byteLength"==l||"byteOffset"==l)||_isIndex(l,c))||n.push(l);return n}var _arrayLikeKeys=arrayLikeKeys,objectProto$8=Object.prototype;function isPrototype(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||objectProto$8)}var _isPrototype=isPrototype;function overArg(t,e){return function(a){return t(e(a))}}var _overArg=overArg,nativeKeys=_overArg(Object.keys,Object),_nativeKeys=nativeKeys,objectProto$9=Object.prototype,hasOwnProperty$6=objectProto$9.hasOwnProperty;function baseKeys(t){if(!_isPrototype(t))return _nativeKeys(t);var e=[];for(var a in Object(t))hasOwnProperty$6.call(t,a)&&"constructor"!=a&&e.push(a);return e}var _baseKeys=baseKeys;function isArrayLike(t){return null!=t&&isLength_1(t.length)&&!isFunction_1(t)}var isArrayLike_1=isArrayLike;function keys(t){return isArrayLike_1(t)?_arrayLikeKeys(t):_baseKeys(t)}var keys_1=keys;function getAllKeys(t){return _baseGetAllKeys(t,keys_1,_getSymbols)}var _getAllKeys=getAllKeys,COMPARE_PARTIAL_FLAG$2=1,objectProto$10=Object.prototype,hasOwnProperty$7=objectProto$10.hasOwnProperty;function equalObjects(t,e,a,r,o,i){var s=a&COMPARE_PARTIAL_FLAG$2,n=_getAllKeys(t),c=n.length;if(c!=_getAllKeys(e).length&&!s)return!1;for(var l=c;l--;){var u=n[l];if(!(s?u in e:hasOwnProperty$7.call(e,u)))return!1}var h=i.get(t);if(h&&i.get(e))return h==e;var p=!0;i.set(t,e),i.set(e,t);for(var y=s;++l<c;){var f=t[u=n[l]],g=e[u];if(r)var _=s?r(g,f,u,e,t,i):r(f,g,u,t,e,i);if(!(void 0===_?f===g||o(f,g,a,r,i):_)){p=!1;break}y||(y="constructor"==u)}if(p&&!y){var d=t.constructor,v=e.constructor;d!=v&&"constructor"in t&&"constructor"in e&&!("function"==typeof d&&d instanceof d&&"function"==typeof v&&v instanceof v)&&(p=!1)}return i.delete(t),i.delete(e),p}var _equalObjects=equalObjects,DataView=_getNative(_root,"DataView"),_DataView=DataView,Promise$1=_getNative(_root,"Promise"),_Promise=Promise$1,Set=_getNative(_root,"Set"),_Set=Set,WeakMap=_getNative(_root,"WeakMap"),_WeakMap=WeakMap,mapTag$2="[object Map]",objectTag$1="[object Object]",promiseTag="[object Promise]",setTag$2="[object Set]",weakMapTag$1="[object WeakMap]",dataViewTag$2="[object DataView]",dataViewCtorString=_toSource(_DataView),mapCtorString=_toSource(_Map),promiseCtorString=_toSource(_Promise),setCtorString=_toSource(_Set),weakMapCtorString=_toSource(_WeakMap),getTag=_baseGetTag;(_DataView&&getTag(new _DataView(new ArrayBuffer(1)))!=dataViewTag$2||_Map&&getTag(new _Map)!=mapTag$2||_Promise&&getTag(_Promise.resolve())!=promiseTag||_Set&&getTag(new _Set)!=setTag$2||_WeakMap&&getTag(new _WeakMap)!=weakMapTag$1)&&(getTag=function(t){var e=_baseGetTag(t),a=e==objectTag$1?t.constructor:void 0,r=a?_toSource(a):"";if(r)switch(r){case dataViewCtorString:return dataViewTag$2;case mapCtorString:return mapTag$2;case promiseCtorString:return promiseTag;case setCtorString:return setTag$2;case weakMapCtorString:return weakMapTag$1}return e});var _getTag=getTag,COMPARE_PARTIAL_FLAG$3=1,argsTag$2="[object Arguments]",arrayTag$1="[object Array]",objectTag$2="[object Object]",objectProto$11=Object.prototype,hasOwnProperty$8=objectProto$11.hasOwnProperty;function baseIsEqualDeep(t,e,a,r,o,i){var s=isArray_1(t),n=isArray_1(e),c=s?arrayTag$1:_getTag(t),l=n?arrayTag$1:_getTag(e),u=(c=c==argsTag$2?objectTag$2:c)==objectTag$2,h=(l=l==argsTag$2?objectTag$2:l)==objectTag$2,p=c==l;if(p&&isBuffer_1(t)){if(!isBuffer_1(e))return!1;s=!0,u=!1}if(p&&!u)return i||(i=new _Stack),s||isTypedArray_1(t)?_equalArrays(t,e,a,r,o,i):_equalByTag(t,e,c,a,r,o,i);if(!(a&COMPARE_PARTIAL_FLAG$3)){var y=u&&hasOwnProperty$8.call(t,"__wrapped__"),f=h&&hasOwnProperty$8.call(e,"__wrapped__");if(y||f){var g=y?t.value():t,_=f?e.value():e;return i||(i=new _Stack),o(g,_,a,r,i)}}return!!p&&(i||(i=new _Stack),_equalObjects(t,e,a,r,o,i))}var _baseIsEqualDeep=baseIsEqualDeep;function baseIsEqual(t,e,a,r,o){return t===e||(null==t||null==e||!isObjectLike_1(t)&&!isObjectLike_1(e)?t!=t&&e!=e:_baseIsEqualDeep(t,e,a,r,baseIsEqual,o))}var _baseIsEqual=baseIsEqual;function isEqual(t,e){return _baseIsEqual(t,e)}var isEqual_1=isEqual,TILE_SIZE=50,Tilemap=function(t){function e(t){classCallCheck(this,e);var a=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.game=t,a.size={width:0,height:0},a.bodies=[],a.spawnAreas=[],a.loadedJSON={},a}return inherits(e,Emitter),createClass(e,[{key:"clearBodies",value:function(){var t=this;return this.bodies.forEach(function(e){return t.game.world.removeBody(e)}),this.bodies=[],this.emit("collisions-cleared"),this}},{key:"toJSON",value:function(){return this.loadedJSON}},{key:"fromJSON",value:function(t){var a=this;return this.clearBodies(),this.loadedJSON=t,this.size.width=t.size.width,this.size.height=t.size.height,this.bodies=e.buildCollisions(t.collisions),this.bodies.forEach(function(t){t.shapes.forEach(function(t){t.collisionGroup=COLLISION_GROUPS.WALLS,t.collisionMask=COLLISION_GROUPS.ALL})}),this.bodies.forEach(function(t){return a.game.world.addBody(t)}),this.emit("from-json",t),this}},{key:"getSpawnPoint",value:function(){return{x:this.size.width/2*TILE_SIZE,y:this.size.height/2*TILE_SIZE}}}],[{key:"buildCollisions",value:function(t){for(var e=[],a=0;a<t.length;a++){var r=t[a];if(r.visible)if(Array.isArray(r.polygon)){var o=new p2.Body({mass:0});o.position[0]=r.x,o.position[1]=r.y,o.fromPolygon(r.polygon.map(function(t){return[t.x,t.y]})),e.push(o)}else if(Array.isArray(r.polyline)){var i=new p2.Body({mass:0});i.position[0]=r.x,i.position[1]=r.y;for(var s=1;s<r.polyline.length;s++){var n=r.polyline[s-1],c=r.polyline[s],l=Math.sqrt(Math.pow(c.x-n.x,2)+Math.pow(c.y-n.y,2)),u=Math.atan2(c.y-n.y,c.x-n.x);i.addShape(new p2.Line({position:[lerp(n.x,c.x,.5),lerp(n.y,c.y,.5)],length:l,angle:u}))}e.push(i)}else if(r.height>0&&r.width>0){var h=new p2.Body({mass:0});h.position[0]=r.x+r.width/2,h.position[1]=r.y+r.height/2,h.addShape(new p2.Box({width:r.width,height:r.height})),e.push(h)}}return e}},{key:"parseTiledJSON",value:function(t){var e={size:{width:t.width,height:t.height},types:[],tiles:[]};e.collisions=t.layers.find(function(t){return t.objects&&"collision"==t.name&&"objectgroup"==t.type}).objects;var a={};return t.tilesets.forEach(function(t){for(var e in t.tileproperties){var r=parseInt(e)+t.firstgid;Reflect.ownKeys(t.tileproperties[e]).length>0&&(a[r]||(a[r]={}),Object.assign(a[r],t.tileproperties[e]))}}),t.layers.filter(function(t){return"tilelayer"===t.type}).forEach(function(r){for(var o=0;o<r.data.length;o++){var i=Math.floor(o/t.width),s=o-i*t.width;e.tiles[i]||(e.tiles[i]=[]),e.tiles[i][s]||(e.tiles[i][s]=[]);var n=a[r.data[o]];n&&e.tiles[i][s].push(n)}}),e.tiles=e.tiles.map(function(t){return t.map(function(t){var a=e.types.find(function(e){return isEqual_1(t,e)});return!a&&t.length>0&&e.types.push(a=t),e.types.indexOf(a)})}),e}}]),e}(),BASE_CONFIG={player:{movement:{speed:180,excelerate:.9,decelerate:.7},max:10}},Game=function(t){function e(t){classCallCheck(this,e);var a=possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a.id=t,a.info={},a.isMaster=!1,a.config=JSON.parse(JSON.stringify(BASE_CONFIG)),a.players=new PlayerManager(a),a.map=new Tilemap(a),a.bullets=new BulletManager(a),a.world=new p2.World({gravity:[0,0]}),a}return inherits(e,Emitter),createClass(e,[{key:"getPlayer",value:function(){var t;return(t=this.players).getPlayer.apply(t,arguments)}},{key:"createPlayer",value:function(){var t;return(t=this.players).createPlayer.apply(t,arguments)}},{key:"removePlayer",value:function(){var t;return(t=this.players).removePlayer.apply(t,arguments)}},{key:"spawnPlayer",value:function(t){var e=this.players.getPlayer(t),a=this.map.getSpawnPoint();return e.setPosition(a.x,a.y),e.setProp("spawned",!0),this}},{key:"setInfo",value:function(t,e){if(t instanceof Object){for(var a in t)this.info[a]=t[a];this.emit("info-changed",t)}else this.info[t]=e,this.emit("info-changed",t,e);return this}},{key:"getInfo",value:function(t,e){return this.info[t]}},{key:"getDelta",value:function(){var t=new Date,e=(t-this.lastDelta)/1e3;return this.lastDelta=t,e}},{key:"update",value:function(){var t=this.getDelta();this.world.step(1/60,t,1),this.players.update(t),this.bullets.update(t),this.emit("update",t)}},{key:"toJSON",value:function(){var t={id:this.id,info:this.info,config:this.config,map:this.map.toJSON(),players:this.players.toJSON()};return this.emit("to-json",t),t}},{key:"fromJSON",value:function(t){return this.id=t.id,this.setInfo(t.info),this.players.fromJSON(t.players),this.map.fromJSON(t.map),this.emit("from-json",t),this}},{key:"isClient",get:function(){return!this.isMaster}}]),e}();Game.DEFAULT_FPS=1/60;export{Game,Player,PlayerManager,Tilemap,Bullet,BulletManager};
//# sourceMappingURL=lazer-game-core.module.min.js.map
