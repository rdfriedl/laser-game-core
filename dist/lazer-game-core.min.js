"use strict";function _interopDefault(t){return t&&"object"==typeof t&&"default"in t?t.default:t}Object.defineProperty(exports,"__esModule",{value:!0});var Hashids=_interopDefault(require("hashids")),regexpEvents=require("regexp-events"),p2=_interopDefault(require("p2"));class Bullet extends regexpEvents.Emitter{constructor(t,e={},a={}){super(),this.manager=t,this.id=Bullet.ids.encode(Date.now()),this.info=Object.assign({owner:void 0},e),this.props=Object.assign({},a),this.data={},this.init()}init(){}setProp(t,e){if(t instanceof Object){for(let e in t)this.props[e]=t[e];this.emit("props-changed",this.props)}else this.props[t]=e,this.emit("props-changed",this.props);return this}getProp(t){return this.props[t]}update(t){}destroy(){return this.manager.removeBullet(this),this}die(){return this.destroy()}toJSON(){let t={id:this.id,info:this.info,props:this.props,type:this.type};return this.emit("to-json",t),t}fromJSON(t){return this.id=t.id||this.id,t.info&&Object.assign(this.info,t.info),t.props&&Object.assign(this.props,t.props),this.init(),this}emit(t,...e){let a=regexpEvents.Emitter.prototype.emit.call(this,t,...e);return this.manager.emit("bullet-"+t,this,...e),this.manager.emit(`bullet-${this.id}-${t}`,this,...e),a}get game(){return this.manager.game}get player(){return this.game.players.getPlayer(this.info.owner)}get type(){return this.manager.getBulletType(this)}}function lerp(t,e,a){return t*(1-a)+e*a}function clipDecimals(t,e=3){return Math.round(t*Math.pow(10,e))/Math.pow(10,e)}Bullet.ids=new Hashids("bullets");const COLLISION_GROUPS={PLAYER:Math.pow(2,0),WALLS:Math.pow(2,1),BULLET:Math.pow(2,2)};COLLISION_GROUPS.ALL=Object.keys(COLLISION_GROUPS).map(t=>COLLISION_GROUPS[t]).reduce((t,e)=>t|e);class DefaultBullet extends Bullet{init(){super.init(),this.data.speed=500,this.data.pathPosition=0,this.data.position={x:0,y:0},this.data.path=DefaultBullet.calcPath(this.game.world,{start:[this.props.start.x,this.props.start.y],direction:this.props.direction}),this.data.pathLength=this.data.path.length?this.data.path[this.data.path.length-1][2]:0}update(t){this.data.pathPosition+=this.data.speed*t,this.data.position=DefaultBullet.pointOnPath(this.data.path,this.data.pathPosition),this.data.direction=DefaultBullet.directionOnPath(this.data.path,this.data.pathPosition),this.data.pathPosition>this.data.pathLength&&this.game.isMaster&&this.die()}static calcPath(t,e={}){if(!t)return[];e=Object.assign({},{maxDistance:1e3,maxBounces:5,start:[0,0],direction:0},e);let a=[],r=0,s=this.calcPath.ray=this.calcPath.ray||new p2.Ray({mode:p2.Ray.CLOSEST,collisionGroup:COLLISION_GROUPS.BULLET,collisionMask:COLLISION_GROUPS.WALLS}),i=this.calcPath.result=this.calcPath.result||new p2.RaycastResult,o=this.calcPath.hitPoint=this.calcPath.hitPoint||p2.vec2.create();s.from[0]=e.start[0],s.from[1]=e.start[1],s.direction[0]=Math.cos(e.direction),s.direction[1]=Math.sin(e.direction),s.to[0]=s.from[0]+s.direction[0]*(e.maxDistance-r),s.to[1]=s.from[1]+s.direction[1]*(e.maxDistance-r),s.update(),a=[[e.start[0],e.start[1],0]];let n=0;for(;r<e.maxDistance&&n<e.maxBounces;)if(t.raycast(i,s))n++,i.getHitPoint(o,s),a.push([o[0],o[1],r+=i.getHitDistance(s)]),p2.vec2.copy(s.from,o),p2.vec2.reflect(s.direction,s.direction,i.normal),s.from[0]+=.001*s.direction[0],s.from[1]+=.001*s.direction[1],s.to[0]=s.from[0]+s.direction[0]*(e.maxDistance-r),s.to[1]=s.from[1]+s.direction[1]*(e.maxDistance-r),s.update(),i.reset();else{let t=e.maxDistance-r;a.push([s.to[0],s.to[1],r+=t])}return a}static pointOnPath(t,e=0){let a,r={},s=t.find(t=>t[2]>e);for(let r=t.length-1;r>=0;r--)if(t[r][2]<=e){a=t[r];break}if(s){let t=(e-a[2])/(s[2]-a[2]);r.x=lerp(a[0],s[0],t),r.y=lerp(a[1],s[1],t)}else r.x=a[0],r.y=a[1];return r}static directionOnPath(t,e=0){let a,r=t.find(t=>t[2]>e);for(let r=t.length-1;r>=0;r--)if(t[r][2]<=e){a=t[r];break}return r?Math.atan2(r[0]-a[0],r[1]-a[1]):0}}class BulletManager extends regexpEvents.Emitter{constructor(t){super(),this.game=t,this.bullets=[]}createBullet(t,e,a){let r=BulletManager.BulletTypes[t];if(!r)return;let s=new r(this,e,a);return this.bullets.push(s),this.emit("bullet-created",s),s}createFromJSON(t){let e=BulletManager.BulletTypes[t.type];if(!e)return;let a=new e(this,t.info,t.props);return a.fromJSON(t),this.bullets.push(a),this.emit("bullet-created",a),a}getBullet(t){return t instanceof Bullet?this.bullets.includes(t)?t:void 0:this.bullets.find(e=>e.id==t)}removeBullet(t){let e=this.getBullet(t);return this.bullets.includes(e)&&(this.bullets.splice(this.bullets.indexOf(e),1),this.emit("bullet-removed",e)),this}clearBullets(){return this.bullets.forEach(t=>this.removeBullet(t)),this.bullets=[],this}update(t){this.bullets.forEach(e=>e.update(t))}toJSON(){let t=this.bullets.map(t=>t.toJSON());return this.emit("to-json",t),t}fromJSON(t){return this.clearBullets(),t.forEach(t=>{this.createBullet(t.type).fromJSON(t.data)}),this.emit("from-json",t),this}getBulletType(t){for(let e in BulletManager.BulletTypes)if(t instanceof BulletManager.BulletTypes[e])return e}}BulletManager.BulletTypes={default:DefaultBullet},BulletManager.BULLET_TYPE={DEFAULT:"default"};class Player extends regexpEvents.Emitter{constructor(t,e,a){super(),this.manager=t,this.id=Player.ids.encode(Date.now()),this.info={name:void 0,color:0},this.props={health:100,spawned:!1},this.position={x:0,y:0,vx:0,vy:0,direction:0},this.controls={moveX:0,moveY:0,shoot:!1,direction:0},this.body=new p2.Body({mass:10,damping:0,fixedRotation:!0}),this.body.addShape(new p2.Circle({radius:10})),this.body.shapes.forEach(t=>{t.collisionGroup=COLLISION_GROUPS.PLAYER,t.collisionMask=COLLISION_GROUPS.WALLS|COLLISION_GROUPS.BULLET|COLLISION_GROUPS.PLAYER}),this.cooldown=.15,this.tmp=0,e&&this.setInfo(e),a&&this.setProp(a)}setProp(t,e){if(t instanceof Object){for(let e in t)this.props[e]=t[e];this.emit("props-changed",this.props)}else this.props[t]=e,this.emit("props-changed",this.props);return this}setInfo(t,e){if(t instanceof Object){for(let e in t)this.info[e]=t[e];this.emit("info-changed",this.info)}else this.info[t]=e,this.emit("info-changed",this.info);return this}setControl(t,e){if(t instanceof Object){for(let e in t)this.controls[e]=t[e];this.emit("controls-changed",this.controls)}else this.controls[t]=e,this.emit("controls-changed",this.controls);return this}getProp(t,e){return this.props[t]}getInfo(t,e){return this.info[t]}getControl(t,e){return this.controls[t]}setPosition(t=this.body.position[0],e=this.body.position[1],a=0,r=0,s){this.body.position[0]=t,this.body.position[1]=e,this.body.velocity[0]=a,this.body.velocity[1]=r,this.position.direction=s,this._updatePosition()}update(t){let{speed:e,excelerate:a,decelerate:r}=this.game.config.player.movement;0!==this.controls.moveX?this.body.velocity[0]=lerp(this.body.velocity[0],e*Math.sign(this.controls.moveX),a):this.body.velocity[0]*=r,0!==this.controls.moveY?this.body.velocity[1]=lerp(this.body.velocity[1],e*Math.sign(this.controls.moveY),a):this.body.velocity[1]*=r,this.tmp+=t,this.controls.shoot&&this.game.isMaster&&this.tmp>this.cooldown&&(this.tmp=0,this.game.bullets.createBullet(BulletManager.BULLET_TYPE.DEFAULT,{owner:this.id},{start:{x:this.position.x,y:this.position.y},direction:this.controls.direction+(Math.random()-.5)*(Math.PI/32)})),this._updatePosition(),this.emit("update",t)}_updatePosition(){this.position.x=clipDecimals(this.body.position[0]),this.position.y=clipDecimals(this.body.position[1]),this.position.vx=clipDecimals(this.body.velocity[0]),this.position.vy=clipDecimals(this.body.velocity[1])}toJSON(){let t={id:this.id,info:this.info,props:this.props,position:this.position,controls:this.controls};return this.emit("to-json",t),t}fromJSON(t){return this.id=t.id,this.setInfo(t.info),this.setProp(t.props),this.setControl(t.controls),Object.assign(this.position,t.position),this.emit("from-json",t),this}emit(t,...e){let a=regexpEvents.Emitter.prototype.emit.call(this,t,...e);return this.manager.emit("player-"+t,this,...e),this.manager.emit(`player-${this.id}-${t}`,this,...e),a}get game(){return this.manager.game}}Player.ids=new Hashids("players");class PlayerManager extends regexpEvents.Emitter{constructor(t){super(),this.game=t,this.players=[]}getPlayer(t){return t instanceof Player?this.players.includes(t)?t:void 0:this.players.find(e=>e.id===t)}createPlayer(t,e){let a=new Player(this,t,e);return this.players.push(a),this.game.world.addBody(a.body),this.emit("player-created",a),a}createFromJSON(t){let e=new Player(this,t.info,t.props);return e.fromJSON(t),this.players.push(e),this.game.world.addBody(e.body),this.emit("player-created",e),e}removePlayer(t){let e=this.getPlayer(t);return this.players.includes(e)&&(this.players.splice(this.players.indexOf(e),1),this.game.world.removeBody(e.body),this.emit("player-removed",e)),this}clearPlayers(){let t=Array.from(this.players);return this.players.forEach(this.removePlayer.bind(this)),this.emit("players-cleared",t),this}update(t){this.players.forEach(e=>e.update(t))}toJSON(){let t=this.players.map(t=>t.toJSON());return this.emit("to-json",t),t}fromJSON(t){return this.clearPlayers(),t.forEach(t=>{this.createPlayer().fromJSON(t)}),this.emit("from-json",t),this}}function listCacheClear(){this.__data__=[],this.size=0}var _listCacheClear=listCacheClear;function eq(t,e){return t===e||t!=t&&e!=e}var eq_1=eq;function assocIndexOf(t,e){for(var a=t.length;a--;)if(eq_1(t[a][0],e))return a;return-1}var _assocIndexOf=assocIndexOf,arrayProto=Array.prototype,splice=arrayProto.splice;function listCacheDelete(t){var e=this.__data__,a=_assocIndexOf(e,t);return!(a<0)&&(a==e.length-1?e.pop():splice.call(e,a,1),--this.size,!0)}var _listCacheDelete=listCacheDelete;function listCacheGet(t){var e=this.__data__,a=_assocIndexOf(e,t);return a<0?void 0:e[a][1]}var _listCacheGet=listCacheGet;function listCacheHas(t){return _assocIndexOf(this.__data__,t)>-1}var _listCacheHas=listCacheHas;function listCacheSet(t,e){var a=this.__data__,r=_assocIndexOf(a,t);return r<0?(++this.size,a.push([t,e])):a[r][1]=e,this}var _listCacheSet=listCacheSet;function ListCache(t){var e=-1,a=null==t?0:t.length;for(this.clear();++e<a;){var r=t[e];this.set(r[0],r[1])}}ListCache.prototype.clear=_listCacheClear,ListCache.prototype.delete=_listCacheDelete,ListCache.prototype.get=_listCacheGet,ListCache.prototype.has=_listCacheHas,ListCache.prototype.set=_listCacheSet;var _ListCache=ListCache;function stackClear(){this.__data__=new _ListCache,this.size=0}var _stackClear=stackClear;function stackDelete(t){var e=this.__data__,a=e.delete(t);return this.size=e.size,a}var _stackDelete=stackDelete;function stackGet(t){return this.__data__.get(t)}var _stackGet=stackGet;function stackHas(t){return this.__data__.has(t)}var _stackHas=stackHas,commonjsGlobal="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function createCommonjsModule(t,e){return t(e={exports:{}},e.exports),e.exports}var freeGlobal="object"==typeof commonjsGlobal&&commonjsGlobal&&commonjsGlobal.Object===Object&&commonjsGlobal,_freeGlobal=freeGlobal,freeSelf="object"==typeof self&&self&&self.Object===Object&&self,root=_freeGlobal||freeSelf||Function("return this")(),_root=root,Symbol=_root.Symbol,_Symbol=Symbol,objectProto=Object.prototype,hasOwnProperty=objectProto.hasOwnProperty,nativeObjectToString=objectProto.toString,symToStringTag=_Symbol?_Symbol.toStringTag:void 0;function getRawTag(t){var e=hasOwnProperty.call(t,symToStringTag),a=t[symToStringTag];try{t[symToStringTag]=void 0;var r=!0}catch(t){}var s=nativeObjectToString.call(t);return r&&(e?t[symToStringTag]=a:delete t[symToStringTag]),s}var _getRawTag=getRawTag,objectProto$1=Object.prototype,nativeObjectToString$1=objectProto$1.toString;function objectToString(t){return nativeObjectToString$1.call(t)}var _objectToString=objectToString,nullTag="[object Null]",undefinedTag="[object Undefined]",symToStringTag$1=_Symbol?_Symbol.toStringTag:void 0;function baseGetTag(t){return null==t?void 0===t?undefinedTag:nullTag:symToStringTag$1&&symToStringTag$1 in Object(t)?_getRawTag(t):_objectToString(t)}var _baseGetTag=baseGetTag;function isObject(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)}var isObject_1=isObject,asyncTag="[object AsyncFunction]",funcTag="[object Function]",genTag="[object GeneratorFunction]",proxyTag="[object Proxy]";function isFunction(t){if(!isObject_1(t))return!1;var e=_baseGetTag(t);return e==funcTag||e==genTag||e==asyncTag||e==proxyTag}var isFunction_1=isFunction,coreJsData=_root["__core-js_shared__"],_coreJsData=coreJsData,maskSrcKey=function(){var t=/[^.]+$/.exec(_coreJsData&&_coreJsData.keys&&_coreJsData.keys.IE_PROTO||"");return t?"Symbol(src)_1."+t:""}();function isMasked(t){return!!maskSrcKey&&maskSrcKey in t}var _isMasked=isMasked,funcProto=Function.prototype,funcToString=funcProto.toString;function toSource(t){if(null!=t){try{return funcToString.call(t)}catch(t){}try{return t+""}catch(t){}}return""}var _toSource=toSource,reRegExpChar=/[\\^$.*+?()[\]{}|]/g,reIsHostCtor=/^\[object .+?Constructor\]$/,funcProto$1=Function.prototype,objectProto$2=Object.prototype,funcToString$1=funcProto$1.toString,hasOwnProperty$1=objectProto$2.hasOwnProperty,reIsNative=RegExp("^"+funcToString$1.call(hasOwnProperty$1).replace(reRegExpChar,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function baseIsNative(t){return!(!isObject_1(t)||_isMasked(t))&&(isFunction_1(t)?reIsNative:reIsHostCtor).test(_toSource(t))}var _baseIsNative=baseIsNative;function getValue(t,e){return null==t?void 0:t[e]}var _getValue=getValue;function getNative(t,e){var a=_getValue(t,e);return _baseIsNative(a)?a:void 0}var _getNative=getNative,Map=_getNative(_root,"Map"),_Map=Map,nativeCreate=_getNative(Object,"create"),_nativeCreate=nativeCreate;function hashClear(){this.__data__=_nativeCreate?_nativeCreate(null):{},this.size=0}var _hashClear=hashClear;function hashDelete(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e}var _hashDelete=hashDelete,HASH_UNDEFINED="__lodash_hash_undefined__",objectProto$3=Object.prototype,hasOwnProperty$2=objectProto$3.hasOwnProperty;function hashGet(t){var e=this.__data__;if(_nativeCreate){var a=e[t];return a===HASH_UNDEFINED?void 0:a}return hasOwnProperty$2.call(e,t)?e[t]:void 0}var _hashGet=hashGet,objectProto$4=Object.prototype,hasOwnProperty$3=objectProto$4.hasOwnProperty;function hashHas(t){var e=this.__data__;return _nativeCreate?void 0!==e[t]:hasOwnProperty$3.call(e,t)}var _hashHas=hashHas,HASH_UNDEFINED$1="__lodash_hash_undefined__";function hashSet(t,e){var a=this.__data__;return this.size+=this.has(t)?0:1,a[t]=_nativeCreate&&void 0===e?HASH_UNDEFINED$1:e,this}var _hashSet=hashSet;function Hash(t){var e=-1,a=null==t?0:t.length;for(this.clear();++e<a;){var r=t[e];this.set(r[0],r[1])}}Hash.prototype.clear=_hashClear,Hash.prototype.delete=_hashDelete,Hash.prototype.get=_hashGet,Hash.prototype.has=_hashHas,Hash.prototype.set=_hashSet;var _Hash=Hash;function mapCacheClear(){this.size=0,this.__data__={hash:new _Hash,map:new(_Map||_ListCache),string:new _Hash}}var _mapCacheClear=mapCacheClear;function isKeyable(t){var e=typeof t;return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==t:null===t}var _isKeyable=isKeyable;function getMapData(t,e){var a=t.__data__;return _isKeyable(e)?a["string"==typeof e?"string":"hash"]:a.map}var _getMapData=getMapData;function mapCacheDelete(t){var e=_getMapData(this,t).delete(t);return this.size-=e?1:0,e}var _mapCacheDelete=mapCacheDelete;function mapCacheGet(t){return _getMapData(this,t).get(t)}var _mapCacheGet=mapCacheGet;function mapCacheHas(t){return _getMapData(this,t).has(t)}var _mapCacheHas=mapCacheHas;function mapCacheSet(t,e){var a=_getMapData(this,t),r=a.size;return a.set(t,e),this.size+=a.size==r?0:1,this}var _mapCacheSet=mapCacheSet;function MapCache(t){var e=-1,a=null==t?0:t.length;for(this.clear();++e<a;){var r=t[e];this.set(r[0],r[1])}}MapCache.prototype.clear=_mapCacheClear,MapCache.prototype.delete=_mapCacheDelete,MapCache.prototype.get=_mapCacheGet,MapCache.prototype.has=_mapCacheHas,MapCache.prototype.set=_mapCacheSet;var _MapCache=MapCache,LARGE_ARRAY_SIZE=200;function stackSet(t,e){var a=this.__data__;if(a instanceof _ListCache){var r=a.__data__;if(!_Map||r.length<LARGE_ARRAY_SIZE-1)return r.push([t,e]),this.size=++a.size,this;a=this.__data__=new _MapCache(r)}return a.set(t,e),this.size=a.size,this}var _stackSet=stackSet;function Stack(t){var e=this.__data__=new _ListCache(t);this.size=e.size}Stack.prototype.clear=_stackClear,Stack.prototype.delete=_stackDelete,Stack.prototype.get=_stackGet,Stack.prototype.has=_stackHas,Stack.prototype.set=_stackSet;var _Stack=Stack,HASH_UNDEFINED$2="__lodash_hash_undefined__";function setCacheAdd(t){return this.__data__.set(t,HASH_UNDEFINED$2),this}var _setCacheAdd=setCacheAdd;function setCacheHas(t){return this.__data__.has(t)}var _setCacheHas=setCacheHas;function SetCache(t){var e=-1,a=null==t?0:t.length;for(this.__data__=new _MapCache;++e<a;)this.add(t[e])}SetCache.prototype.add=SetCache.prototype.push=_setCacheAdd,SetCache.prototype.has=_setCacheHas;var _SetCache=SetCache;function arraySome(t,e){for(var a=-1,r=null==t?0:t.length;++a<r;)if(e(t[a],a,t))return!0;return!1}var _arraySome=arraySome;function cacheHas(t,e){return t.has(e)}var _cacheHas=cacheHas,COMPARE_PARTIAL_FLAG=1,COMPARE_UNORDERED_FLAG=2;function equalArrays(t,e,a,r,s,i){var o=a&COMPARE_PARTIAL_FLAG,n=t.length,l=e.length;if(n!=l&&!(o&&l>n))return!1;var c=i.get(t);if(c&&i.get(e))return c==e;var h=-1,p=!0,u=a&COMPARE_UNORDERED_FLAG?new _SetCache:void 0;for(i.set(t,e),i.set(e,t);++h<n;){var y=t[h],g=e[h];if(r)var _=o?r(g,y,h,e,t,i):r(y,g,h,t,e,i);if(void 0!==_){if(_)continue;p=!1;break}if(u){if(!_arraySome(e,function(t,e){if(!_cacheHas(u,e)&&(y===t||s(y,t,a,r,i)))return u.push(e)})){p=!1;break}}else if(y!==g&&!s(y,g,a,r,i)){p=!1;break}}return i.delete(t),i.delete(e),p}var _equalArrays=equalArrays,Uint8Array=_root.Uint8Array,_Uint8Array=Uint8Array;function mapToArray(t){var e=-1,a=Array(t.size);return t.forEach(function(t,r){a[++e]=[r,t]}),a}var _mapToArray=mapToArray;function setToArray(t){var e=-1,a=Array(t.size);return t.forEach(function(t){a[++e]=t}),a}var _setToArray=setToArray,COMPARE_PARTIAL_FLAG$1=1,COMPARE_UNORDERED_FLAG$1=2,boolTag="[object Boolean]",dateTag="[object Date]",errorTag="[object Error]",mapTag="[object Map]",numberTag="[object Number]",regexpTag="[object RegExp]",setTag="[object Set]",stringTag="[object String]",symbolTag="[object Symbol]",arrayBufferTag="[object ArrayBuffer]",dataViewTag="[object DataView]",symbolProto=_Symbol?_Symbol.prototype:void 0,symbolValueOf=symbolProto?symbolProto.valueOf:void 0;function equalByTag(t,e,a,r,s,i,o){switch(a){case dataViewTag:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case arrayBufferTag:return!(t.byteLength!=e.byteLength||!i(new _Uint8Array(t),new _Uint8Array(e)));case boolTag:case dateTag:case numberTag:return eq_1(+t,+e);case errorTag:return t.name==e.name&&t.message==e.message;case regexpTag:case stringTag:return t==e+"";case mapTag:var n=_mapToArray;case setTag:var l=r&COMPARE_PARTIAL_FLAG$1;if(n||(n=_setToArray),t.size!=e.size&&!l)return!1;var c=o.get(t);if(c)return c==e;r|=COMPARE_UNORDERED_FLAG$1,o.set(t,e);var h=_equalArrays(n(t),n(e),r,s,i,o);return o.delete(t),h;case symbolTag:if(symbolValueOf)return symbolValueOf.call(t)==symbolValueOf.call(e)}return!1}var _equalByTag=equalByTag;function arrayPush(t,e){for(var a=-1,r=e.length,s=t.length;++a<r;)t[s+a]=e[a];return t}var _arrayPush=arrayPush,isArray=Array.isArray,isArray_1=isArray;function baseGetAllKeys(t,e,a){var r=e(t);return isArray_1(t)?r:_arrayPush(r,a(t))}var _baseGetAllKeys=baseGetAllKeys;function arrayFilter(t,e){for(var a=-1,r=null==t?0:t.length,s=0,i=[];++a<r;){var o=t[a];e(o,a,t)&&(i[s++]=o)}return i}var _arrayFilter=arrayFilter;function stubArray(){return[]}var stubArray_1=stubArray,objectProto$5=Object.prototype,propertyIsEnumerable=objectProto$5.propertyIsEnumerable,nativeGetSymbols=Object.getOwnPropertySymbols,getSymbols=nativeGetSymbols?function(t){return null==t?[]:(t=Object(t),_arrayFilter(nativeGetSymbols(t),function(e){return propertyIsEnumerable.call(t,e)}))}:stubArray_1,_getSymbols=getSymbols;function baseTimes(t,e){for(var a=-1,r=Array(t);++a<t;)r[a]=e(a);return r}var _baseTimes=baseTimes;function isObjectLike(t){return null!=t&&"object"==typeof t}var isObjectLike_1=isObjectLike,argsTag="[object Arguments]";function baseIsArguments(t){return isObjectLike_1(t)&&_baseGetTag(t)==argsTag}var _baseIsArguments=baseIsArguments,objectProto$6=Object.prototype,hasOwnProperty$4=objectProto$6.hasOwnProperty,propertyIsEnumerable$1=objectProto$6.propertyIsEnumerable,isArguments=_baseIsArguments(function(){return arguments}())?_baseIsArguments:function(t){return isObjectLike_1(t)&&hasOwnProperty$4.call(t,"callee")&&!propertyIsEnumerable$1.call(t,"callee")},isArguments_1=isArguments;function stubFalse(){return!1}var stubFalse_1=stubFalse,isBuffer_1=createCommonjsModule(function(t,e){var a=e&&!e.nodeType&&e,r=a&&t&&!t.nodeType&&t,s=r&&r.exports===a?_root.Buffer:void 0,i=(s?s.isBuffer:void 0)||stubFalse_1;t.exports=i}),MAX_SAFE_INTEGER=9007199254740991,reIsUint=/^(?:0|[1-9]\d*)$/;function isIndex(t,e){var a=typeof t;return!!(e=null==e?MAX_SAFE_INTEGER:e)&&("number"==a||"symbol"!=a&&reIsUint.test(t))&&t>-1&&t%1==0&&t<e}var _isIndex=isIndex,MAX_SAFE_INTEGER$1=9007199254740991;function isLength(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=MAX_SAFE_INTEGER$1}var isLength_1=isLength,argsTag$1="[object Arguments]",arrayTag="[object Array]",boolTag$1="[object Boolean]",dateTag$1="[object Date]",errorTag$1="[object Error]",funcTag$1="[object Function]",mapTag$1="[object Map]",numberTag$1="[object Number]",objectTag="[object Object]",regexpTag$1="[object RegExp]",setTag$1="[object Set]",stringTag$1="[object String]",weakMapTag="[object WeakMap]",arrayBufferTag$1="[object ArrayBuffer]",dataViewTag$1="[object DataView]",float32Tag="[object Float32Array]",float64Tag="[object Float64Array]",int8Tag="[object Int8Array]",int16Tag="[object Int16Array]",int32Tag="[object Int32Array]",uint8Tag="[object Uint8Array]",uint8ClampedTag="[object Uint8ClampedArray]",uint16Tag="[object Uint16Array]",uint32Tag="[object Uint32Array]",typedArrayTags={};function baseIsTypedArray(t){return isObjectLike_1(t)&&isLength_1(t.length)&&!!typedArrayTags[_baseGetTag(t)]}typedArrayTags[float32Tag]=typedArrayTags[float64Tag]=typedArrayTags[int8Tag]=typedArrayTags[int16Tag]=typedArrayTags[int32Tag]=typedArrayTags[uint8Tag]=typedArrayTags[uint8ClampedTag]=typedArrayTags[uint16Tag]=typedArrayTags[uint32Tag]=!0,typedArrayTags[argsTag$1]=typedArrayTags[arrayTag]=typedArrayTags[arrayBufferTag$1]=typedArrayTags[boolTag$1]=typedArrayTags[dataViewTag$1]=typedArrayTags[dateTag$1]=typedArrayTags[errorTag$1]=typedArrayTags[funcTag$1]=typedArrayTags[mapTag$1]=typedArrayTags[numberTag$1]=typedArrayTags[objectTag]=typedArrayTags[regexpTag$1]=typedArrayTags[setTag$1]=typedArrayTags[stringTag$1]=typedArrayTags[weakMapTag]=!1;var _baseIsTypedArray=baseIsTypedArray;function baseUnary(t){return function(e){return t(e)}}var _baseUnary=baseUnary,_nodeUtil=createCommonjsModule(function(t,e){var a=e&&!e.nodeType&&e,r=a&&t&&!t.nodeType&&t,s=r&&r.exports===a&&_freeGlobal.process,i=function(){try{return s&&s.binding&&s.binding("util")}catch(t){}}();t.exports=i}),nodeIsTypedArray=_nodeUtil&&_nodeUtil.isTypedArray,isTypedArray=nodeIsTypedArray?_baseUnary(nodeIsTypedArray):_baseIsTypedArray,isTypedArray_1=isTypedArray,objectProto$7=Object.prototype,hasOwnProperty$5=objectProto$7.hasOwnProperty;function arrayLikeKeys(t,e){var a=isArray_1(t),r=!a&&isArguments_1(t),s=!a&&!r&&isBuffer_1(t),i=!a&&!r&&!s&&isTypedArray_1(t),o=a||r||s||i,n=o?_baseTimes(t.length,String):[],l=n.length;for(var c in t)!e&&!hasOwnProperty$5.call(t,c)||o&&("length"==c||s&&("offset"==c||"parent"==c)||i&&("buffer"==c||"byteLength"==c||"byteOffset"==c)||_isIndex(c,l))||n.push(c);return n}var _arrayLikeKeys=arrayLikeKeys,objectProto$8=Object.prototype;function isPrototype(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||objectProto$8)}var _isPrototype=isPrototype;function overArg(t,e){return function(a){return t(e(a))}}var _overArg=overArg,nativeKeys=_overArg(Object.keys,Object),_nativeKeys=nativeKeys,objectProto$9=Object.prototype,hasOwnProperty$6=objectProto$9.hasOwnProperty;function baseKeys(t){if(!_isPrototype(t))return _nativeKeys(t);var e=[];for(var a in Object(t))hasOwnProperty$6.call(t,a)&&"constructor"!=a&&e.push(a);return e}var _baseKeys=baseKeys;function isArrayLike(t){return null!=t&&isLength_1(t.length)&&!isFunction_1(t)}var isArrayLike_1=isArrayLike;function keys(t){return isArrayLike_1(t)?_arrayLikeKeys(t):_baseKeys(t)}var keys_1=keys;function getAllKeys(t){return _baseGetAllKeys(t,keys_1,_getSymbols)}var _getAllKeys=getAllKeys,COMPARE_PARTIAL_FLAG$2=1,objectProto$10=Object.prototype,hasOwnProperty$7=objectProto$10.hasOwnProperty;function equalObjects(t,e,a,r,s,i){var o=a&COMPARE_PARTIAL_FLAG$2,n=_getAllKeys(t),l=n.length;if(l!=_getAllKeys(e).length&&!o)return!1;for(var c=l;c--;){var h=n[c];if(!(o?h in e:hasOwnProperty$7.call(e,h)))return!1}var p=i.get(t);if(p&&i.get(e))return p==e;var u=!0;i.set(t,e),i.set(e,t);for(var y=o;++c<l;){var g=t[h=n[c]],_=e[h];if(r)var d=o?r(_,g,h,e,t,i):r(g,_,h,t,e,i);if(!(void 0===d?g===_||s(g,_,a,r,i):d)){u=!1;break}y||(y="constructor"==h)}if(u&&!y){var f=t.constructor,b=e.constructor;f!=b&&"constructor"in t&&"constructor"in e&&!("function"==typeof f&&f instanceof f&&"function"==typeof b&&b instanceof b)&&(u=!1)}return i.delete(t),i.delete(e),u}var _equalObjects=equalObjects,DataView=_getNative(_root,"DataView"),_DataView=DataView,Promise=_getNative(_root,"Promise"),_Promise=Promise,Set=_getNative(_root,"Set"),_Set=Set,WeakMap=_getNative(_root,"WeakMap"),_WeakMap=WeakMap,mapTag$2="[object Map]",objectTag$1="[object Object]",promiseTag="[object Promise]",setTag$2="[object Set]",weakMapTag$1="[object WeakMap]",dataViewTag$2="[object DataView]",dataViewCtorString=_toSource(_DataView),mapCtorString=_toSource(_Map),promiseCtorString=_toSource(_Promise),setCtorString=_toSource(_Set),weakMapCtorString=_toSource(_WeakMap),getTag=_baseGetTag;(_DataView&&getTag(new _DataView(new ArrayBuffer(1)))!=dataViewTag$2||_Map&&getTag(new _Map)!=mapTag$2||_Promise&&getTag(_Promise.resolve())!=promiseTag||_Set&&getTag(new _Set)!=setTag$2||_WeakMap&&getTag(new _WeakMap)!=weakMapTag$1)&&(getTag=function(t){var e=_baseGetTag(t),a=e==objectTag$1?t.constructor:void 0,r=a?_toSource(a):"";if(r)switch(r){case dataViewCtorString:return dataViewTag$2;case mapCtorString:return mapTag$2;case promiseCtorString:return promiseTag;case setCtorString:return setTag$2;case weakMapCtorString:return weakMapTag$1}return e});var _getTag=getTag,COMPARE_PARTIAL_FLAG$3=1,argsTag$2="[object Arguments]",arrayTag$1="[object Array]",objectTag$2="[object Object]",objectProto$11=Object.prototype,hasOwnProperty$8=objectProto$11.hasOwnProperty;function baseIsEqualDeep(t,e,a,r,s,i){var o=isArray_1(t),n=isArray_1(e),l=o?arrayTag$1:_getTag(t),c=n?arrayTag$1:_getTag(e),h=(l=l==argsTag$2?objectTag$2:l)==objectTag$2,p=(c=c==argsTag$2?objectTag$2:c)==objectTag$2,u=l==c;if(u&&isBuffer_1(t)){if(!isBuffer_1(e))return!1;o=!0,h=!1}if(u&&!h)return i||(i=new _Stack),o||isTypedArray_1(t)?_equalArrays(t,e,a,r,s,i):_equalByTag(t,e,l,a,r,s,i);if(!(a&COMPARE_PARTIAL_FLAG$3)){var y=h&&hasOwnProperty$8.call(t,"__wrapped__"),g=p&&hasOwnProperty$8.call(e,"__wrapped__");if(y||g){var _=y?t.value():t,d=g?e.value():e;return i||(i=new _Stack),s(_,d,a,r,i)}}return!!u&&(i||(i=new _Stack),_equalObjects(t,e,a,r,s,i))}var _baseIsEqualDeep=baseIsEqualDeep;function baseIsEqual(t,e,a,r,s){return t===e||(null==t||null==e||!isObjectLike_1(t)&&!isObjectLike_1(e)?t!=t&&e!=e:_baseIsEqualDeep(t,e,a,r,baseIsEqual,s))}var _baseIsEqual=baseIsEqual;function isEqual(t,e){return _baseIsEqual(t,e)}var isEqual_1=isEqual;const TILE_SIZE=50;class Tilemap extends regexpEvents.Emitter{constructor(t){super(),this.game=t,this.size={width:0,height:0},this.bodies=[],this.spawnAreas=[],this.loadedJSON={}}clearBodies(){return this.bodies.forEach(t=>this.game.world.removeBody(t)),this.bodies=[],this.emit("collisions-cleared"),this}toJSON(){return this.loadedJSON}fromJSON(t){return this.clearBodies(),this.loadedJSON=t,this.size.width=t.size.width,this.size.height=t.size.height,this.bodies=Tilemap.buildCollisions(t.collisions),this.bodies.forEach(t=>{t.shapes.forEach(t=>{t.collisionGroup=COLLISION_GROUPS.WALLS,t.collisionMask=COLLISION_GROUPS.ALL})}),this.bodies.forEach(t=>this.game.world.addBody(t)),this.emit("from-json",t),this}getSpawnPoint(){return{x:this.size.width/2*TILE_SIZE,y:this.size.height/2*TILE_SIZE}}static buildCollisions(t){let e=[];for(let a=0;a<t.length;a++){let r=t[a];if(r.visible)if(Array.isArray(r.polygon)){let t=new p2.Body({mass:0});t.position[0]=r.x,t.position[1]=r.y,t.fromPolygon(r.polygon.map(t=>[t.x,t.y])),e.push(t)}else if(Array.isArray(r.polyline)){let t=new p2.Body({mass:0});t.position[0]=r.x,t.position[1]=r.y;for(let e=1;e<r.polyline.length;e++){let a=r.polyline[e-1],s=r.polyline[e],i=Math.sqrt(Math.pow(s.x-a.x,2)+Math.pow(s.y-a.y,2)),o=Math.atan2(s.y-a.y,s.x-a.x);t.addShape(new p2.Line({position:[lerp(a.x,s.x,.5),lerp(a.y,s.y,.5)],length:i,angle:o}))}e.push(t)}else if(r.height>0&&r.width>0){let t=new p2.Body({mass:0});t.position[0]=r.x+r.width/2,t.position[1]=r.y+r.height/2,t.addShape(new p2.Box({width:r.width,height:r.height})),e.push(t)}}return e}static parseTiledJSON(t){let e={size:{width:t.width,height:t.height},types:[],tiles:[]};e.collisions=t.layers.find(t=>t.objects&&"collision"==t.name&&"objectgroup"==t.type).objects;let a={};return t.tilesets.forEach(t=>{for(let e in t.tileproperties){let r=parseInt(e)+t.firstgid;Reflect.ownKeys(t.tileproperties[e]).length>0&&(a[r]||(a[r]={}),Object.assign(a[r],t.tileproperties[e]))}}),t.layers.filter(t=>"tilelayer"===t.type).forEach(r=>{for(let s=0;s<r.data.length;s++){let i=Math.floor(s/t.width),o=s-i*t.width;e.tiles[i]||(e.tiles[i]=[]),e.tiles[i][o]||(e.tiles[i][o]=[]);let n=a[r.data[s]];n&&e.tiles[i][o].push(n)}}),e.tiles=e.tiles.map(t=>t.map(t=>{let a=e.types.find(e=>isEqual_1(t,e));return!a&&t.length>0&&e.types.push(a=t),e.types.indexOf(a)})),e}}const BASE_CONFIG={player:{movement:{speed:180,excelerate:.9,decelerate:.7},max:10}};class Game extends regexpEvents.Emitter{constructor(){super(),this.id=Game.ids.encode(Date.now()),this.info={},this.isMaster=!1,this.config=JSON.parse(JSON.stringify(BASE_CONFIG)),this.players=new PlayerManager(this),this.map=new Tilemap(this),this.bullets=new BulletManager(this),this.world=new p2.World({gravity:[0,0]})}getPlayer(...t){return this.players.getPlayer(...t)}createPlayer(...t){return this.players.createPlayer(...t)}removePlayer(...t){return this.players.removePlayer(...t)}spawnPlayer(t){let e=this.players.getPlayer(t),a=this.map.getSpawnPoint();return e.setPosition(a.x,a.y),e.setProp("spawned",!0),this}setInfo(t,e){if(t instanceof Object){for(let e in t)this.info[e]=t[e];this.emit("info-changed",t)}else this.info[t]=e,this.emit("info-changed",t,e);return this}getInfo(t,e){return this.info[t]}getDelta(){let t=new Date,e=(t-this.lastDelta)/1e3;return this.lastDelta=t,e}update(){let t=this.getDelta();this.world.step(1/60,t,1),this.players.update(t),this.bullets.update(t),this.emit("update",t)}toJSON(){let t={id:this.id,info:this.info,config:this.config,map:this.map.toJSON(),players:this.players.toJSON()};return this.emit("to-json",t),t}fromJSON(t){return this.id=t.id,this.setInfo(t.info),this.players.fromJSON(t.players),this.map.fromJSON(t.map),this.emit("from-json",t),this}get isClient(){return!this.isMaster}}Game.ids=new Hashids("games"),Game.DEFAULT_FPS=1/60,exports.Game=Game,exports.Player=Player,exports.PlayerManager=PlayerManager,exports.Tilemap=Tilemap,exports.Bullet=Bullet,exports.BulletManager=BulletManager;
//# sourceMappingURL=lazer-game-core.min.js.map
