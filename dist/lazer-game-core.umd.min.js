!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.lazerGameCore={})}(this,function(t){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},o=function(){function t(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,i,o){return i&&t(e.prototype,i),o&&t(e,o),e}}(),n=function t(e,o,n){if(i(this,t),"string"!=typeof e)throw new Error("Event.type has to be a string");this.type=e,this.args=o||[],this.target=n};function r(t,e,i){if(i)t.delete(e);else{var o=t.get(e);o.filter(function(t){return!t.isStatic}).forEach(function(t,e){o.splice(o.indexOf(t),1)}),0===o.length&&t.delete(e)}}function s(t,e){return t instanceof RegExp&&e instanceof RegExp&&e.source===t.source&&e.global===t.global&&e.ignoreCase===t.ignoreCase&&e.multiline===t.multiline&&e.sticky===t.sticky&&e.unicode===t.unicode}function a(t){return!0===t||!1===t}function c(t,e,i,o){for(var n=0;n<t.length-i;n++)if(e(t[i+n]))return t[i+n];return o}var h=function(){function t(){i(this,t),this.suppressEvents=!1}return o(t,[{key:"on",value:function(i,o,r,s,h){if(!("string"==typeof i||i instanceof RegExp||i instanceof n))throw new Error("Emitter.on requires a String, Event or RegExp as the first argument");if("function"!=typeof o)throw new Error("Emitter.on requires a function as the second argument");s=c(arguments,a,2,!1),h=c(arguments,function(t){return Number.isFinite(t)||t===1/0},2,1/0),r=c(arguments,function(t){return"object"===(void 0===t?"undefined":e(t))},2,void 0);var l=this.eventMap;return l||(l=t.createEventMap(this)),i instanceof n&&(i=i.type),l.has(i)||l.set(i,[]),l.get(i).push({func:o,ctx:r,times:h,isStatic:s}),this}},{key:"once",value:function(t,e,i,o){return this.on(t,e,1,i,o)}},{key:"off",value:function(t,i,o,r){if(null==t)throw new Error("Emitter.off requires a String or a RegExp as the first argument");if("function"!=typeof i)throw new Error("Emitter.off requires a function as the second argument");r=c(arguments,a,2,!1),o=c(arguments,function(t){return"object"===(void 0===t?"undefined":e(t))},2,void 0),t instanceof n&&(t=t.type);var h=this.eventMap;if(!h)return this;if(h.has(t)||h.set(t,[]),"string"==typeof t){var l=h.get(t);l.forEach(function(t,e){t.func!==i||t.ctx!==o||t.isStatic&&!r||l.splice(e,1)}),0===l.length&&h.delete(t)}else t instanceof RegExp&&h.forEach(function(e,n){n instanceof RegExp&&s(t,n)&&(e.forEach(function(t,n){t.func!==i||t.ctx!==o||t.isStatic&&!r||e.splice(n,1)}),0===e.length&&h.delete(n))});return this}},{key:"emit",value:function(t){var e=this;if(!this.suppressEvents){var i=this.eventMap,o=void 0;if(!i)return this;for(var r=arguments.length,a=Array(r>1?r-1:0),c=1;c<r;c++)a[c-1]=arguments[c];if(t instanceof n)void 0===(o=t).target&&(o.target=this);else{if("string"!=typeof t)throw new Error("Emitter.emit requires a String or Event as the first argument");o=new n(t,a,this)}var h=Array.from(o.args).concat([o]);return i.forEach(function(t,i){("string"==typeof o.type&&i===o.type||"string"==typeof o.type&&i instanceof RegExp&&i.test(o.type)||o.type instanceof RegExp&&i instanceof RegExp&&s(i,o.type))&&t.forEach(function(t){t.func.apply(t.ctx,h),--t.times<=0&&e.off(o.type,t.func,t.ctx,!0)})}),this}}},{key:"clear",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=this.eventMap;return o?("string"==typeof t?r(o,t,e):t instanceof n?r(o,t.type,e):t instanceof RegExp?Array.from(o).map(function(t){return t[0]}).forEach(function(n){("string"==typeof n&&i&&t.test(n)||n instanceof RegExp&&s(n,t))&&r(o,n,e)}):1===arguments.length&&!0===t?o.clear():(!1===t||void 0===t)&&arguments.length<=1&&o.forEach(function(t,e){t.filter(function(t){return!t.isStatic}).forEach(function(e){t.splice(t.indexOf(e),1)}),0===t.length&&o.delete(e)}),this):this}},{key:"count",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=this.eventMap;if(!i)return 0;if("string"==typeof t)return i.has(t)?i.get(t).length:0;if(t instanceof n)return i.has(t.type)?i.get(t.type).length:0;if(t instanceof RegExp){var o=0;return i.forEach(function(i,n){("string"==typeof n&&e&&t.test(n)||n instanceof RegExp&&s(n,t))&&(o+=i.length)}),o}var r=0;return i.forEach(function(t){r+=t.length}),r}},{key:"dispose",value:function(){return t.removeEventMap(this),this}},{key:"eventMap",get:function(){return t.getEventMap(this)}}],[{key:"getEventMap",value:function(t){return(this.events||(this.events=new WeakMap)).get(t)}},{key:"createEventMap",value:function(t){var e=this.events||(this.events=new WeakMap),i=new Map;return e.set(t,i),i}},{key:"removeEventMap",value:function(t){var e=this.events;e&&t&&e.has(t)&&e.delete(t)}}]),t}(),l="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function u(t,e){return t(e={exports:{}},e.exports),e.exports}var p=f;function f(){}f.appendArray=function(t,e){if(e.length<15e4)t.push.apply(t,e);else for(var i=0,o=e.length;i!==o;++i)t.push(e[i])},f.splice=function(t,e,i){i=i||1;for(var o=e,n=t.length-i;o<n;o++)t[o]=t[o+i];t.length=n},"undefined"!=typeof P2_ARRAY_TYPE?f.ARRAY_TYPE=P2_ARRAY_TYPE:"undefined"!=typeof Float32Array?f.ARRAY_TYPE=Float32Array:f.ARRAY_TYPE=Array,f.extend=function(t,e){for(var i in e)t[i]=e[i]},f.defaults=function(t,e){for(var i in t=t||{},e)i in t||(t[i]=e[i]);return t};var d=u(function(t){var e=t.exports={};e.crossLength=function(t,e){return t[0]*e[1]-t[1]*e[0]},e.crossVZ=function(t,i,o){return e.rotate(t,i,-Math.PI/2),e.scale(t,t,o),t},e.crossZV=function(t,i,o){return e.rotate(t,o,Math.PI/2),e.scale(t,t,i),t},e.rotate=function(t,e,i){if(0!==i){var o=Math.cos(i),n=Math.sin(i),r=e[0],s=e[1];t[0]=o*r-n*s,t[1]=n*r+o*s}else t[0]=e[0],t[1]=e[1]},e.rotate90cw=function(t,e){var i=e[0],o=e[1];t[0]=o,t[1]=-i},e.toLocalFrame=function(t,i,o,n){e.copy(t,i),e.sub(t,t,o),e.rotate(t,t,-n)},e.toGlobalFrame=function(t,i,o,n){e.copy(t,i),e.rotate(t,t,n),e.add(t,t,o)},e.vectorToLocalFrame=function(t,i,o){e.rotate(t,i,-o)},e.vectorToGlobalFrame=function(t,i,o){e.rotate(t,i,o)},e.centroid=function(t,i,o,n){return e.add(t,i,o),e.add(t,t,n),e.scale(t,t,1/3),t},e.create=function(){var t=new p.ARRAY_TYPE(2);return t[0]=0,t[1]=0,t},e.clone=function(t){var e=new p.ARRAY_TYPE(2);return e[0]=t[0],e[1]=t[1],e},e.fromValues=function(t,e){var i=new p.ARRAY_TYPE(2);return i[0]=t,i[1]=e,i},e.copy=function(t,e){return t[0]=e[0],t[1]=e[1],t},e.set=function(t,e,i){return t[0]=e,t[1]=i,t},e.add=function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t},e.subtract=function(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t},e.sub=e.subtract,e.multiply=function(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t},e.mul=e.multiply,e.divide=function(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t},e.div=e.divide,e.scale=function(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t},e.distance=function(t,e){var i=e[0]-t[0],o=e[1]-t[1];return Math.sqrt(i*i+o*o)},e.dist=e.distance,e.squaredDistance=function(t,e){var i=e[0]-t[0],o=e[1]-t[1];return i*i+o*o},e.sqrDist=e.squaredDistance,e.length=function(t){var e=t[0],i=t[1];return Math.sqrt(e*e+i*i)},e.len=e.length,e.squaredLength=function(t){var e=t[0],i=t[1];return e*e+i*i},e.sqrLen=e.squaredLength,e.negate=function(t,e){return t[0]=-e[0],t[1]=-e[1],t},e.normalize=function(t,e){var i=e[0],o=e[1],n=i*i+o*o;return n>0&&(n=1/Math.sqrt(n),t[0]=e[0]*n,t[1]=e[1]*n),t},e.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]},e.str=function(t){return"vec2("+t[0]+", "+t[1]+")"},e.lerp=function(t,e,i,o){var n=e[0],r=e[1];return t[0]=n+o*(i[0]-n),t[1]=r+o*(i[1]-r),t},e.reflect=function(t,e,i){var o=e[0]*i[0]+e[1]*i[1];t[0]=e[0]-2*i[0]*o,t[1]=e[1]-2*i[1]*o},e.getLineSegmentsIntersection=function(t,i,o,n,r){var s=e.getLineSegmentsIntersectionFraction(i,o,n,r);return!(s<0)&&(t[0]=i[0]+s*(o[0]-i[0]),t[1]=i[1]+s*(o[1]-i[1]),!0)},e.getLineSegmentsIntersectionFraction=function(t,e,i,o){var n,r,s=e[0]-t[0],a=e[1]-t[1],c=o[0]-i[0],h=o[1]-i[1];return n=(-a*(t[0]-i[0])+s*(t[1]-i[1]))/(-c*a+s*h),r=(c*(t[1]-i[1])-h*(t[0]-i[0]))/(-c*a+s*h),n>=0&&n<=1&&r>=0&&r<=1?r:-1}}),v=y;function y(t){this.lowerBound=d.create(),t&&t.lowerBound&&d.copy(this.lowerBound,t.lowerBound),this.upperBound=d.create(),t&&t.upperBound&&d.copy(this.upperBound,t.upperBound)}var g=d.create();y.prototype.setFromPoints=function(t,e,i,o){var n=this.lowerBound,r=this.upperBound;"number"!=typeof i&&(i=0),0!==i?d.rotate(n,t[0],i):d.copy(n,t[0]),d.copy(r,n);for(var s=Math.cos(i),a=Math.sin(i),c=1;c<t.length;c++){var h=t[c];if(0!==i){var l=h[0],u=h[1];g[0]=s*l-a*u,g[1]=a*l+s*u,h=g}for(var p=0;p<2;p++)h[p]>r[p]&&(r[p]=h[p]),h[p]<n[p]&&(n[p]=h[p])}e&&(d.add(this.lowerBound,this.lowerBound,e),d.add(this.upperBound,this.upperBound,e)),o&&(this.lowerBound[0]-=o,this.lowerBound[1]-=o,this.upperBound[0]+=o,this.upperBound[1]+=o)},y.prototype.copy=function(t){d.copy(this.lowerBound,t.lowerBound),d.copy(this.upperBound,t.upperBound)},y.prototype.extend=function(t){for(var e=2;e--;){var i=t.lowerBound[e];this.lowerBound[e]>i&&(this.lowerBound[e]=i);var o=t.upperBound[e];this.upperBound[e]<o&&(this.upperBound[e]=o)}},y.prototype.overlaps=function(t){var e=this.lowerBound,i=this.upperBound,o=t.lowerBound,n=t.upperBound;return(o[0]<=i[0]&&i[0]<=n[0]||e[0]<=n[0]&&n[0]<=i[0])&&(o[1]<=i[1]&&i[1]<=n[1]||e[1]<=n[1]&&n[1]<=i[1])},y.prototype.containsPoint=function(t){var e=this.lowerBound,i=this.upperBound;return e[0]<=t[0]&&t[0]<=i[0]&&e[1]<=t[1]&&t[1]<=i[1]},y.prototype.overlapsRay=function(t){var e=1/t.direction[0],i=1/t.direction[1],o=(this.lowerBound[0]-t.from[0])*e,n=(this.upperBound[0]-t.from[0])*e,r=(this.lowerBound[1]-t.from[1])*i,s=(this.upperBound[1]-t.from[1])*i,a=Math.max(Math.max(Math.min(o,n),Math.min(r,s))),c=Math.min(Math.min(Math.max(o,n),Math.max(r,s)));return c<0?-1:a>c?-1:a};var m=b;function b(){}b.eq=function(t,e,i){return i=i||0,Math.abs(t-e)<i};var A=E;function E(){}E.lineInt=function(t,e,i){i=i||0;var o,n,r,s,a,c,h,l=[0,0];return o=t[1][1]-t[0][1],n=t[0][0]-t[1][0],r=o*t[0][0]+n*t[0][1],s=e[1][1]-e[0][1],a=e[0][0]-e[1][0],c=s*e[0][0]+a*e[0][1],h=o*a-s*n,m.eq(h,0,i)||(l[0]=(a*r-n*c)/h,l[1]=(o*c-s*r)/h),l},E.segmentsIntersect=function(t,e,i,o){var n=e[0]-t[0],r=e[1]-t[1],s=o[0]-i[0],a=o[1]-i[1];if(s*r-a*n==0)return!1;var c=(n*(i[1]-t[1])+r*(t[0]-i[0]))/(s*r-a*n),h=(s*(t[1]-i[1])+a*(i[0]-t[0]))/(a*n-s*r);return c>=0&&c<=1&&h>=0&&h<=1};var w=B;function B(){}B.area=function(t,e,i){return(e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1])},B.left=function(t,e,i){return B.area(t,e,i)>0},B.leftOn=function(t,e,i){return B.area(t,e,i)>=0},B.right=function(t,e,i){return B.area(t,e,i)<0},B.rightOn=function(t,e,i){return B.area(t,e,i)<=0};var P=[],S=[];B.collinear=function(t,e,i,o){if(o){var n=P,r=S;n[0]=e[0]-t[0],n[1]=e[1]-t[1],r[0]=i[0]-e[0],r[1]=i[1]-e[1];var s=n[0]*r[0]+n[1]*r[1],a=Math.sqrt(n[0]*n[0]+n[1]*n[1]),c=Math.sqrt(r[0]*r[0]+r[1]*r[1]);return Math.acos(s/(a*c))<o}return 0==B.area(t,e,i)},B.sqdist=function(t,e){var i=e[0]-t[0],o=e[1]-t[1];return i*i+o*o};var L=q;function q(){this.vertices=[]}q.prototype.at=function(t){var e=this.vertices,i=e.length;return e[t<0?t%i+i:t%i]},q.prototype.first=function(){return this.vertices[0]},q.prototype.last=function(){return this.vertices[this.vertices.length-1]},q.prototype.clear=function(){this.vertices.length=0},q.prototype.append=function(t,e,i){if(void 0===e)throw new Error("From is not given!");if(void 0===i)throw new Error("To is not given!");if(i-1<e)throw new Error("lol1");if(i>t.vertices.length)throw new Error("lol2");if(e<0)throw new Error("lol3");for(var o=e;o<i;o++)this.vertices.push(t.vertices[o])},q.prototype.makeCCW=function(){for(var t=0,e=this.vertices,i=1;i<this.vertices.length;++i)(e[i][1]<e[t][1]||e[i][1]==e[t][1]&&e[i][0]>e[t][0])&&(t=i);w.left(this.at(t-1),this.at(t),this.at(t+1))||this.reverse()},q.prototype.reverse=function(){for(var t=[],e=0,i=this.vertices.length;e!==i;e++)t.push(this.vertices.pop());this.vertices=t},q.prototype.isReflex=function(t){return w.right(this.at(t-1),this.at(t),this.at(t+1))};var M=[],x=[];function C(t,e,i,o,n){n=n||0;var r=e[1]-t[1],s=t[0]-e[0],a=r*t[0]+s*t[1],c=o[1]-i[1],h=i[0]-o[0],l=c*i[0]+h*i[1],u=r*h-c*s;return m.eq(u,0,n)?[0,0]:[(h*a-s*l)/u,(r*l-c*a)/u]}q.prototype.canSee=function(t,e){var i,o,n=M,r=x;if(w.leftOn(this.at(t+1),this.at(t),this.at(e))&&w.rightOn(this.at(t-1),this.at(t),this.at(e)))return!1;o=w.sqdist(this.at(t),this.at(e));for(var s=0;s!==this.vertices.length;++s)if((s+1)%this.vertices.length!==t&&s!==t&&w.leftOn(this.at(t),this.at(e),this.at(s+1))&&w.rightOn(this.at(t),this.at(e),this.at(s))&&(n[0]=this.at(t),n[1]=this.at(e),r[0]=this.at(s),r[1]=this.at(s+1),i=A.lineInt(n,r),w.sqdist(this.at(t),i)<o))return!1;return!0},q.prototype.copy=function(t,e,i){var o=i||new q;if(o.clear(),t<e)for(var n=t;n<=e;n++)o.vertices.push(this.vertices[n]);else{for(n=0;n<=e;n++)o.vertices.push(this.vertices[n]);for(n=t;n<this.vertices.length;n++)o.vertices.push(this.vertices[n])}return o},q.prototype.getCutEdges=function(){for(var t=[],e=[],i=[],o=new q,n=Number.MAX_VALUE,r=0;r<this.vertices.length;++r)if(this.isReflex(r))for(var s=0;s<this.vertices.length;++s)if(this.canSee(r,s)){e=this.copy(r,s,o).getCutEdges(),i=this.copy(s,r,o).getCutEdges();for(var a=0;a<i.length;a++)e.push(i[a]);e.length<n&&(t=e,n=e.length,t.push([this.at(r),this.at(s)]))}return t},q.prototype.decomp=function(){var t=this.getCutEdges();return t.length>0?this.slice(t):[this]},q.prototype.slice=function(t){if(0==t.length)return[this];if(t instanceof Array&&t.length&&t[0]instanceof Array&&2==t[0].length&&t[0][0]instanceof Array){for(var e=[this],i=0;i<t.length;i++)for(var o=t[i],n=0;n<e.length;n++){var r=e[n].slice(o);if(r){e.splice(n,1),e.push(r[0],r[1]);break}}return e}o=t,i=this.vertices.indexOf(o[0]),n=this.vertices.indexOf(o[1]);return-1!=i&&-1!=n&&[this.copy(i,n),this.copy(n,i)]},q.prototype.isSimple=function(){for(var t=this.vertices,e=0;e<t.length-1;e++)for(var i=0;i<e-1;i++)if(A.segmentsIntersect(t[e],t[e+1],t[i],t[i+1]))return!1;for(e=1;e<t.length-2;e++)if(A.segmentsIntersect(t[0],t[t.length-1],t[e],t[e+1]))return!1;return!0},q.prototype.quickDecomp=function(t,e,i,o,n,r){n=n||100,r=r||0,o=o||25,t=void 0!==t?t:[],e=e||[],i=i||[];var s=[0,0],a=[0,0],c=[0,0],h=0,l=0,u=0,p=0,f=0,d=0,v=0,y=new q,g=new q,m=this.vertices;if(m.length<3)return t;if(++r>n)return console.warn("quickDecomp: max level ("+n+") reached."),t;for(var b=0;b<this.vertices.length;++b)if(this.isReflex(b)){e.push(this.vertices[b]),h=l=Number.MAX_VALUE;for(var A=0;A<this.vertices.length;++A)w.left(this.at(b-1),this.at(b),this.at(A))&&w.rightOn(this.at(b-1),this.at(b),this.at(A-1))&&(c=C(this.at(b-1),this.at(b),this.at(A),this.at(A-1)),w.right(this.at(b+1),this.at(b),c)&&(u=w.sqdist(this.vertices[b],c))<l&&(l=u,a=c,d=A)),w.left(this.at(b+1),this.at(b),this.at(A+1))&&w.rightOn(this.at(b+1),this.at(b),this.at(A))&&(c=C(this.at(b+1),this.at(b),this.at(A),this.at(A+1)),w.left(this.at(b-1),this.at(b),c)&&(u=w.sqdist(this.vertices[b],c))<h&&(h=u,s=c,f=A));if(d==(f+1)%this.vertices.length)c[0]=(a[0]+s[0])/2,c[1]=(a[1]+s[1])/2,i.push(c),b<f?(y.append(this,b,f+1),y.vertices.push(c),g.vertices.push(c),0!=d&&g.append(this,d,this.vertices.length),g.append(this,0,b+1)):(0!=b&&y.append(this,b,this.vertices.length),y.append(this,0,f+1),y.vertices.push(c),g.vertices.push(c),g.append(this,d,b+1));else{if(d>f&&(f+=this.vertices.length),p=Number.MAX_VALUE,f<d)return t;for(A=d;A<=f;++A)w.leftOn(this.at(b-1),this.at(b),this.at(A))&&w.rightOn(this.at(b+1),this.at(b),this.at(A))&&(u=w.sqdist(this.at(b),this.at(A)))<p&&(p=u,v=A%this.vertices.length);b<v?(y.append(this,b,v+1),0!=v&&g.append(this,v,m.length),g.append(this,0,b+1)):(0!=b&&y.append(this,b,m.length),y.append(this,0,v+1),g.append(this,v,b+1))}return y.vertices.length<g.vertices.length?(y.quickDecomp(t,e,i,o,n,r),g.quickDecomp(t,e,i,o,n,r)):(g.quickDecomp(t,e,i,o,n,r),y.quickDecomp(t,e,i,o,n,r)),t}return t.push(this),t},q.prototype.removeCollinearPoints=function(t){for(var e=0,i=this.vertices.length-1;this.vertices.length>3&&i>=0;--i)w.collinear(this.at(i-1),this.at(i),this.at(i+1),t)&&(this.vertices.splice(i%this.vertices.length,1),i--,e++);return e};var _={Polygon:L,Point:w},F=O;function O(t){t=t||{},this.body=null,this.position=d.fromValues(0,0),t.position&&d.copy(this.position,t.position),this.angle=t.angle||0,this.type=t.type||0,this.id=O.idCounter++,this.boundingRadius=0,this.collisionGroup=void 0!==t.collisionGroup?t.collisionGroup:1,this.collisionResponse=void 0===t.collisionResponse||t.collisionResponse,this.collisionMask=void 0!==t.collisionMask?t.collisionMask:1,this.material=t.material||null,this.area=0,this.sensor=void 0!==t.sensor&&t.sensor,this.type&&this.updateBoundingRadius(),this.updateArea()}O.idCounter=0,O.CIRCLE=1,O.PARTICLE=2,O.PLANE=4,O.CONVEX=8,O.LINE=16,O.BOX=32,Object.defineProperty(O,"RECTANGLE",{get:function(){return console.warn("Shape.RECTANGLE is deprecated, use Shape.BOX instead."),O.BOX}}),O.CAPSULE=64,O.HEIGHTFIELD=128,O.prototype.computeMomentOfInertia=function(t){},O.prototype.updateBoundingRadius=function(){},O.prototype.updateArea=function(){},O.prototype.computeAABB=function(t,e,i){},O.prototype.raycast=function(t,e,i,o){};var I={GetArea:function(t){if(t.length<6)return 0;for(var e=t.length-2,i=0,o=0;o<e;o+=2)i+=(t[o+2]-t[o])*(t[o+1]+t[o+3]);return.5*-(i+=(t[0]-t[e])*(t[e+1]+t[1]))},Triangulate:function(t){var e=t.length>>1;if(e<3)return[];for(var i=[],o=[],n=0;n<e;n++)o.push(n);n=0;for(var r=e;r>3;){var s=o[(n+0)%r],a=o[(n+1)%r],c=o[(n+2)%r],h=t[2*s],l=t[2*s+1],u=t[2*a],p=t[2*a+1],f=t[2*c],d=t[2*c+1],v=!1;if(I._convex(h,l,u,p,f,d)){v=!0;for(var y=0;y<r;y++){var g=o[y];if(g!=s&&g!=a&&g!=c&&I._PointInTriangle(t[2*g],t[2*g+1],h,l,u,p,f,d)){v=!1;break}}}if(v)i.push(s,a,c),o.splice((n+1)%r,1),r--,n=0;else if(n++>3*r)break}return i.push(o[0],o[1],o[2]),i},_PointInTriangle:function(t,e,i,o,n,r,s,a){var c=s-i,h=a-o,l=n-i,u=r-o,p=t-i,f=e-o,d=c*c+h*h,v=c*l+h*u,y=c*p+h*f,g=l*l+u*u,m=l*p+u*f,b=1/(d*g-v*v),A=(g*y-v*m)*b,E=(d*m-v*y)*b;return A>=0&&E>=0&&A+E<1},_convex:function(t,e,i,o,n,r){return(e-o)*(n-i)+(i-t)*(r-o)>=0}},k=I,R=V;function V(t){Array.isArray(arguments[0])&&(t={vertices:arguments[0],axes:arguments[1]},console.warn("The Convex constructor signature has changed. Please use the following format: new Convex({ vertices: [...], ... })")),t=t||{},this.vertices=[];for(var e=void 0!==t.vertices?t.vertices:[],i=0;i<e.length;i++){var o=d.create();d.copy(o,e[i]),this.vertices.push(o)}if(this.axes=[],t.axes)for(i=0;i<t.axes.length;i++){var n=d.create();d.copy(n,t.axes[i]),this.axes.push(n)}else for(i=0;i<this.vertices.length;i++){var r=this.vertices[i],s=this.vertices[(i+1)%this.vertices.length],a=d.create();d.sub(a,s,r),d.rotate90cw(a,a),d.normalize(a,a),this.axes.push(a)}if(this.centerOfMass=d.fromValues(0,0),this.triangles=[],this.vertices.length&&(this.updateTriangles(),this.updateCenterOfMass()),this.boundingRadius=0,t.type=F.CONVEX,F.call(this,t),this.updateBoundingRadius(),this.updateArea(),this.area<0)throw new Error("Convex vertices must be given in conter-clockwise winding.")}V.prototype=new F,V.prototype.constructor=V;var T=d.create(),N=d.create();V.prototype.projectOntoLocalAxis=function(t,e){for(var i,o,n=null,r=null,s=(t=T,0);s<this.vertices.length;s++)i=this.vertices[s],o=d.dot(i,t),(null===n||o>n)&&(n=o),(null===r||o<r)&&(r=o);if(r>n){var a=r;r=n,n=a}d.set(e,r,n)},V.prototype.projectOntoWorldAxis=function(t,e,i,o){var n=N;this.projectOntoLocalAxis(t,o),0!==i?d.rotate(n,t,i):n=t;var r=d.dot(e,n);d.set(o,o[0]+r,o[1]+r)},V.prototype.updateTriangles=function(){this.triangles.length=0;for(var t=[],e=0;e<this.vertices.length;e++){var i=this.vertices[e];t.push(i[0],i[1])}var o=k.Triangulate(t);for(e=0;e<o.length;e+=3){var n=o[e],r=o[e+1],s=o[e+2];this.triangles.push([n,r,s])}};var j=d.create(),G=d.create(),D=d.create(),U=d.create(),z=d.create();d.create(),d.create(),d.create(),d.create();V.prototype.updateCenterOfMass=function(){var t=this.triangles,e=this.vertices,i=this.centerOfMass,o=j,n=D,r=U,s=z,a=G;d.set(i,0,0);for(var c=0,h=0;h!==t.length;h++){var l=t[h];n=e[l[0]],r=e[l[1]],s=e[l[2]];d.centroid(o,n,r,s);var u=V.triangleArea(n,r,s);c+=u,d.scale(a,o,u),d.add(i,i,a)}d.scale(i,i,1/c)},V.prototype.computeMomentOfInertia=function(t){for(var e=0,i=0,o=this.vertices.length,n=o-1,r=0;r<o;n=r,r++){var s=this.vertices[n],a=this.vertices[r],c=Math.abs(d.crossLength(s,a));e+=c*(d.dot(a,a)+d.dot(a,s)+d.dot(s,s)),i+=c}return t/6*(e/i)},V.prototype.updateBoundingRadius=function(){for(var t=this.vertices,e=0,i=0;i!==t.length;i++){var o=d.squaredLength(t[i]);o>e&&(e=o)}this.boundingRadius=Math.sqrt(e)},V.triangleArea=function(t,e,i){return.5*((e[0]-t[0])*(i[1]-t[1])-(i[0]-t[0])*(e[1]-t[1]))},V.prototype.updateArea=function(){this.updateTriangles(),this.area=0;for(var t=this.triangles,e=this.vertices,i=0;i!==t.length;i++){var o=t[i],n=e[o[0]],r=e[o[1]],s=e[o[2]],a=V.triangleArea(n,r,s);this.area+=a}},V.prototype.computeAABB=function(t,e,i){t.setFromPoints(this.vertices,e,i,0)};var W=d.create(),X=d.create(),Y=d.create();V.prototype.raycast=function(t,e,i,o){var n=W,r=X,s=Y,a=this.vertices;d.toLocalFrame(n,e.from,i,o),d.toLocalFrame(r,e.to,i,o);for(var c=a.length,h=0;h<c&&!t.shouldStop(e);h++){var l=a[h],u=a[(h+1)%c],p=d.getLineSegmentsIntersectionFraction(n,r,l,u);p>=0&&(d.sub(s,u,l),d.rotate(s,s,-Math.PI/2+o),d.normalize(s,s),e.reportIntersection(t,p,s,h))}};var H=J;function J(t){t=t||{},this.from=t.from?d.fromValues(t.from[0],t.from[1]):d.create(),this.to=t.to?d.fromValues(t.to[0],t.to[1]):d.create(),this.checkCollisionResponse=void 0===t.checkCollisionResponse||t.checkCollisionResponse,this.skipBackfaces=!!t.skipBackfaces,this.collisionMask=void 0!==t.collisionMask?t.collisionMask:-1,this.collisionGroup=void 0!==t.collisionGroup?t.collisionGroup:-1,this.mode=void 0!==t.mode?t.mode:J.ANY,this.callback=t.callback||function(t){},this.direction=d.create(),this.length=1,this.update()}J.prototype.constructor=J,J.CLOSEST=1,J.ANY=2,J.ALL=4,J.prototype.update=function(){var t=this.direction;d.sub(t,this.to,this.from),this.length=d.length(t),d.normalize(t,t)},J.prototype.intersectBodies=function(t,e){for(var i=0,o=e.length;!t.shouldStop(this)&&i<o;i++){var n=e[i],r=n.getAABB();(r.overlapsRay(this)>=0||r.containsPoint(this.from))&&this.intersectBody(t,n)}};var K=d.create();J.prototype.intersectBody=function(t,e){var i=this.checkCollisionResponse;if(!i||e.collisionResponse)for(var o=K,n=0,r=e.shapes.length;n<r;n++){var s=e.shapes[n];if((!i||s.collisionResponse)&&(0!=(this.collisionGroup&s.collisionMask)&&0!=(s.collisionGroup&this.collisionMask))){d.rotate(o,s.position,e.angle),d.add(o,o,e.position);var a=s.angle+e.angle;if(this.intersectShape(t,s,a,o,e),t.shouldStop(this))break}}},J.prototype.intersectShape=function(t,e,i,o,n){(function(t,e,i){d.sub(Z,i,t);var o=d.dot(Z,e);return d.scale($,e,o),d.add($,$,t),d.squaredDistance(i,$)})(this.from,this.direction,o)>e.boundingRadius*e.boundingRadius||(this._currentBody=n,this._currentShape=e,e.raycast(t,this,o,i),this._currentBody=this._currentShape=null)},J.prototype.getAABB=function(t){var e=this.to,i=this.from;d.set(t.lowerBound,Math.min(e[0],i[0]),Math.min(e[1],i[1])),d.set(t.upperBound,Math.max(e[0],i[0]),Math.max(e[1],i[1]))};d.create();J.prototype.reportIntersection=function(t,e,i,o){this.from,this.to;var n=this._currentShape,r=this._currentBody;if(!(this.skipBackfaces&&d.dot(i,this.direction)>0))switch(this.mode){case J.ALL:t.set(i,n,r,e,o),this.callback(t);break;case J.CLOSEST:(e<t.fraction||!t.hasHit())&&t.set(i,n,r,e,o);break;case J.ANY:t.set(i,n,r,e,o)}};var Z=d.create(),$=d.create();var Q=tt;function tt(){this.normal=d.create(),this.shape=null,this.body=null,this.faceIndex=-1,this.fraction=-1,this.isStopped=!1}tt.prototype.reset=function(){d.set(this.normal,0,0),this.shape=null,this.body=null,this.faceIndex=-1,this.fraction=-1,this.isStopped=!1},tt.prototype.getHitDistance=function(t){return d.distance(t.from,t.to)*this.fraction},tt.prototype.hasHit=function(){return-1!==this.fraction},tt.prototype.getHitPoint=function(t,e){d.lerp(t,e.from,e.to,this.fraction)},tt.prototype.stop=function(){this.isStopped=!0},tt.prototype.shouldStop=function(t){return this.isStopped||-1!==this.fraction&&t.mode===H.ANY},tt.prototype.set=function(t,e,i,o,n){d.copy(this.normal,t),this.shape=e,this.body=i,this.fraction=o,this.faceIndex=n};var et=function(){},it=et;et.prototype={constructor:et,on:function(t,e,i){e.context=i||this,void 0===this._listeners&&(this._listeners={});var o=this._listeners;return void 0===o[t]&&(o[t]=[]),-1===o[t].indexOf(e)&&o[t].push(e),this},has:function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;if(e){if(void 0!==i[t]&&-1!==i[t].indexOf(e))return!0}else if(void 0!==i[t])return!0;return!1},off:function(t,e){if(void 0===this._listeners)return this;var i=this._listeners,o=i[t].indexOf(e);return-1!==o&&i[t].splice(o,1),this},emit:function(t){if(void 0===this._listeners)return this;var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=0,o=e.length;i<o;i++){var n=e[i];n.call(n.context,t)}}return this}};var ot=nt;function nt(t){t=t||{},it.call(this),this.id=t.id||++nt._idCounter,this.world=null,this.shapes=[],this.mass=t.mass||0,this.invMass=0,this.inertia=0,this.invInertia=0,this.invMassSolve=0,this.invInertiaSolve=0,this.fixedRotation=!!t.fixedRotation,this.fixedX=!!t.fixedX,this.fixedY=!!t.fixedY,this.massMultiplier=d.create(),this.position=d.fromValues(0,0),t.position&&d.copy(this.position,t.position),this.interpolatedPosition=d.fromValues(0,0),this.interpolatedAngle=0,this.previousPosition=d.fromValues(0,0),this.previousAngle=0,this.velocity=d.fromValues(0,0),t.velocity&&d.copy(this.velocity,t.velocity),this.vlambda=d.fromValues(0,0),this.wlambda=0,this.angle=t.angle||0,this.angularVelocity=t.angularVelocity||0,this.force=d.create(),t.force&&d.copy(this.force,t.force),this.angularForce=t.angularForce||0,this.damping="number"==typeof t.damping?t.damping:.1,this.angularDamping="number"==typeof t.angularDamping?t.angularDamping:.1,this.type=nt.STATIC,void 0!==t.type?this.type=t.type:t.mass?this.type=nt.DYNAMIC:this.type=nt.STATIC,this.boundingRadius=0,this.aabb=new v,this.aabbNeedsUpdate=!0,this.allowSleep=void 0===t.allowSleep||t.allowSleep,this.wantsToSleep=!1,this.sleepState=nt.AWAKE,this.sleepSpeedLimit=void 0!==t.sleepSpeedLimit?t.sleepSpeedLimit:.2,this.sleepTimeLimit=void 0!==t.sleepTimeLimit?t.sleepTimeLimit:1,this.gravityScale=void 0!==t.gravityScale?t.gravityScale:1,this.collisionResponse=void 0===t.collisionResponse||t.collisionResponse,this.idleTime=0,this.timeLastSleepy=0,this.ccdSpeedThreshold=void 0!==t.ccdSpeedThreshold?t.ccdSpeedThreshold:-1,this.ccdIterations=void 0!==t.ccdIterations?t.ccdIterations:10,this.concavePath=null,this._wakeUpAfterNarrowphase=!1,this.updateMassProperties()}nt.prototype=new it,nt.prototype.constructor=nt,nt._idCounter=0,nt.prototype.updateSolveMassProperties=function(){this.sleepState===nt.SLEEPING||this.type===nt.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve=0):(this.invMassSolve=this.invMass,this.invInertiaSolve=this.invInertia)},nt.prototype.setDensity=function(t){var e=this.getArea();this.mass=e*t,this.updateMassProperties()},nt.prototype.getArea=function(){for(var t=0,e=0;e<this.shapes.length;e++)t+=this.shapes[e].area;return t},nt.prototype.getAABB=function(){return this.aabbNeedsUpdate&&this.updateAABB(),this.aabb};var rt=new v,st=d.create();nt.prototype.updateAABB=function(){for(var t=this.shapes,e=t.length,i=st,o=this.angle,n=0;n!==e;n++){var r=t[n],s=r.angle+o;d.rotate(i,r.position,o),d.add(i,i,this.position),r.computeAABB(rt,i,s),0===n?this.aabb.copy(rt):this.aabb.extend(rt)}this.aabbNeedsUpdate=!1},nt.prototype.updateBoundingRadius=function(){for(var t=this.shapes,e=t.length,i=0,o=0;o!==e;o++){var n=t[o],r=d.length(n.position),s=n.boundingRadius;r+s>i&&(i=r+s)}this.boundingRadius=i},nt.prototype.addShape=function(t,e,i){if(t.body)throw new Error("A shape can only be added to one body.");t.body=this,e?d.copy(t.position,e):d.set(t.position,0,0),t.angle=i||0,this.shapes.push(t),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0},nt.prototype.removeShape=function(t){var e=this.shapes.indexOf(t);return-1!==e&&(this.shapes.splice(e,1),this.aabbNeedsUpdate=!0,t.body=null,!0)},nt.prototype.updateMassProperties=function(){if(this.type===nt.STATIC||this.type===nt.KINEMATIC)this.mass=Number.MAX_VALUE,this.invMass=0,this.inertia=Number.MAX_VALUE,this.invInertia=0;else{var t=this.shapes,e=t.length,i=this.mass/e,o=0;if(this.fixedRotation)this.inertia=Number.MAX_VALUE,this.invInertia=0;else{for(var n=0;n<e;n++){var r=t[n],s=d.squaredLength(r.position);o+=r.computeMomentOfInertia(i)+i*s}this.inertia=o,this.invInertia=o>0?1/o:0}this.invMass=1/this.mass,d.set(this.massMultiplier,this.fixedX?0:1,this.fixedY?0:1)}};d.create();nt.prototype.applyForce=function(t,e){if(d.add(this.force,this.force,t),e){var i=d.crossLength(e,t);this.angularForce+=i}};var at=d.create(),ct=d.create(),ht=d.create();nt.prototype.applyForceLocal=function(t,e){e=e||ht;var i=at,o=ct;this.vectorToWorldFrame(i,t),this.vectorToWorldFrame(o,e),this.applyForce(i,o)};var lt=d.create();nt.prototype.applyImpulse=function(t,e){if(this.type===nt.DYNAMIC){var i=lt;if(d.scale(i,t,this.invMass),d.multiply(i,this.massMultiplier,i),d.add(this.velocity,i,this.velocity),e){var o=d.crossLength(e,t);o*=this.invInertia,this.angularVelocity+=o}}};var ut=d.create(),pt=d.create(),ft=d.create();nt.prototype.applyImpulseLocal=function(t,e){e=e||ft;var i=ut,o=pt;this.vectorToWorldFrame(i,t),this.vectorToWorldFrame(o,e),this.applyImpulse(i,o)},nt.prototype.toLocalFrame=function(t,e){d.toLocalFrame(t,e,this.position,this.angle)},nt.prototype.toWorldFrame=function(t,e){d.toGlobalFrame(t,e,this.position,this.angle)},nt.prototype.vectorToLocalFrame=function(t,e){d.vectorToLocalFrame(t,e,this.angle)},nt.prototype.vectorToWorldFrame=function(t,e){d.vectorToGlobalFrame(t,e,this.angle)},nt.prototype.fromPolygon=function(t,e){e=e||{};for(var i=this.shapes.length;i>=0;--i)this.removeShape(this.shapes[i]);var o,n=new _.Polygon;if(n.vertices=t,n.makeCCW(),"number"==typeof e.removeCollinearPoints&&n.removeCollinearPoints(e.removeCollinearPoints),void 0===e.skipSimpleCheck&&!n.isSimple())return!1;this.concavePath=n.vertices.slice(0);for(i=0;i<this.concavePath.length;i++){var r=[0,0];d.copy(r,this.concavePath[i]),this.concavePath[i]=r}o=e.optimalDecomp?n.decomp():n.quickDecomp();var s=d.create();for(i=0;i!==o.length;i++){for(var a=new R({vertices:o[i].vertices}),c=0;c!==a.vertices.length;c++){r=a.vertices[c];d.sub(r,r,a.centerOfMass)}d.scale(s,a.centerOfMass,1),a.updateTriangles(),a.updateCenterOfMass(),a.updateBoundingRadius(),this.addShape(a,s)}return this.adjustCenterOfMass(),this.aabbNeedsUpdate=!0,!0};d.fromValues(0,0);var dt=d.fromValues(0,0),vt=d.fromValues(0,0),yt=d.fromValues(0,0);nt.prototype.adjustCenterOfMass=function(){var t=dt,e=vt,i=yt,o=0;d.set(e,0,0);for(var n=0;n!==this.shapes.length;n++){var r=this.shapes[n];d.scale(t,r.position,r.area),d.add(e,e,t),o+=r.area}d.scale(i,e,1/o);for(n=0;n!==this.shapes.length;n++){r=this.shapes[n];d.sub(r.position,r.position,i)}d.add(this.position,this.position,i);for(n=0;this.concavePath&&n<this.concavePath.length;n++)d.sub(this.concavePath[n],this.concavePath[n],i);this.updateMassProperties(),this.updateBoundingRadius()},nt.prototype.setZeroForce=function(){d.set(this.force,0,0),this.angularForce=0},nt.prototype.resetConstraintVelocity=function(){var t=this.vlambda;d.set(t,0,0),this.wlambda=0},nt.prototype.addConstraintVelocity=function(){var t=this,e=t.velocity;d.add(e,e,t.vlambda),t.angularVelocity+=t.wlambda},nt.prototype.applyDamping=function(t){if(this.type===nt.DYNAMIC){var e=this.velocity;d.scale(e,e,Math.pow(1-this.damping,t)),this.angularVelocity*=Math.pow(1-this.angularDamping,t)}},nt.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=nt.AWAKE,this.idleTime=0,t!==nt.AWAKE&&this.emit(nt.wakeUpEvent)},nt.prototype.sleep=function(){this.sleepState=nt.SLEEPING,this.angularVelocity=0,this.angularForce=0,d.set(this.velocity,0,0),d.set(this.force,0,0),this.emit(nt.sleepEvent)},nt.prototype.sleepTick=function(t,e,i){if(this.allowSleep&&this.type!==nt.SLEEPING){this.wantsToSleep=!1;this.sleepState;d.squaredLength(this.velocity)+Math.pow(this.angularVelocity,2)>=Math.pow(this.sleepSpeedLimit,2)?(this.idleTime=0,this.sleepState=nt.AWAKE):(this.idleTime+=i,this.sleepState=nt.SLEEPY),this.idleTime>this.sleepTimeLimit&&(e?this.wantsToSleep=!0:this.sleep())}},nt.prototype.overlaps=function(t){return this.world.overlapKeeper.bodiesAreOverlapping(this,t)};var gt=d.create(),mt=d.create();nt.prototype.integrate=function(t){var e=this.invMass,i=this.force,o=this.position,n=this.velocity;d.copy(this.previousPosition,this.position),this.previousAngle=this.angle,this.fixedRotation||(this.angularVelocity+=this.angularForce*this.invInertia*t),d.scale(gt,i,t*e),d.multiply(gt,this.massMultiplier,gt),d.add(n,gt,n),this.integrateToTimeOfImpact(t)||(d.scale(mt,n,t),d.add(o,o,mt),this.fixedRotation||(this.angle+=this.angularVelocity*t)),this.aabbNeedsUpdate=!0};var bt=new Q,At=new H({mode:H.ALL}),Et=d.create(),wt=d.create(),Bt=d.create(),Pt=d.create();nt.prototype.integrateToTimeOfImpact=function(t){if(this.ccdSpeedThreshold<0||d.squaredLength(this.velocity)<Math.pow(this.ccdSpeedThreshold,2))return!1;d.normalize(Et,this.velocity),d.scale(wt,this.velocity,t),d.add(wt,wt,this.position),d.sub(Bt,wt,this.position);var e,i=this.angularVelocity*t,o=d.length(Bt),n=1,r=this;if(bt.reset(),At.callback=function(t){t.body!==r&&(e=t.body,t.getHitPoint(wt,At),d.sub(Bt,wt,r.position),n=d.length(Bt)/o,t.stop())},d.copy(At.from,this.position),d.copy(At.to,wt),At.update(),this.world.raycast(bt,At),!e)return!1;var s=this.angle;d.copy(Pt,this.position);for(var a=0,c=0,h=0,l=n;l>=c&&a<this.ccdIterations;){a++,h=(l-c)/2,d.scale(mt,Bt,n),d.add(this.position,Pt,mt),this.angle=s+i*n,this.updateAABB(),this.aabb.overlaps(e.aabb)&&this.world.narrowphase.bodiesOverlap(this,e)?c=h:l=h}return n=h,d.copy(this.position,Pt),this.angle=s,d.scale(mt,Bt,n),d.add(this.position,this.position,mt),this.fixedRotation||(this.angle+=i*n),!0},nt.prototype.getVelocityAtPoint=function(t,e){return d.crossVZ(t,e,this.angularVelocity),d.subtract(t,this.velocity,t),t},nt.sleepyEvent={type:"sleepy"},nt.sleepEvent={type:"sleep"},nt.wakeUpEvent={type:"wakeup"},nt.DYNAMIC=1,nt.STATIC=2,nt.KINEMATIC=4,nt.AWAKE=0,nt.SLEEPY=1,nt.SLEEPING=2;var St=Lt;function Lt(t,e,i,o){this.minForce=void 0===i?-Number.MAX_VALUE:i,this.maxForce=void 0===o?Number.MAX_VALUE:o,this.bodyA=t,this.bodyB=e,this.stiffness=Lt.DEFAULT_STIFFNESS,this.relaxation=Lt.DEFAULT_RELAXATION,this.G=new p.ARRAY_TYPE(6);for(var n=0;n<6;n++)this.G[n]=0;this.offset=0,this.a=0,this.b=0,this.epsilon=0,this.timeStep=1/60,this.needsUpdate=!0,this.multiplier=0,this.relativeVelocity=0,this.enabled=!0}Lt.prototype.constructor=Lt,Lt.DEFAULT_STIFFNESS=1e6,Lt.DEFAULT_RELAXATION=4,Lt.prototype.update=function(){var t=this.stiffness,e=this.relaxation,i=this.timeStep;this.a=4/(i*(1+4*e)),this.b=4*e/(1+4*e),this.epsilon=4/(i*i*t*(1+4*e)),this.needsUpdate=!1},Lt.prototype.gmult=function(t,e,i,o,n){return t[0]*e[0]+t[1]*e[1]+t[2]*i+t[3]*o[0]+t[4]*o[1]+t[5]*n},Lt.prototype.computeB=function(t,e,i){var o=this.computeGW();return-this.computeGq()*t-o*e-this.computeGiMf()*i};var qt=d.create(),Mt=d.create();Lt.prototype.computeGq=function(){var t=this.G,e=this.bodyA,i=this.bodyB,o=(e.position,i.position,e.angle),n=i.angle;return this.gmult(t,qt,o,Mt,n)+this.offset},Lt.prototype.computeGW=function(){var t=this.G,e=this.bodyA,i=this.bodyB,o=e.velocity,n=i.velocity,r=e.angularVelocity,s=i.angularVelocity;return this.gmult(t,o,r,n,s)+this.relativeVelocity},Lt.prototype.computeGWlambda=function(){var t=this.G,e=this.bodyA,i=this.bodyB,o=e.vlambda,n=i.vlambda,r=e.wlambda,s=i.wlambda;return this.gmult(t,o,r,n,s)};var xt=d.create(),Ct=d.create();Lt.prototype.computeGiMf=function(){var t=this.bodyA,e=this.bodyB,i=t.force,o=t.angularForce,n=e.force,r=e.angularForce,s=t.invMassSolve,a=e.invMassSolve,c=t.invInertiaSolve,h=e.invInertiaSolve,l=this.G;return d.scale(xt,i,s),d.multiply(xt,t.massMultiplier,xt),d.scale(Ct,n,a),d.multiply(Ct,e.massMultiplier,Ct),this.gmult(l,xt,o*c,Ct,r*h)},Lt.prototype.computeGiMGt=function(){var t=this.bodyA,e=this.bodyB,i=t.invMassSolve,o=e.invMassSolve,n=t.invInertiaSolve,r=e.invInertiaSolve,s=this.G;return s[0]*s[0]*i*t.massMultiplier[0]+s[1]*s[1]*i*t.massMultiplier[1]+s[2]*s[2]*n+s[3]*s[3]*o*e.massMultiplier[0]+s[4]*s[4]*o*e.massMultiplier[1]+s[5]*s[5]*r};var _t=d.create(),Ft=d.create(),Ot=d.create();d.create(),d.create(),d.create();Lt.prototype.addToWlambda=function(t){var e=this.bodyA,i=this.bodyB,o=_t,n=Ft,r=Ot,s=e.invMassSolve,a=i.invMassSolve,c=e.invInertiaSolve,h=i.invInertiaSolve,l=this.G;n[0]=l[0],n[1]=l[1],r[0]=l[3],r[1]=l[4],d.scale(o,n,s*t),d.multiply(o,o,e.massMultiplier),d.add(e.vlambda,e.vlambda,o),e.wlambda+=c*l[2]*t,d.scale(o,r,a*t),d.multiply(o,o,i.massMultiplier),d.add(i.vlambda,i.vlambda,o),i.wlambda+=h*l[5]*t},Lt.prototype.computeInvC=function(t){return 1/(this.computeGiMGt()+t)};var It=kt;function kt(t,e,i){i=i||{},St.call(this,t,e,-Number.MAX_VALUE,Number.MAX_VALUE),this.angle=i.angle||0,this.ratio="number"==typeof i.ratio?i.ratio:1,this.setRatio(this.ratio)}kt.prototype=new St,kt.prototype.constructor=kt,kt.prototype.computeGq=function(){return this.ratio*this.bodyA.angle-this.bodyB.angle+this.angle},kt.prototype.setRatio=function(t){var e=this.G;e[2]=t,e[5]=-1,this.ratio=t},kt.prototype.setMaxTorque=function(t){this.maxForce=t,this.minForce=-t};var Rt=Vt;function Vt(t){this.type=t,this.result=[],this.world=null,this.boundingVolumeType=Vt.AABB}Vt.AABB=1,Vt.BOUNDING_CIRCLE=2,Vt.prototype.setWorld=function(t){this.world=t},Vt.prototype.getCollisionPairs=function(t){};var Tt=d.create();Vt.boundingRadiusCheck=function(t,e){d.sub(Tt,t.position,e.position);var i=d.squaredLength(Tt),o=t.boundingRadius+e.boundingRadius;return i<=o*o},Vt.aabbCheck=function(t,e){return t.getAABB().overlaps(e.getAABB())},Vt.prototype.boundingVolumeCheck=function(t,e){var i;switch(this.boundingVolumeType){case Vt.BOUNDING_CIRCLE:i=Vt.boundingRadiusCheck(t,e);break;case Vt.AABB:i=Vt.aabbCheck(t,e);break;default:throw new Error("Bounding volume type not recognized: "+this.boundingVolumeType)}return i},Vt.canCollide=function(t,e){var i=ot.KINEMATIC,o=ot.STATIC;return(t.type!==o||e.type!==o)&&(!(t.type===i&&e.type===o||t.type===o&&e.type===i)&&((t.type!==i||e.type!==i)&&((t.sleepState!==ot.SLEEPING||e.sleepState!==ot.SLEEPING)&&!(t.sleepState===ot.SLEEPING&&e.type===o||e.sleepState===ot.SLEEPING&&t.type===o))))},Vt.NAIVE=1,Vt.SAP=2;var Nt=jt;function jt(t){"number"==typeof arguments[0]&&"number"==typeof arguments[1]&&(t={length:arguments[0],radius:arguments[1]},console.warn("The Capsule constructor signature has changed. Please use the following format: new Capsule({ radius: 1, length: 1 })")),t=t||{},this.length=t.length||1,this.radius=t.radius||1,t.type=F.CAPSULE,F.call(this,t)}jt.prototype=new F,jt.prototype.constructor=jt,jt.prototype.computeMomentOfInertia=function(t){var e=this.radius,i=this.length+e,o=2*e;return t*(o*o+i*i)/12},jt.prototype.updateBoundingRadius=function(){this.boundingRadius=this.radius+this.length/2},jt.prototype.updateArea=function(){this.area=Math.PI*this.radius*this.radius+2*this.radius*this.length};var Gt=d.create();jt.prototype.computeAABB=function(t,e,i){var o=this.radius;d.set(Gt,this.length/2,0),0!==i&&d.rotate(Gt,Gt,i),d.set(t.upperBound,Math.max(Gt[0]+o,-Gt[0]+o),Math.max(Gt[1]+o,-Gt[1]+o)),d.set(t.lowerBound,Math.min(Gt[0]-o,-Gt[0]-o),Math.min(Gt[1]-o,-Gt[1]-o)),d.add(t.lowerBound,t.lowerBound,e),d.add(t.upperBound,t.upperBound,e)};var Dt=d.create(),Ut=d.create(),zt=d.create(),Wt=d.create(),Xt=d.fromValues(0,1);jt.prototype.raycast=function(t,e,i,o){for(var n=e.from,r=e.to,s=(e.direction,Dt),a=Ut,c=zt,h=Wt,l=this.length/2,u=0;u<2;u++){var p=this.radius*(2*u-1);if(d.set(c,-l,p),d.set(h,l,p),d.toGlobalFrame(c,c,i,o),d.toGlobalFrame(h,h,i,o),(v=d.getLineSegmentsIntersectionFraction(n,r,c,h))>=0&&(d.rotate(a,Xt,o),d.scale(a,a,2*u-1),e.reportIntersection(t,v,a,-1),t.shouldStop(e)))return}var f=Math.pow(this.radius,2)+Math.pow(l,2);for(u=0;u<2;u++){d.set(c,l*(2*u-1),0),d.toGlobalFrame(c,c,i,o);var v,y=Math.pow(r[0]-n[0],2)+Math.pow(r[1]-n[1],2),g=2*((r[0]-n[0])*(n[0]-c[0])+(r[1]-n[1])*(n[1]-c[1])),m=Math.pow(n[0]-c[0],2)+Math.pow(n[1]-c[1],2)-Math.pow(this.radius,2);if(!((v=Math.pow(g,2)-4*y*m)<0))if(0===v){if(d.lerp(s,n,r,v),d.squaredDistance(s,i)>f&&(d.sub(a,s,c),d.normalize(a,a),e.reportIntersection(t,v,a,-1),t.shouldStop(e)))return}else{var b=Math.sqrt(v),A=1/(2*y),E=(-g-b)*A,w=(-g+b)*A;if(E>=0&&E<=1&&(d.lerp(s,n,r,E),d.squaredDistance(s,i)>f&&(d.sub(a,s,c),d.normalize(a,a),e.reportIntersection(t,E,a,-1),t.shouldStop(e))))return;if(w>=0&&w<=1&&(d.lerp(s,n,r,w),d.squaredDistance(s,i)>f&&(d.sub(a,s,c),d.normalize(a,a),e.reportIntersection(t,w,a,-1),t.shouldStop(e))))return}}};var Yt=Ht;function Ht(t){"number"==typeof arguments[0]&&(t={radius:arguments[0]},console.warn("The Circle constructor signature has changed. Please use the following format: new Circle({ radius: 1 })")),t=t||{},this.radius=t.radius||1,t.type=F.CIRCLE,F.call(this,t)}Ht.prototype=new F,Ht.prototype.constructor=Ht,Ht.prototype.computeMomentOfInertia=function(t){var e=this.radius;return t*e*e/2},Ht.prototype.updateBoundingRadius=function(){this.boundingRadius=this.radius},Ht.prototype.updateArea=function(){this.area=Math.PI*this.radius*this.radius},Ht.prototype.computeAABB=function(t,e,i){var o=this.radius;d.set(t.upperBound,o,o),d.set(t.lowerBound,-o,-o),e&&(d.add(t.lowerBound,t.lowerBound,e),d.add(t.upperBound,t.upperBound,e))};var Jt=d.create(),Kt=d.create();Ht.prototype.raycast=function(t,e,i,o){var n=e.from,r=e.to,s=this.radius,a=Math.pow(r[0]-n[0],2)+Math.pow(r[1]-n[1],2),c=2*((r[0]-n[0])*(n[0]-i[0])+(r[1]-n[1])*(n[1]-i[1])),h=Math.pow(n[0]-i[0],2)+Math.pow(n[1]-i[1],2)-Math.pow(s,2),l=Math.pow(c,2)-4*a*h,u=Jt,p=Kt;if(!(l<0))if(0===l)d.lerp(u,n,r,l),d.sub(p,u,i),d.normalize(p,p),e.reportIntersection(t,l,p,-1);else{var f=Math.sqrt(l),v=1/(2*a),y=(-c-f)*v,g=(-c+f)*v;if(y>=0&&y<=1&&(d.lerp(u,n,r,y),d.sub(p,u,i),d.normalize(p,p),e.reportIntersection(t,y,p,-1),t.shouldStop(e)))return;g>=0&&g<=1&&(d.lerp(u,n,r,g),d.sub(p,u,i),d.normalize(p,p),e.reportIntersection(t,g,p,-1))}};var Zt=$t;function $t(t,e,i,o){this.type=i,o=p.defaults(o,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.collideConnected=o.collideConnected,o.wakeUpBodies&&(t&&t.wakeUp(),e&&e.wakeUp())}$t.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},$t.DISTANCE=1,$t.GEAR=2,$t.LOCK=3,$t.PRISMATIC=4,$t.REVOLUTE=5,$t.prototype.setStiffness=function(t){for(var e=this.equations,i=0;i!==e.length;i++){var o=e[i];o.stiffness=t,o.needsUpdate=!0}},$t.prototype.setRelaxation=function(t){for(var e=this.equations,i=0;i!==e.length;i++){var o=e[i];o.relaxation=t,o.needsUpdate=!0}};var Qt=te;function te(t,e){St.call(this,t,e,0,Number.MAX_VALUE),this.contactPointA=d.create(),this.penetrationVec=d.create(),this.contactPointB=d.create(),this.normalA=d.create(),this.restitution=0,this.firstImpact=!1,this.shapeA=null,this.shapeB=null}te.prototype=new St,te.prototype.constructor=te,te.prototype.computeB=function(t,e,i){var o,n,r=this.bodyA,s=this.bodyB,a=this.contactPointA,c=this.contactPointB,h=r.position,l=s.position,u=this.penetrationVec,p=this.normalA,f=this.G,v=d.crossLength(a,p),y=d.crossLength(c,p);return f[0]=-p[0],f[1]=-p[1],f[2]=-v,f[3]=p[0],f[4]=p[1],f[5]=y,d.add(u,l,c),d.sub(u,u,h),d.sub(u,u,a),this.firstImpact&&0!==this.restitution?(n=0,o=1/e*(1+this.restitution)*this.computeGW()):(n=d.dot(p,u)+this.offset,o=this.computeGW()),-n*t-o*e-i*this.computeGiMf()};var ee=d.create(),ie=d.create(),oe=d.create();te.prototype.getVelocityAlongNormal=function(){return this.bodyA.getVelocityAtPoint(ee,this.contactPointA),this.bodyB.getVelocityAtPoint(ie,this.contactPointB),d.subtract(oe,ee,ie),d.dot(this.normalA,oe)};var ne=re;function re(t){t=t||{},this.objects=[],void 0!==t.size&&this.resize(t.size)}re.prototype.resize=function(t){for(var e=this.objects;e.length>t;)e.pop();for(;e.length<t;)e.push(this.create());return this},re.prototype.get=function(){var t=this.objects;return t.length?t.pop():this.create()},re.prototype.release=function(t){return this.destroy(t),this.objects.push(t),this};var se=ae;function ae(){ne.apply(this,arguments)}ae.prototype=new ne,ae.prototype.constructor=ae,ae.prototype.create=function(){return new Qt},ae.prototype.destroy=function(t){return t.bodyA=t.bodyB=null,this};var ce=he;function he(t){this.id=t||he.idCounter++}he.idCounter=0;var le=ue;function ue(t,e,i){if(i=i||{},!(t instanceof ce&&e instanceof ce))throw new Error("First two arguments must be Material instances.");this.id=ue.idCounter++,this.materialA=t,this.materialB=e,this.friction=void 0!==i.friction?Number(i.friction):.3,this.restitution=void 0!==i.restitution?Number(i.restitution):0,this.stiffness=void 0!==i.stiffness?Number(i.stiffness):St.DEFAULT_STIFFNESS,this.relaxation=void 0!==i.relaxation?Number(i.relaxation):St.DEFAULT_RELAXATION,this.frictionStiffness=void 0!==i.frictionStiffness?Number(i.frictionStiffness):St.DEFAULT_STIFFNESS,this.frictionRelaxation=void 0!==i.frictionRelaxation?Number(i.frictionRelaxation):St.DEFAULT_RELAXATION,this.surfaceVelocity=void 0!==i.surfaceVelocity?Number(i.surfaceVelocity):0,this.contactSkinSize=.005}ue.idCounter=0;var pe=fe;function fe(t,e,i){i=p.defaults(i,{localAnchorA:[0,0],localAnchorB:[0,0]}),Zt.call(this,t,e,Zt.DISTANCE,i),this.localAnchorA=d.fromValues(i.localAnchorA[0],i.localAnchorA[1]),this.localAnchorB=d.fromValues(i.localAnchorB[0],i.localAnchorB[1]);var o,n=this.localAnchorA,r=this.localAnchorB;if(this.distance=0,"number"==typeof i.distance)this.distance=i.distance;else{var s=d.create(),a=d.create(),c=d.create();d.rotate(s,n,t.angle),d.rotate(a,r,e.angle),d.add(c,e.position,a),d.sub(c,c,s),d.sub(c,c,t.position),this.distance=d.length(c)}o=void 0===i.maxForce?Number.MAX_VALUE:i.maxForce;var h=new St(t,e,-o,o);this.equations=[h],this.maxForce=o;c=d.create();var l=d.create(),u=d.create(),f=this;h.computeGq=function(){var t=this.bodyA,e=this.bodyB,i=t.position,o=e.position;return d.rotate(l,n,t.angle),d.rotate(u,r,e.angle),d.add(c,o,u),d.sub(c,c,l),d.sub(c,c,i),d.length(c)-f.distance},this.setMaxForce(o),this.upperLimitEnabled=!1,this.upperLimit=1,this.lowerLimitEnabled=!1,this.lowerLimit=0,this.position=0}fe.prototype=new Zt,fe.prototype.constructor=fe;var de=d.create(),ve=d.create(),ye=d.create();fe.prototype.update=function(){var t=this.equations[0],e=this.bodyA,i=this.bodyB,o=(this.distance,e.position),n=i.position,r=this.equations[0],s=t.G;d.rotate(ve,this.localAnchorA,e.angle),d.rotate(ye,this.localAnchorB,i.angle),d.add(de,n,ye),d.sub(de,de,ve),d.sub(de,de,o),this.position=d.length(de);var a=!1;if(this.upperLimitEnabled&&this.position>this.upperLimit&&(r.maxForce=0,r.minForce=-this.maxForce,this.distance=this.upperLimit,a=!0),this.lowerLimitEnabled&&this.position<this.lowerLimit&&(r.maxForce=this.maxForce,r.minForce=0,this.distance=this.lowerLimit,a=!0),!this.lowerLimitEnabled&&!this.upperLimitEnabled||a){r.enabled=!0,d.normalize(de,de);var c=d.crossLength(ve,de),h=d.crossLength(ye,de);s[0]=-de[0],s[1]=-de[1],s[2]=-c,s[3]=de[0],s[4]=de[1],s[5]=h}else r.enabled=!1},fe.prototype.setMaxForce=function(t){var e=this.equations[0];e.minForce=-t,e.maxForce=t},fe.prototype.getMaxForce=function(){return this.equations[0].maxForce};var ge=me;function me(t,e,i){St.call(this,t,e,-i,i),this.contactPointA=d.create(),this.contactPointB=d.create(),this.t=d.create(),this.contactEquations=[],this.shapeA=null,this.shapeB=null,this.frictionCoefficient=.3}me.prototype=new St,me.prototype.constructor=me,me.prototype.setSlipForce=function(t){this.maxForce=t,this.minForce=-t},me.prototype.getSlipForce=function(){return this.maxForce},me.prototype.computeB=function(t,e,i){this.bodyA,this.bodyB;var o=this.contactPointA,n=this.contactPointB,r=this.t,s=this.G;return s[0]=-r[0],s[1]=-r[1],s[2]=-d.crossLength(o,r),s[3]=r[0],s[4]=r[1],s[5]=d.crossLength(n,r),-this.computeGW()*e-i*this.computeGiMf()};var be=Ae;function Ae(){ne.apply(this,arguments)}Ae.prototype=new ne,Ae.prototype.constructor=Ae,Ae.prototype.create=function(){return new ge},Ae.prototype.destroy=function(t){return t.bodyA=t.bodyB=null,this};var Ee=we;function we(t,e,i){i=i||{},Zt.call(this,t,e,Zt.GEAR,i),this.ratio=void 0!==i.ratio?i.ratio:1,this.angle=void 0!==i.angle?i.angle:e.angle-this.ratio*t.angle,i.angle=this.angle,i.ratio=this.ratio,this.equations=[new It(t,e,i)],void 0!==i.maxTorque&&this.setMaxTorque(i.maxTorque)}we.prototype=new Zt,we.prototype.constructor=we,we.prototype.update=function(){var t=this.equations[0];t.ratio!==this.ratio&&t.setRatio(this.ratio),t.angle=this.angle},we.prototype.setMaxTorque=function(t){this.equations[0].setMaxTorque(t)},we.prototype.getMaxTorque=function(t){return this.equations[0].maxForce};var Be=Pe;function Pe(t,e){t=t||{},it.call(this),this.type=e,this.equations=[],this.equationSortFunction=t.equationSortFunction||!1}Pe.prototype=new it,Pe.prototype.constructor=Pe,Pe.prototype.solve=function(t,e){throw new Error("Solver.solve should be implemented by subclasses!")};var Se={bodies:[]};Pe.prototype.solveIsland=function(t,e){this.removeAllEquations(),e.equations.length&&(this.addEquations(e.equations),Se.bodies.length=0,e.getBodies(Se.bodies),Se.bodies.length&&this.solve(t,Se))},Pe.prototype.sortEquations=function(){this.equationSortFunction&&this.equations.sort(this.equationSortFunction)},Pe.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)},Pe.prototype.addEquations=function(t){for(var e=0,i=t.length;e!==i;e++){var o=t[e];o.enabled&&this.equations.push(o)}},Pe.prototype.removeEquation=function(t){var e=this.equations.indexOf(t);-1!==e&&this.equations.splice(e,1)},Pe.prototype.removeAllEquations=function(){this.equations.length=0},Pe.GS=1,Pe.ISLAND=2;var Le=qe;function qe(t){Be.call(this,t,Be.GS),t=t||{},this.iterations=t.iterations||10,this.tolerance=t.tolerance||1e-7,this.arrayStep=30,this.lambda=new p.ARRAY_TYPE(this.arrayStep),this.Bs=new p.ARRAY_TYPE(this.arrayStep),this.invCs=new p.ARRAY_TYPE(this.arrayStep),this.useZeroRHS=!1,this.frictionIterations=void 0!==t.frictionIterations?0:t.frictionIterations,this.usedIterations=0}qe.prototype=new Be,qe.prototype.constructor=qe,qe.prototype.solve=function(t,e){this.sortEquations();var i=0,o=this.iterations,n=this.frictionIterations,r=this.equations,s=r.length,a=Math.pow(this.tolerance*s,2),c=e.bodies,h=e.bodies.length,l=(d.add,d.set,this.useZeroRHS),u=this.lambda;if(this.usedIterations=0,s)for(var f=0;f!==h;f++){c[f].updateSolveMassProperties()}u.length<s&&(u=this.lambda=new p.ARRAY_TYPE(s+this.arrayStep),this.Bs=new p.ARRAY_TYPE(s+this.arrayStep),this.invCs=new p.ARRAY_TYPE(s+this.arrayStep)),function(t){for(var e=t.length;e--;)t[e]=0}(u);var v,y,g=this.invCs,m=this.Bs;for(u=this.lambda,f=0;f!==r.length;f++){var b;((b=r[f]).timeStep!==t||b.needsUpdate)&&(b.timeStep=t,b.update()),m[f]=b.computeB(b.a,b.b,t),g[f]=b.computeInvC(b.epsilon)}if(0!==s){for(f=0;f!==h;f++){c[f].resetConstraintVelocity()}if(n){for(i=0;i!==n;i++){for(v=0,y=0;y!==s;y++){b=r[y];var A=qe.iterateEquation(y,b,b.epsilon,m,g,u,l,t,i);v+=Math.abs(A)}if(this.usedIterations++,v*v<=a)break}for(qe.updateMultipliers(r,u,1/t),y=0;y!==s;y++){var E=r[y];if(E instanceof ge){for(var w=0,B=0;B!==E.contactEquations.length;B++)w+=E.contactEquations[B].multiplier;w*=E.frictionCoefficient/E.contactEquations.length,E.maxForce=w,E.minForce=-w}}}for(i=0;i!==o;i++){for(v=0,y=0;y!==s;y++){b=r[y];A=qe.iterateEquation(y,b,b.epsilon,m,g,u,l,t,i);v+=Math.abs(A)}if(this.usedIterations++,v*v<=a)break}for(f=0;f!==h;f++)c[f].addConstraintVelocity();qe.updateMultipliers(r,u,1/t)}},qe.updateMultipliers=function(t,e,i){for(var o=t.length;o--;)t[o].multiplier=e[o]*i},qe.iterateEquation=function(t,e,i,o,n,r,s,a,c){var h=o[t],l=n[t],u=r[t],p=e.computeGWlambda(),f=e.maxForce,d=e.minForce;s&&(h=0);var v=l*(h-p-i*u),y=u+v;return y<d*a?v=d*a-u:y>f*a&&(v=f*a-u),r[t]+=v,e.addToWlambda(v),v};var Me=xe;function xe(t){if(Array.isArray(arguments[0])){if(t={heights:arguments[0]},"object"==typeof arguments[1])for(var e in arguments[1])t[e]=arguments[1][e];console.warn("The Heightfield constructor signature has changed. Please use the following format: new Heightfield({ heights: [...], ... })")}t=t||{},this.heights=t.heights?t.heights.slice(0):[],this.maxValue=t.maxValue||null,this.minValue=t.minValue||null,this.elementWidth=t.elementWidth||.1,void 0!==t.maxValue&&void 0!==t.minValue||this.updateMaxMinValues(),t.type=F.HEIGHTFIELD,F.call(this,t)}xe.prototype=new F,xe.prototype.constructor=xe,xe.prototype.updateMaxMinValues=function(){for(var t=this.heights,e=t[0],i=t[0],o=0;o!==t.length;o++){var n=t[o];n>e&&(e=n),n<i&&(i=n)}this.maxValue=e,this.minValue=i},xe.prototype.computeMomentOfInertia=function(t){return Number.MAX_VALUE},xe.prototype.updateBoundingRadius=function(){this.boundingRadius=Number.MAX_VALUE},xe.prototype.updateArea=function(){for(var t=this.heights,e=0,i=0;i<t.length-1;i++)e+=(t[i]+t[i+1])/2*this.elementWidth;this.area=e};var Ce=[d.create(),d.create(),d.create(),d.create()];xe.prototype.computeAABB=function(t,e,i){d.set(Ce[0],0,this.maxValue),d.set(Ce[1],this.elementWidth*this.heights.length,this.maxValue),d.set(Ce[2],this.elementWidth*this.heights.length,this.minValue),d.set(Ce[3],0,this.minValue),t.setFromPoints(Ce,e,i)},xe.prototype.getLineSegment=function(t,e,i){var o=this.heights,n=this.elementWidth;d.set(t,i*n,o[i]),d.set(e,(i+1)*n,o[i+1])},xe.prototype.getSegmentIndex=function(t){return Math.floor(t[0]/this.elementWidth)},xe.prototype.getClampedSegmentIndex=function(t){var e=this.getSegmentIndex(t);return e=Math.min(this.heights.length,Math.max(e,0))};d.create();var _e=d.create(),Fe=d.create(),Oe=d.create(),Ie=d.create(),ke=d.create();d.fromValues(0,1);xe.prototype.raycast=function(t,e,i,o){var n=e.from,r=e.to,s=(e.direction,_e),a=Fe,c=Oe,h=Ie,l=ke;d.toLocalFrame(h,n,i,o),d.toLocalFrame(l,r,i,o);var u=this.getClampedSegmentIndex(h),p=this.getClampedSegmentIndex(l);if(u>p){var f=u;u=p,p=f}for(var v=0;v<this.heights.length-1;v++){this.getLineSegment(a,c,v);var y=d.getLineSegmentsIntersectionFraction(h,l,a,c);if(y>=0&&(d.sub(s,c,a),d.rotate(s,s,o+Math.PI/2),d.normalize(s,s),e.reportIntersection(t,y,s,-1),t.shouldStop(e)))return}};var Re=Ve;function Ve(t){"number"==typeof arguments[0]&&(t={length:arguments[0]},console.warn("The Line constructor signature has changed. Please use the following format: new Line({ length: 1, ... })")),t=t||{},this.length=t.length||1,t.type=F.LINE,F.call(this,t)}Ve.prototype=new F,Ve.prototype.constructor=Ve,Ve.prototype.computeMomentOfInertia=function(t){return t*Math.pow(this.length,2)/12},Ve.prototype.updateBoundingRadius=function(){this.boundingRadius=this.length/2};var Te=[d.create(),d.create()];Ve.prototype.computeAABB=function(t,e,i){var o=this.length/2;d.set(Te[0],-o,0),d.set(Te[1],o,0),t.setFromPoints(Te,e,i,0)};d.create();var Ne=d.create(),je=d.create(),Ge=d.create(),De=d.fromValues(0,1);Ve.prototype.raycast=function(t,e,i,o){var n=e.from,r=e.to,s=je,a=Ge,c=this.length/2;d.set(s,-c,0),d.set(a,c,0),d.toGlobalFrame(s,s,i,o),d.toGlobalFrame(a,a,i,o);var h=d.getLineSegmentsIntersectionFraction(s,a,n,r);if(h>=0){var l=Ne;d.rotate(l,De,o),e.reportIntersection(t,h,l,-1)}};var Ue=ze;function ze(t,e,i){i=i||{},Zt.call(this,t,e,Zt.LOCK,i);var o=void 0===i.maxForce?Number.MAX_VALUE:i.maxForce,n=(i.localAngleB,new St(t,e,-o,o)),r=new St(t,e,-o,o),s=new St(t,e,-o,o),a=d.create(),c=d.create(),h=this;n.computeGq=function(){return d.rotate(a,h.localOffsetB,t.angle),d.sub(c,e.position,t.position),d.sub(c,c,a),c[0]},r.computeGq=function(){return d.rotate(a,h.localOffsetB,t.angle),d.sub(c,e.position,t.position),d.sub(c,c,a),c[1]};var l=d.create(),u=d.create();s.computeGq=function(){return d.rotate(l,h.localOffsetB,e.angle-h.localAngleB),d.scale(l,l,-1),d.sub(c,t.position,e.position),d.add(c,c,l),d.rotate(u,l,-Math.PI/2),d.normalize(u,u),d.dot(c,u)},this.localOffsetB=d.create(),i.localOffsetB?d.copy(this.localOffsetB,i.localOffsetB):(d.sub(this.localOffsetB,e.position,t.position),d.rotate(this.localOffsetB,this.localOffsetB,-t.angle)),this.localAngleB=0,"number"==typeof i.localAngleB?this.localAngleB=i.localAngleB:this.localAngleB=e.angle-t.angle,this.equations.push(n,r,s),this.setMaxForce(o)}ze.prototype=new Zt,ze.prototype.constructor=ze,ze.prototype.setMaxForce=function(t){for(var e=this.equations,i=0;i<this.equations.length;i++)e[i].maxForce=t,e[i].minForce=-t},ze.prototype.getMaxForce=function(){return this.equations[0].maxForce};var We=d.create(),Xe=d.create(),Ye=d.create(),He=d.fromValues(1,0),Je=d.fromValues(0,1);ze.prototype.update=function(){var t=this.equations[0],e=this.equations[1],i=this.equations[2],o=this.bodyA,n=this.bodyB;d.rotate(We,this.localOffsetB,o.angle),d.rotate(Xe,this.localOffsetB,n.angle-this.localAngleB),d.scale(Xe,Xe,-1),d.rotate(Ye,Xe,Math.PI/2),d.normalize(Ye,Ye),t.G[0]=-1,t.G[1]=0,t.G[2]=-d.crossLength(We,He),t.G[3]=1,e.G[0]=0,e.G[1]=-1,e.G[2]=-d.crossLength(We,Je),e.G[4]=1,i.G[0]=-Ye[0],i.G[1]=-Ye[1],i.G[3]=Ye[0],i.G[4]=Ye[1],i.G[5]=d.crossLength(Xe,Ye)};var Ke=Ze;function Ze(){this.data={},this.keys=[]}Ze.prototype.getKey=function(t,e){return(0|(t|=0))==(0|(e|=0))?-1:0|((0|t)>(0|e)?t<<16|65535&e:e<<16|65535&t)},Ze.prototype.getByKey=function(t){return t|=0,this.data[t]},Ze.prototype.get=function(t,e){return this.data[this.getKey(t,e)]},Ze.prototype.set=function(t,e,i){if(!i)throw new Error("No data!");var o=this.getKey(t,e);return this.data[o]||this.keys.push(o),this.data[o]=i,o},Ze.prototype.reset=function(){for(var t=this.data,e=this.keys,i=e.length;i--;)delete t[e[i]];e.length=0},Ze.prototype.copy=function(t){this.reset(),p.appendArray(this.keys,t.keys);for(var e=t.keys.length;e--;){var i=t.keys[e];this.data[i]=t.data[i]}};var $e=Qe;function Qe(t){"number"==typeof arguments[0]&&"number"==typeof arguments[1]&&(t={width:arguments[0],height:arguments[1]},console.warn("The Rectangle has been renamed to Box and its constructor signature has changed. Please use the following format: new Box({ width: 1, height: 1, ... })")),t=t||{};var e=this.width=t.width||1,i=this.height=t.height||1,o=[d.fromValues(-e/2,-i/2),d.fromValues(e/2,-i/2),d.fromValues(e/2,i/2),d.fromValues(-e/2,i/2)],n=[d.fromValues(1,0),d.fromValues(0,1)];t.vertices=o,t.axes=n,t.type=F.BOX,R.call(this,t)}Qe.prototype=new R,Qe.prototype.constructor=Qe,Qe.prototype.computeMomentOfInertia=function(t){var e=this.width,i=this.height;return t*(i*i+e*e)/12},Qe.prototype.updateBoundingRadius=function(){var t=this.width,e=this.height;this.boundingRadius=Math.sqrt(t*t+e*e)/2};d.create(),d.create(),d.create(),d.create();Qe.prototype.computeAABB=function(t,e,i){t.setFromPoints(this.vertices,e,i,0)},Qe.prototype.updateArea=function(){this.area=this.width*this.height};var ti=d.sub,ei=d.add,ii=d.dot,oi=Pi,ni=d.fromValues(0,1),ri=d.fromValues(0,0),si=d.fromValues(0,0),ai=d.fromValues(0,0),ci=d.fromValues(0,0),hi=d.fromValues(0,0),li=d.fromValues(0,0),ui=d.fromValues(0,0),pi=d.fromValues(0,0),fi=d.fromValues(0,0),di=d.fromValues(0,0),vi=d.fromValues(0,0),yi=d.fromValues(0,0),gi=d.fromValues(0,0),mi=d.fromValues(0,0),bi=d.fromValues(0,0),Ai=d.fromValues(0,0),Ei=d.fromValues(0,0),wi=d.fromValues(0,0),Bi=[];function Pi(){this.contactEquations=[],this.frictionEquations=[],this.enableFriction=!0,this.enabledEquations=!0,this.slipForce=10,this.frictionCoefficient=.3,this.surfaceVelocity=0,this.contactEquationPool=new se({size:32}),this.frictionEquationPool=new be({size:64}),this.restitution=0,this.stiffness=St.DEFAULT_STIFFNESS,this.relaxation=St.DEFAULT_RELAXATION,this.frictionStiffness=St.DEFAULT_STIFFNESS,this.frictionRelaxation=St.DEFAULT_RELAXATION,this.enableFrictionReduction=!0,this.collidingBodiesLastStep=new Ke,this.contactSkinSize=.01}var Si=d.create(),Li=d.create();function qi(t,e){d.set(t.vertices[0],.5*-e.length,-e.radius),d.set(t.vertices[1],.5*e.length,-e.radius),d.set(t.vertices[2],.5*e.length,e.radius),d.set(t.vertices[3],.5*-e.length,e.radius)}Pi.prototype.bodiesOverlap=function(t,e){for(var i=Si,o=Li,n=0,r=t.shapes.length;n!==r;n++){var s=t.shapes[n];t.toWorldFrame(i,s.position);for(var a=0,c=e.shapes.length;a!==c;a++){var h=e.shapes[a];if(e.toWorldFrame(o,h.position),this[s.type|h.type](t,s,i,s.angle+t.angle,e,h,o,h.angle+e.angle,!0))return!0}}return!1},Pi.prototype.collidedLastStep=function(t,e){var i=0|t.id,o=0|e.id;return!!this.collidingBodiesLastStep.get(i,o)},Pi.prototype.reset=function(){this.collidingBodiesLastStep.reset();for(var t=this.contactEquations,e=t.length;e--;){var i=t[e],o=i.bodyA.id,n=i.bodyB.id;this.collidingBodiesLastStep.set(o,n,!0)}for(var r=this.contactEquations,s=this.frictionEquations,a=0;a<r.length;a++)this.contactEquationPool.release(r[a]);for(a=0;a<s.length;a++)this.frictionEquationPool.release(s[a]);this.contactEquations.length=this.frictionEquations.length=0},Pi.prototype.createContactEquation=function(t,e,i,o){var n=this.contactEquationPool.get();return n.bodyA=t,n.bodyB=e,n.shapeA=i,n.shapeB=o,n.restitution=this.restitution,n.firstImpact=!this.collidedLastStep(t,e),n.stiffness=this.stiffness,n.relaxation=this.relaxation,n.needsUpdate=!0,n.enabled=this.enabledEquations,n.offset=this.contactSkinSize,n},Pi.prototype.createFrictionEquation=function(t,e,i,o){var n=this.frictionEquationPool.get();return n.bodyA=t,n.bodyB=e,n.shapeA=i,n.shapeB=o,n.setSlipForce(this.slipForce),n.frictionCoefficient=this.frictionCoefficient,n.relativeVelocity=this.surfaceVelocity,n.enabled=this.enabledEquations,n.needsUpdate=!0,n.stiffness=this.frictionStiffness,n.relaxation=this.frictionRelaxation,n.contactEquations.length=0,n},Pi.prototype.createFrictionFromContact=function(t){var e=this.createFrictionEquation(t.bodyA,t.bodyB,t.shapeA,t.shapeB);return d.copy(e.contactPointA,t.contactPointA),d.copy(e.contactPointB,t.contactPointB),d.rotate90cw(e.t,t.normalA),e.contactEquations.push(t),e},Pi.prototype.createFrictionFromAverage=function(t){var e=this.contactEquations[this.contactEquations.length-1],i=this.createFrictionEquation(e.bodyA,e.bodyB,e.shapeA,e.shapeB),o=e.bodyA;e.bodyB;d.set(i.contactPointA,0,0),d.set(i.contactPointB,0,0),d.set(i.t,0,0);for(var n=0;n!==t;n++)(e=this.contactEquations[this.contactEquations.length-1-n]).bodyA===o?(d.add(i.t,i.t,e.normalA),d.add(i.contactPointA,i.contactPointA,e.contactPointA),d.add(i.contactPointB,i.contactPointB,e.contactPointB)):(d.sub(i.t,i.t,e.normalA),d.add(i.contactPointA,i.contactPointA,e.contactPointB),d.add(i.contactPointB,i.contactPointB,e.contactPointA)),i.contactEquations.push(e);var r=1/t;return d.scale(i.contactPointA,i.contactPointA,r),d.scale(i.contactPointB,i.contactPointB,r),d.normalize(i.t,i.t),d.rotate90cw(i.t,i.t),i},Pi.prototype[F.LINE|F.CONVEX]=Pi.prototype.convexLine=function(t,e,i,o,n,r,s,a,c){return!c&&0},Pi.prototype[F.LINE|F.BOX]=Pi.prototype.lineBox=function(t,e,i,o,n,r,s,a,c){return!c&&0};var Mi=new $e({width:1,height:1}),xi=d.create();Pi.prototype[F.CAPSULE|F.CONVEX]=Pi.prototype[F.CAPSULE|F.BOX]=Pi.prototype.convexCapsule=function(t,e,i,o,n,r,s,a,c){var h=xi;d.set(h,r.length/2,0),d.rotate(h,h,a),d.add(h,h,s);var l=this.circleConvex(n,r,h,a,t,e,i,o,c,r.radius);d.set(h,-r.length/2,0),d.rotate(h,h,a),d.add(h,h,s);var u=this.circleConvex(n,r,h,a,t,e,i,o,c,r.radius);if(c&&(l||u))return!0;var p=Mi;return qi(p,r),this.convexConvex(t,e,i,o,n,p,s,a,c)+l+u},Pi.prototype[F.CAPSULE|F.LINE]=Pi.prototype.lineCapsule=function(t,e,i,o,n,r,s,a,c){return!c&&0};var Ci=d.create(),_i=d.create(),Fi=new $e({width:1,height:1});Pi.prototype[F.CAPSULE|F.CAPSULE]=Pi.prototype.capsuleCapsule=function(t,e,i,o,n,r,s,a,c){for(var h=Ci,l=_i,u=0,p=0;p<2;p++){d.set(h,(0===p?-1:1)*e.length/2,0),d.rotate(h,h,o),d.add(h,h,i);for(var f=0;f<2;f++){d.set(l,(0===f?-1:1)*r.length/2,0),d.rotate(l,l,a),d.add(l,l,s),this.enableFrictionReduction&&(m=this.enableFriction,this.enableFriction=!1);var v=this.circleCircle(t,e,h,o,n,r,l,a,c,e.radius,r.radius);if(this.enableFrictionReduction&&(this.enableFriction=m),c&&v)return!0;u+=v}}this.enableFrictionReduction&&(m=this.enableFriction,this.enableFriction=!1);var y=Fi;qi(y,e);var g=this.convexCapsule(t,y,i,o,n,r,s,a,c);if(this.enableFrictionReduction&&(this.enableFriction=m),c&&g)return!0;if(u+=g,this.enableFrictionReduction){var m=this.enableFriction;this.enableFriction=!1}qi(y,r);var b=this.convexCapsule(n,y,s,a,t,e,i,o,c);return this.enableFrictionReduction&&(this.enableFriction=m),!(!c||!b)||(u+=b,this.enableFrictionReduction&&u&&this.enableFriction&&this.frictionEquations.push(this.createFrictionFromAverage(u)),u)},Pi.prototype[F.LINE|F.LINE]=Pi.prototype.lineLine=function(t,e,i,o,n,r,s,a,c){return!c&&0},Pi.prototype[F.PLANE|F.LINE]=Pi.prototype.planeLine=function(t,e,i,o,n,r,s,a,c){var h=ri,l=si,u=ai,p=ci,f=hi,v=li,y=ui,g=pi,m=fi,b=Bi,A=0;d.set(h,-r.length/2,0),d.set(l,r.length/2,0),d.rotate(u,h,a),d.rotate(p,l,a),ei(u,u,s),ei(p,p,s),d.copy(h,u),d.copy(l,p),ti(f,l,h),d.normalize(v,f),d.rotate90cw(m,v),d.rotate(g,ni,o),b[0]=h,b[1]=l;for(var E=0;E<b.length;E++){var w=b[E];ti(y,w,i);var B=ii(y,g);if(B<0){if(c)return!0;var P=this.createContactEquation(t,n,e,r);A++,d.copy(P.normalA,g),d.normalize(P.normalA,P.normalA),d.scale(y,g,B),ti(P.contactPointA,w,y),ti(P.contactPointA,P.contactPointA,t.position),ti(P.contactPointB,w,s),ei(P.contactPointB,P.contactPointB,s),ti(P.contactPointB,P.contactPointB,n.position),this.contactEquations.push(P),this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(P))}}return!c&&(this.enableFrictionReduction||A&&this.enableFriction&&this.frictionEquations.push(this.createFrictionFromAverage(A)),A)},Pi.prototype[F.PARTICLE|F.CAPSULE]=Pi.prototype.particleCapsule=function(t,e,i,o,n,r,s,a,c){return this.circleLine(t,e,i,o,n,r,s,a,c,r.radius,0)},Pi.prototype[F.CIRCLE|F.LINE]=Pi.prototype.circleLine=function(t,e,i,o,n,r,s,a,c,h,l){h=h||0,l=void 0!==l?l:e.radius;var u=ri,p=si,f=ai,v=ci,y=hi,g=li,m=ui,b=pi,A=fi,E=di,w=vi,B=yi,P=gi,S=mi,L=Bi;d.set(b,-r.length/2,0),d.set(A,r.length/2,0),d.rotate(E,b,a),d.rotate(w,A,a),ei(E,E,s),ei(w,w,s),d.copy(b,E),d.copy(A,w),ti(g,A,b),d.normalize(m,g),d.rotate90cw(y,m),ti(B,i,b);var q=ii(B,y);ti(v,b,s),ti(P,i,s);var M=l+h;if(Math.abs(q)<M){d.scale(u,y,q),ti(f,i,u),d.scale(p,y,ii(y,P)),d.normalize(p,p),d.scale(p,p,h),ei(f,f,p);var x=ii(m,f),C=ii(m,b),_=ii(m,A);if(x>C&&x<_){if(c)return!0;var F=this.createContactEquation(t,n,e,r);return d.scale(F.normalA,u,-1),d.normalize(F.normalA,F.normalA),d.scale(F.contactPointA,F.normalA,l),ei(F.contactPointA,F.contactPointA,i),ti(F.contactPointA,F.contactPointA,t.position),ti(F.contactPointB,f,s),ei(F.contactPointB,F.contactPointB,s),ti(F.contactPointB,F.contactPointB,n.position),this.contactEquations.push(F),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(F)),1}}L[0]=b,L[1]=A;for(var O=0;O<L.length;O++){var I=L[O];if(ti(B,I,i),d.squaredLength(B)<Math.pow(M,2)){if(c)return!0;F=this.createContactEquation(t,n,e,r);return d.copy(F.normalA,B),d.normalize(F.normalA,F.normalA),d.scale(F.contactPointA,F.normalA,l),ei(F.contactPointA,F.contactPointA,i),ti(F.contactPointA,F.contactPointA,t.position),ti(F.contactPointB,I,s),d.scale(S,F.normalA,-h),ei(F.contactPointB,F.contactPointB,S),ei(F.contactPointB,F.contactPointB,s),ti(F.contactPointB,F.contactPointB,n.position),this.contactEquations.push(F),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(F)),1}}return 0},Pi.prototype[F.CIRCLE|F.CAPSULE]=Pi.prototype.circleCapsule=function(t,e,i,o,n,r,s,a,c){return this.circleLine(t,e,i,o,n,r,s,a,c,r.radius)},Pi.prototype[F.CIRCLE|F.CONVEX]=Pi.prototype[F.CIRCLE|F.BOX]=Pi.prototype.circleConvex=function(t,e,i,o,n,r,s,a,c,h){h="number"==typeof h?h:e.radius;for(var l=ri,u=si,p=ai,f=ci,v=hi,y=di,g=vi,m=gi,b=mi,A=bi,E=Ai,w=!1,B=Number.MAX_VALUE,P=r.vertices,S=0;S!==P.length+1;S++){var L=P[S%P.length],q=P[(S+1)%P.length];if(d.rotate(l,L,a),d.rotate(u,q,a),ei(l,l,s),ei(u,u,s),ti(p,u,l),d.normalize(f,p),d.rotate90cw(v,f),d.scale(b,v,-e.radius),ei(b,b,i),Vi(b,r,s,a)){d.sub(A,l,b);var M=Math.abs(d.dot(A,v));M<B&&(d.copy(E,b),B=M,d.scale(m,v,M),d.add(m,m,b),w=!0)}}if(w){if(c)return!0;var x=this.createContactEquation(t,n,e,r);return d.sub(x.normalA,E,i),d.normalize(x.normalA,x.normalA),d.scale(x.contactPointA,x.normalA,h),ei(x.contactPointA,x.contactPointA,i),ti(x.contactPointA,x.contactPointA,t.position),ti(x.contactPointB,m,s),ei(x.contactPointB,x.contactPointB,s),ti(x.contactPointB,x.contactPointB,n.position),this.contactEquations.push(x),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(x)),1}if(h>0)for(S=0;S<P.length;S++){var C=P[S];if(d.rotate(g,C,a),ei(g,g,s),ti(y,g,i),d.squaredLength(y)<Math.pow(h,2)){if(c)return!0;x=this.createContactEquation(t,n,e,r);return d.copy(x.normalA,y),d.normalize(x.normalA,x.normalA),d.scale(x.contactPointA,x.normalA,h),ei(x.contactPointA,x.contactPointA,i),ti(x.contactPointA,x.contactPointA,t.position),ti(x.contactPointB,g,s),ei(x.contactPointB,x.contactPointB,s),ti(x.contactPointB,x.contactPointB,n.position),this.contactEquations.push(x),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(x)),1}}return 0};var Oi=d.create(),Ii=d.create(),ki=d.create(),Ri=d.create();function Vi(t,e,i,o){for(var n=Oi,r=Ii,s=ki,a=Ri,c=t,h=e.vertices,l=null,u=0;u!==h.length+1;u++){var p=h[u%h.length],f=h[(u+1)%h.length];d.rotate(n,p,o),d.rotate(r,f,o),ei(n,n,i),ei(r,r,i),ti(s,n,c),ti(a,r,c);var v=d.crossLength(s,a);if(null===l&&(l=v),v*l<=0)return!1;l=v}return!0}Pi.prototype[F.PARTICLE|F.CONVEX]=Pi.prototype[F.PARTICLE|F.BOX]=Pi.prototype.particleConvex=function(t,e,i,o,n,r,s,a,c){var h=ri,l=si,u=ai,p=ci,f=hi,v=li,y=ui,g=di,m=gi,b=Ei,A=wi,E=Number.MAX_VALUE,w=!1,B=r.vertices;if(!Vi(i,r,s,a))return 0;if(c)return!0;for(var P=0;P!==B.length+1;P++){var S=B[P%B.length],L=B[(P+1)%B.length];d.rotate(h,S,a),d.rotate(l,L,a),ei(h,h,s),ei(l,l,s),ti(u,l,h),d.normalize(p,u),d.rotate90cw(f,p),ti(g,i,h);ii(g,f);ti(v,h,s),ti(y,i,s),d.sub(b,h,i);var q=Math.abs(d.dot(b,f));q<E&&(E=q,d.scale(m,f,q),d.add(m,m,i),d.copy(A,f),w=!0)}if(w){var M=this.createContactEquation(t,n,e,r);return d.scale(M.normalA,A,-1),d.normalize(M.normalA,M.normalA),d.set(M.contactPointA,0,0),ei(M.contactPointA,M.contactPointA,i),ti(M.contactPointA,M.contactPointA,t.position),ti(M.contactPointB,m,s),ei(M.contactPointB,M.contactPointB,s),ti(M.contactPointB,M.contactPointB,n.position),this.contactEquations.push(M),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(M)),1}return 0},Pi.prototype[F.CIRCLE]=Pi.prototype.circleCircle=function(t,e,i,o,n,r,s,a,c,h,l){var u=ri;h=h||e.radius,l=l||r.radius;ti(u,i,s);var p=h+l;if(d.squaredLength(u)>Math.pow(p,2))return 0;if(c)return!0;var f=this.createContactEquation(t,n,e,r);return ti(f.normalA,s,i),d.normalize(f.normalA,f.normalA),d.scale(f.contactPointA,f.normalA,h),d.scale(f.contactPointB,f.normalA,-l),ei(f.contactPointA,f.contactPointA,i),ti(f.contactPointA,f.contactPointA,t.position),ei(f.contactPointB,f.contactPointB,s),ti(f.contactPointB,f.contactPointB,n.position),this.contactEquations.push(f),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(f)),1},Pi.prototype[F.PLANE|F.CONVEX]=Pi.prototype[F.PLANE|F.BOX]=Pi.prototype.planeConvex=function(t,e,i,o,n,r,s,a,c){var h=ri,l=si,u=ai,p=0;d.rotate(l,ni,o);for(var f=0;f!==r.vertices.length;f++){var v=r.vertices[f];if(d.rotate(h,v,a),ei(h,h,s),ti(u,h,i),ii(u,l)<=0){if(c)return!0;p++;var y=this.createContactEquation(t,n,e,r);ti(u,h,i),d.copy(y.normalA,l);var g=ii(u,y.normalA);d.scale(u,y.normalA,g),ti(y.contactPointB,h,n.position),ti(y.contactPointA,h,u),ti(y.contactPointA,y.contactPointA,t.position),this.contactEquations.push(y),this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(y))}}return this.enableFrictionReduction&&this.enableFriction&&p&&this.frictionEquations.push(this.createFrictionFromAverage(p)),p},Pi.prototype[F.PARTICLE|F.PLANE]=Pi.prototype.particlePlane=function(t,e,i,o,n,r,s,a,c){var h=ri,l=si;a=a||0,ti(h,i,s),d.rotate(l,ni,a);var u=ii(h,l);if(u>0)return 0;if(c)return!0;var p=this.createContactEquation(n,t,r,e);return d.copy(p.normalA,l),d.scale(h,p.normalA,u),ti(p.contactPointA,i,h),ti(p.contactPointA,p.contactPointA,n.position),ti(p.contactPointB,i,t.position),this.contactEquations.push(p),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(p)),1},Pi.prototype[F.CIRCLE|F.PARTICLE]=Pi.prototype.circleParticle=function(t,e,i,o,n,r,s,a,c){var h=ri;if(ti(h,s,i),d.squaredLength(h)>Math.pow(e.radius,2))return 0;if(c)return!0;var l=this.createContactEquation(t,n,e,r);return d.copy(l.normalA,h),d.normalize(l.normalA,l.normalA),d.scale(l.contactPointA,l.normalA,e.radius),ei(l.contactPointA,l.contactPointA,i),ti(l.contactPointA,l.contactPointA,t.position),ti(l.contactPointB,s,n.position),this.contactEquations.push(l),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(l)),1};var Ti=new Yt({radius:1}),Ni=d.create(),ji=d.create();d.create();Pi.prototype[F.PLANE|F.CAPSULE]=Pi.prototype.planeCapsule=function(t,e,i,o,n,r,s,a,c){var h,l=Ni,u=ji,p=Ti;d.set(l,-r.length/2,0),d.rotate(l,l,a),ei(l,l,s),d.set(u,r.length/2,0),d.rotate(u,u,a),ei(u,u,s),p.radius=r.radius,this.enableFrictionReduction&&(h=this.enableFriction,this.enableFriction=!1);var f=this.circlePlane(n,p,l,0,t,e,i,o,c),v=this.circlePlane(n,p,u,0,t,e,i,o,c);if(this.enableFrictionReduction&&(this.enableFriction=h),c)return f||v;var y=f+v;return this.enableFrictionReduction&&y&&this.frictionEquations.push(this.createFrictionFromAverage(y)),y},Pi.prototype[F.CIRCLE|F.PLANE]=Pi.prototype.circlePlane=function(t,e,i,o,n,r,s,a,c){var h=t,l=e,u=i,p=n,f=s,v=a;v=v||0;var y=ri,g=si,m=ai;ti(y,u,f),d.rotate(g,ni,v);var b=ii(g,y);if(b>l.radius)return 0;if(c)return!0;var A=this.createContactEquation(p,h,r,e);return d.copy(A.normalA,g),d.scale(A.contactPointB,A.normalA,-l.radius),ei(A.contactPointB,A.contactPointB,u),ti(A.contactPointB,A.contactPointB,h.position),d.scale(m,A.normalA,b),ti(A.contactPointA,y,m),ei(A.contactPointA,A.contactPointA,f),ti(A.contactPointA,A.contactPointA,p.position),this.contactEquations.push(A),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(A)),1},Pi.prototype[F.CONVEX]=Pi.prototype[F.CONVEX|F.BOX]=Pi.prototype[F.BOX]=Pi.prototype.convexConvex=function(t,e,i,o,n,r,s,a,c,h){var l=ri,u=si,p=ai,f=ci,v=hi,y=ui,g=pi,m=fi,b=0;h="number"==typeof h?h:0;if(!Pi.findSeparatingAxis(e,i,o,r,s,a,l))return 0;ti(g,s,i),ii(l,g)>0&&d.scale(l,l,-1);var A=Pi.getClosestEdge(e,o,l,!0),E=Pi.getClosestEdge(r,a,l);if(-1===A||-1===E)return 0;for(var w=0;w<2;w++){var B,P=A,S=E,L=e,q=r,M=i,x=s,C=o,_=a,F=t,O=n;if(0===w)B=P,P=S,S=B,B=L,L=q,q=B,B=M,M=x,x=B,B=C,C=_,_=B,B=F,F=O,O=B;for(var I=S;I<S+2;I++){var k=q.vertices[(I+q.vertices.length)%q.vertices.length];d.rotate(u,k,_),ei(u,u,x);for(var R=0,V=P-1;V<P+2;V++){var T=L.vertices[(V+L.vertices.length)%L.vertices.length],N=L.vertices[(V+1+L.vertices.length)%L.vertices.length];d.rotate(p,T,C),d.rotate(f,N,C),ei(p,p,M),ei(f,f,M),ti(v,f,p),d.rotate90cw(m,v),d.normalize(m,m),ti(g,u,p);var j=ii(m,g);(V===P&&j<=h||V!==P&&j<=0)&&R++}if(R>=3){if(c)return!0;var G=this.createContactEquation(F,O,L,q);b++;T=L.vertices[P%L.vertices.length],N=L.vertices[(P+1)%L.vertices.length];d.rotate(p,T,C),d.rotate(f,N,C),ei(p,p,M),ei(f,f,M),ti(v,f,p),d.rotate90cw(G.normalA,v),d.normalize(G.normalA,G.normalA),ti(g,u,p);j=ii(G.normalA,g);d.scale(y,G.normalA,j),ti(G.contactPointA,u,M),ti(G.contactPointA,G.contactPointA,y),ei(G.contactPointA,G.contactPointA,M),ti(G.contactPointA,G.contactPointA,F.position),ti(G.contactPointB,u,x),ei(G.contactPointB,G.contactPointB,x),ti(G.contactPointB,G.contactPointB,O.position),this.contactEquations.push(G),this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(G))}}}return this.enableFrictionReduction&&this.enableFriction&&b&&this.frictionEquations.push(this.createFrictionFromAverage(b)),b};var Gi=d.fromValues(0,0);Pi.projectConvexOntoAxis=function(t,e,i,o,n){var r,s,a=null,c=null,h=Gi;d.rotate(h,o,-i);for(var l=0;l<t.vertices.length;l++)r=t.vertices[l],s=ii(r,h),(null===a||s>a)&&(a=s),(null===c||s<c)&&(c=s);if(c>a){var u=c;c=a,a=u}var p=ii(e,o);d.set(n,c+p,a+p)};var Di=d.fromValues(0,0),Ui=d.fromValues(0,0),zi=d.fromValues(0,0),Wi=d.fromValues(0,0),Xi=d.fromValues(0,0),Yi=d.fromValues(0,0);Pi.findSeparatingAxis=function(t,e,i,o,n,r,s){var a=null,c=!1,h=!1,l=Di,u=Ui,p=zi,f=Wi,v=Xi,y=Yi;if(t instanceof $e&&o instanceof $e)for(var g=0;2!==g;g++){var m=t,b=i;1===g&&(m=o,b=r);for(var A=0;2!==A;A++){0===A?d.set(f,0,1):1===A&&d.set(f,1,0),0!==b&&d.rotate(f,f,b),Pi.projectConvexOntoAxis(t,e,i,f,v),Pi.projectConvexOntoAxis(o,n,r,f,y);var E=v,w=y;v[0]>y[0]&&(w=v,E=y),c=(B=w[0]-E[1])<=0,(null===a||B>a)&&(d.copy(s,f),a=B,h=c)}}else for(g=0;2!==g;g++){m=t,b=i;1===g&&(m=o,b=r);for(A=0;A!==m.vertices.length;A++){d.rotate(u,m.vertices[A],b),d.rotate(p,m.vertices[(A+1)%m.vertices.length],b),ti(l,p,u),d.rotate90cw(f,l),d.normalize(f,f),Pi.projectConvexOntoAxis(t,e,i,f,v),Pi.projectConvexOntoAxis(o,n,r,f,y);var B;E=v,w=y;v[0]>y[0]&&(w=v,E=y),c=(B=w[0]-E[1])<=0,(null===a||B>a)&&(d.copy(s,f),a=B,h=c)}}return h};var Hi=d.fromValues(0,0),Ji=d.fromValues(0,0),Ki=d.fromValues(0,0);Pi.getClosestEdge=function(t,e,i,o){var n=Hi,r=Ji,s=Ki;d.rotate(n,i,-e),o&&d.scale(n,n,-1);for(var a=-1,c=t.vertices.length,h=-1,l=0;l!==c;l++){ti(r,t.vertices[(l+1)%c],t.vertices[l%c]),d.rotate90cw(s,r),d.normalize(s,s);var u=ii(s,n);(-1===a||u>h)&&(a=l%c,h=u)}return a};var Zi=d.create(),$i=d.create(),Qi=d.create(),to=d.create(),eo=d.create(),io=d.create(),oo=d.create();Pi.prototype[F.CIRCLE|F.HEIGHTFIELD]=Pi.prototype.circleHeightfield=function(t,e,i,o,n,r,s,a,c,h){var l=r.heights,u=(h=h||e.radius,r.elementWidth),p=$i,f=Zi,v=eo,y=oo,g=io,m=Qi,b=to,A=Math.floor((i[0]-h-s[0])/u),E=Math.ceil((i[0]+h-s[0])/u);A<0&&(A=0),E>=l.length&&(E=l.length-1);for(var w=l[A],B=l[E],P=A;P<E;P++)l[P]<B&&(B=l[P]),l[P]>w&&(w=l[P]);if(i[1]-h>w)return!c&&0;var S=!1;for(P=A;P<E;P++){d.set(m,P*u,l[P]),d.set(b,(P+1)*u,l[P+1]),d.add(m,m,s),d.add(b,b,s),d.sub(g,b,m),d.rotate(g,g,Math.PI/2),d.normalize(g,g),d.scale(f,g,-h),d.add(f,f,i),d.sub(p,f,m);var L=d.dot(p,g);if(f[0]>=m[0]&&f[0]<b[0]&&L<=0){if(c)return!0;S=!0,d.scale(p,g,-L),d.add(v,f,p),d.copy(y,g);var q=this.createContactEquation(n,t,r,e);d.copy(q.normalA,y),d.scale(q.contactPointB,q.normalA,-h),ei(q.contactPointB,q.contactPointB,i),ti(q.contactPointB,q.contactPointB,t.position),d.copy(q.contactPointA,v),d.sub(q.contactPointA,q.contactPointA,n.position),this.contactEquations.push(q),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(q))}}if(S=!1,h>0)for(P=A;P<=E;P++)if(d.set(m,P*u,l[P]),d.add(m,m,s),d.sub(p,i,m),d.squaredLength(p)<Math.pow(h,2)){if(c)return!0;S=!0;q=this.createContactEquation(n,t,r,e);d.copy(q.normalA,p),d.normalize(q.normalA,q.normalA),d.scale(q.contactPointB,q.normalA,-h),ei(q.contactPointB,q.contactPointB,i),ti(q.contactPointB,q.contactPointB,t.position),ti(q.contactPointA,m,s),ei(q.contactPointA,q.contactPointA,s),ti(q.contactPointA,q.contactPointA,n.position),this.contactEquations.push(q),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(q))}return S?1:0};var no=d.create(),ro=d.create(),so=d.create(),ao=new R({vertices:[d.create(),d.create(),d.create(),d.create()]});Pi.prototype[F.BOX|F.HEIGHTFIELD]=Pi.prototype[F.CONVEX|F.HEIGHTFIELD]=Pi.prototype.convexHeightfield=function(t,e,i,o,n,r,s,a,c){var h=r.heights,l=r.elementWidth,u=no,p=ro,f=so,v=ao,y=Math.floor((t.aabb.lowerBound[0]-s[0])/l),g=Math.ceil((t.aabb.upperBound[0]-s[0])/l);y<0&&(y=0),g>=h.length&&(g=h.length-1);for(var m=h[y],b=h[g],A=y;A<g;A++)h[A]<b&&(b=h[A]),h[A]>m&&(m=h[A]);if(t.aabb.lowerBound[1]>m)return!c&&0;var E=0;for(A=y;A<g;A++){d.set(u,A*l,h[A]),d.set(p,(A+1)*l,h[A+1]),d.add(u,u,s),d.add(p,p,s);d.set(f,.5*(p[0]+u[0]),.5*(p[1]+u[1]-100)),d.sub(v.vertices[0],p,f),d.sub(v.vertices[1],u,f),d.copy(v.vertices[2],v.vertices[1]),d.copy(v.vertices[3],v.vertices[0]),v.vertices[2][1]-=100,v.vertices[3][1]-=100,E+=this.convexConvex(t,e,i,o,n,v,f,0,c)}return E};var co=ho;function ho(t){(t=t||{}).type=F.PLANE,F.call(this,t)}ho.prototype=new F,ho.prototype.constructor=ho,ho.prototype.computeMomentOfInertia=function(t){return 0},ho.prototype.updateBoundingRadius=function(){this.boundingRadius=Number.MAX_VALUE},ho.prototype.computeAABB=function(t,e,i){var o=i%(2*Math.PI),n=d.set,r=t.lowerBound,s=t.upperBound;n(r,-1e7,-1e7),n(s,1e7,1e7),0===o?s[1]=0:o===Math.PI/2?r[0]=0:o===Math.PI?r[1]=0:o===3*Math.PI/2&&(s[0]=0)},ho.prototype.updateArea=function(){this.area=Number.MAX_VALUE};var lo=d.create(),uo=(d.create(),d.create(),d.create()),po=d.create();ho.prototype.raycast=function(t,e,i,o){var n=e.from,r=e.to,s=e.direction,a=lo,c=uo,h=po;d.set(c,0,1),d.rotate(c,c,o),d.sub(h,n,i);var l=d.dot(h,c);if(d.sub(h,r,i),!(l*d.dot(h,c)>0||d.squaredDistance(n,r)<l*l)){var u=d.dot(c,s);d.sub(a,n,i);var p=-d.dot(c,a)/u/e.length;e.reportIntersection(t,p,c,-1)}};var fo=vo;function vo(t){(t=t||{}).type=F.PARTICLE,F.call(this,t)}vo.prototype=new F,vo.prototype.constructor=vo,vo.prototype.computeMomentOfInertia=function(t){return 0},vo.prototype.updateBoundingRadius=function(){this.boundingRadius=0},vo.prototype.computeAABB=function(t,e,i){d.copy(t.lowerBound,e),d.copy(t.upperBound,e)};var yo=go;function go(){Rt.call(this,Rt.NAIVE)}go.prototype=new Rt,go.prototype.constructor=go,go.prototype.getCollisionPairs=function(t){var e=t.bodies,i=this.result;i.length=0;for(var o=0,n=e.length;o!==n;o++)for(var r=e[o],s=0;s<o;s++){var a=e[s];Rt.canCollide(r,a)&&this.boundingVolumeCheck(r,a)&&i.push(r,a)}return i},go.prototype.aabbQuery=function(t,e,i){i=i||[];for(var o=t.bodies,n=0;n<o.length;n++){var r=o[n];r.aabbNeedsUpdate&&r.updateAABB(),r.aabb.overlaps(e)&&i.push(r)}return i};var mo=bo;function bo(t,e){St.call(this,t,e,-Number.MAX_VALUE,Number.MAX_VALUE),this.relativeVelocity=1,this.ratio=1}bo.prototype=new St,bo.prototype.constructor=bo,bo.prototype.computeB=function(t,e,i){var o=this.G;o[2]=-1,o[5]=this.ratio;var n=this.computeGiMf();return-this.computeGW()*e-i*n};var Ao=Eo;function Eo(t,e,i){i=i||{},St.call(this,t,e,-Number.MAX_VALUE,Number.MAX_VALUE),this.angle=i.angle||0;var o=this.G;o[2]=1,o[5]=-1}Eo.prototype=new St,Eo.prototype.constructor=Eo;var wo=d.create(),Bo=d.create(),Po=d.fromValues(1,0),So=d.fromValues(0,1);Eo.prototype.computeGq=function(){return d.rotate(wo,Po,this.bodyA.angle+this.angle),d.rotate(Bo,So,this.bodyB.angle),d.dot(wo,Bo)};var Lo=Fo,qo=d.create(),Mo=d.create(),xo=d.fromValues(1,0),Co=d.fromValues(0,1),_o=d.create();function Fo(t,e,i){i=i||{},Zt.call(this,t,e,Zt.REVOLUTE,i);var o=this.maxForce=void 0!==i.maxForce?i.maxForce:Number.MAX_VALUE;this.pivotA=d.create(),this.pivotB=d.create(),i.worldPivot?(d.sub(this.pivotA,i.worldPivot,t.position),d.sub(this.pivotB,i.worldPivot,e.position),d.rotate(this.pivotA,this.pivotA,-t.angle),d.rotate(this.pivotB,this.pivotB,-e.angle)):(d.copy(this.pivotA,i.localPivotA),d.copy(this.pivotB,i.localPivotB));var n=this.equations=[new St(t,e,-o,o),new St(t,e,-o,o)],r=n[0],s=n[1],a=this;r.computeGq=function(){return d.rotate(qo,a.pivotA,t.angle),d.rotate(Mo,a.pivotB,e.angle),d.add(_o,e.position,Mo),d.sub(_o,_o,t.position),d.sub(_o,_o,qo),d.dot(_o,xo)},s.computeGq=function(){return d.rotate(qo,a.pivotA,t.angle),d.rotate(Mo,a.pivotB,e.angle),d.add(_o,e.position,Mo),d.sub(_o,_o,t.position),d.sub(_o,_o,qo),d.dot(_o,Co)},s.minForce=r.minForce=-o,s.maxForce=r.maxForce=o,this.motorEquation=new mo(t,e),this.motorEnabled=!1,this.angle=0,this.lowerLimitEnabled=!1,this.upperLimitEnabled=!1,this.lowerLimit=0,this.upperLimit=0,this.upperLimitEquation=new Ao(t,e),this.lowerLimitEquation=new Ao(t,e),this.upperLimitEquation.minForce=0,this.lowerLimitEquation.maxForce=0}Fo.prototype=new Zt,Fo.prototype.constructor=Fo,Fo.prototype.setLimits=function(t,e){"number"==typeof t?(this.lowerLimit=t,this.lowerLimitEnabled=!0):(this.lowerLimit=t,this.lowerLimitEnabled=!1),"number"==typeof e?(this.upperLimit=e,this.upperLimitEnabled=!0):(this.upperLimit=e,this.upperLimitEnabled=!1)},Fo.prototype.update=function(){var t,e=this.bodyA,i=this.bodyB,o=this.pivotA,n=this.pivotB,r=this.equations,s=(r[0],r[1],r[0]),a=r[1],c=this.upperLimit,h=this.lowerLimit,l=this.upperLimitEquation,u=this.lowerLimitEquation,p=this.angle=i.angle-e.angle;this.upperLimitEnabled&&p>c?(l.angle=c,-1===r.indexOf(l)&&r.push(l)):-1!==(t=r.indexOf(l))&&r.splice(t,1);this.lowerLimitEnabled&&p<h?(u.angle=h,-1===r.indexOf(u)&&r.push(u)):-1!==(t=r.indexOf(u))&&r.splice(t,1);d.rotate(qo,o,e.angle),d.rotate(Mo,n,i.angle),s.G[0]=-1,s.G[1]=0,s.G[2]=-d.crossLength(qo,xo),s.G[3]=1,s.G[4]=0,s.G[5]=d.crossLength(Mo,xo),a.G[0]=0,a.G[1]=-1,a.G[2]=-d.crossLength(qo,Co),a.G[3]=0,a.G[4]=1,a.G[5]=d.crossLength(Mo,Co)},Fo.prototype.enableMotor=function(){this.motorEnabled||(this.equations.push(this.motorEquation),this.motorEnabled=!0)},Fo.prototype.disableMotor=function(){if(this.motorEnabled){var t=this.equations.indexOf(this.motorEquation);this.equations.splice(t,1),this.motorEnabled=!1}},Fo.prototype.motorIsEnabled=function(){return!!this.motorEnabled},Fo.prototype.setMotorSpeed=function(t){if(this.motorEnabled){var e=this.equations.indexOf(this.motorEquation);this.equations[e].relativeVelocity=t}},Fo.prototype.getMotorSpeed=function(){return!!this.motorEnabled&&this.motorEquation.relativeVelocity};var Oo=Io;function Io(t,e,i){i=i||{},Zt.call(this,t,e,Zt.PRISMATIC,i);var o=d.fromValues(0,0),n=d.fromValues(1,0),r=d.fromValues(0,0);i.localAnchorA&&d.copy(o,i.localAnchorA),i.localAxisA&&d.copy(n,i.localAxisA),i.localAnchorB&&d.copy(r,i.localAnchorB),this.localAnchorA=o,this.localAnchorB=r,this.localAxisA=n;var s=this.maxForce=void 0!==i.maxForce?i.maxForce:Number.MAX_VALUE,a=new St(t,e,-s,s),c=new d.create,h=new d.create,l=new d.create,u=new d.create;if(a.computeGq=function(){return d.dot(l,u)},a.updateJacobian=function(){var i=this.G,s=t.position,a=e.position;d.rotate(c,o,t.angle),d.rotate(h,r,e.angle),d.add(l,a,h),d.sub(l,l,s),d.sub(l,l,c),d.rotate(u,n,t.angle+Math.PI/2),i[0]=-u[0],i[1]=-u[1],i[2]=-d.crossLength(c,u)+d.crossLength(u,l),i[3]=u[0],i[4]=u[1],i[5]=d.crossLength(h,u)},this.equations.push(a),!i.disableRotationalLock){var p=new Ao(t,e,-s,s);this.equations.push(p)}this.position=0,this.velocity=0,this.lowerLimitEnabled=void 0!==i.lowerLimit,this.upperLimitEnabled=void 0!==i.upperLimit,this.lowerLimit=void 0!==i.lowerLimit?i.lowerLimit:0,this.upperLimit=void 0!==i.upperLimit?i.upperLimit:1,this.upperLimitEquation=new Qt(t,e),this.lowerLimitEquation=new Qt(t,e),this.upperLimitEquation.minForce=this.lowerLimitEquation.minForce=0,this.upperLimitEquation.maxForce=this.lowerLimitEquation.maxForce=s,this.motorEquation=new St(t,e),this.motorEnabled=!1,this.motorSpeed=0;var f=this,v=this.motorEquation;v.computeGW;v.computeGq=function(){return 0},v.computeGW=function(){var t=this.G,e=this.bodyA,i=this.bodyB,o=e.velocity,n=i.velocity,r=e.angularVelocity,s=i.angularVelocity;return this.gmult(t,o,r,n,s)+f.motorSpeed}}Io.prototype=new Zt,Io.prototype.constructor=Io;var ko=d.create(),Ro=d.create(),Vo=d.create(),To=d.create(),No=d.create(),jo=d.create();Io.prototype.update=function(){var t=this.equations,e=t[0],i=this.upperLimit,o=this.lowerLimit,n=this.upperLimitEquation,r=this.lowerLimitEquation,s=this.bodyA,a=this.bodyB,c=this.localAxisA,h=this.localAnchorA,l=this.localAnchorB;e.updateJacobian(),d.rotate(ko,c,s.angle),d.rotate(To,h,s.angle),d.add(Ro,To,s.position),d.rotate(No,l,a.angle),d.add(Vo,No,a.position);var u,p=this.position=d.dot(Vo,ko)-d.dot(Ro,ko);if(this.motorEnabled){var f=this.motorEquation.G;f[0]=ko[0],f[1]=ko[1],f[2]=d.crossLength(ko,No),f[3]=-ko[0],f[4]=-ko[1],f[5]=-d.crossLength(ko,To)}this.upperLimitEnabled&&p>i?(d.scale(n.normalA,ko,-1),d.sub(n.contactPointA,Ro,s.position),d.sub(n.contactPointB,Vo,a.position),d.scale(jo,ko,i),d.add(n.contactPointA,n.contactPointA,jo),-1===t.indexOf(n)&&t.push(n)):-1!==(u=t.indexOf(n))&&t.splice(u,1);this.lowerLimitEnabled&&p<o?(d.scale(r.normalA,ko,1),d.sub(r.contactPointA,Ro,s.position),d.sub(r.contactPointB,Vo,a.position),d.scale(jo,ko,o),d.sub(r.contactPointB,r.contactPointB,jo),-1===t.indexOf(r)&&t.push(r)):-1!==(u=t.indexOf(r))&&t.splice(u,1)},Io.prototype.enableMotor=function(){this.motorEnabled||(this.equations.push(this.motorEquation),this.motorEnabled=!0)},Io.prototype.disableMotor=function(){if(this.motorEnabled){var t=this.equations.indexOf(this.motorEquation);this.equations.splice(t,1),this.motorEnabled=!1}},Io.prototype.setLimits=function(t,e){"number"==typeof t?(this.lowerLimit=t,this.lowerLimitEnabled=!0):(this.lowerLimit=t,this.lowerLimitEnabled=!1),"number"==typeof e?(this.upperLimit=e,this.upperLimitEnabled=!0):(this.upperLimit=e,this.upperLimitEnabled=!1)};var Go=Do;function Do(){Rt.call(this,Rt.SAP),this.axisList=[],this.axisIndex=0;var t=this;this._addBodyHandler=function(e){t.axisList.push(e.body)},this._removeBodyHandler=function(e){var i=t.axisList.indexOf(e.body);-1!==i&&t.axisList.splice(i,1)}}Do.prototype=new Rt,Do.prototype.constructor=Do,Do.prototype.setWorld=function(t){this.axisList.length=0,p.appendArray(this.axisList,t.bodies),t.off("addBody",this._addBodyHandler).off("removeBody",this._removeBodyHandler),t.on("addBody",this._addBodyHandler).on("removeBody",this._removeBodyHandler),this.world=t},Do.sortAxisList=function(t,e){e|=0;for(var i=1,o=t.length;i<o;i++){for(var n=t[i],r=i-1;r>=0&&!(t[r].aabb.lowerBound[e]<=n.aabb.lowerBound[e]);r--)t[r+1]=t[r];t[r+1]=n}return t},Do.prototype.sortList=function(){var t=this.axisList,e=this.axisIndex;Do.sortAxisList(t,e)},Do.prototype.getCollisionPairs=function(t){var e=this.axisList,i=this.result,o=this.axisIndex;i.length=0;for(var n=e.length;n--;){var r=e[n];r.aabbNeedsUpdate&&r.updateAABB()}this.sortList();for(var s=0,a=0|e.length;s!==a;s++)for(var c=e[s],h=s+1;h<a;h++){var l=e[h];if(!(l.aabb.lowerBound[o]<=c.aabb.upperBound[o]))break;Rt.canCollide(c,l)&&this.boundingVolumeCheck(c,l)&&i.push(c,l)}return i},Do.prototype.aabbQuery=function(t,e,i){i=i||[],this.sortList();var o=this.axisIndex,n="x";1===o&&(n="y"),2===o&&(n="z");for(var r=this.axisList,s=(e.lowerBound[n],e.upperBound[n],0);s<r.length;s++){var a=r[s];a.aabbNeedsUpdate&&a.updateAABB(),a.aabb.overlaps(e)&&i.push(a)}return i};var Uo=zo;function zo(t,e,i){i=p.defaults(i,{stiffness:100,damping:1}),this.stiffness=i.stiffness,this.damping=i.damping,this.bodyA=t,this.bodyB=e}zo.prototype.applyForce=function(){};var Wo=Xo;function Xo(t,e){e=e||{},this.chassisBody=t,this.wheels=[],this.groundBody=new ot({mass:0}),this.world=null;var i=this;this.preStepCallback=function(){i.update()}}function Yo(t,e){e=e||{},this.vehicle=t,this.forwardEquation=new ge(t.chassisBody,t.groundBody),this.sideEquation=new ge(t.chassisBody,t.groundBody),this.steerValue=0,this.engineForce=0,this.setSideFriction(void 0!==e.sideFriction?e.sideFriction:5),this.localForwardVector=d.fromValues(0,1),e.localForwardVector&&d.copy(this.localForwardVector,e.localForwardVector),this.localPosition=d.fromValues(0,0),e.localPosition&&d.copy(this.localPosition,e.localPosition),Zt.apply(this,t.chassisBody,t.groundBody),this.equations.push(this.forwardEquation,this.sideEquation),this.setBrakeForce(0)}Xo.prototype.addToWorld=function(t){this.world=t,t.addBody(this.groundBody),t.on("preStep",this.preStepCallback);for(var e=0;e<this.wheels.length;e++){var i=this.wheels[e];t.addConstraint(i)}},Xo.prototype.removeFromWorld=function(){var t=this.world;t.removeBody(this.groundBody),t.off("preStep",this.preStepCallback);for(var e=0;e<this.wheels.length;e++){var i=this.wheels[e];t.removeConstraint(i)}this.world=null},Xo.prototype.addWheel=function(t){var e=new Yo(this,t);return this.wheels.push(e),e},Xo.prototype.update=function(){for(var t=0;t<this.wheels.length;t++)this.wheels[t].update()},Yo.prototype=new Zt,Yo.prototype.setBrakeForce=function(t){this.forwardEquation.setSlipForce(t)},Yo.prototype.setSideFriction=function(t){this.sideEquation.setSlipForce(t)};var Ho=d.create(),Jo=d.create();Yo.prototype.getSpeed=function(){return this.vehicle.chassisBody.vectorToWorldFrame(Jo,this.localForwardVector),this.vehicle.chassisBody.getVelocityAtPoint(Ho,Jo),d.dot(Ho,Jo)};var Ko=d.create();Yo.prototype.update=function(){this.vehicle.chassisBody.vectorToWorldFrame(this.forwardEquation.t,this.localForwardVector),d.rotate(this.sideEquation.t,this.localForwardVector,Math.PI/2),this.vehicle.chassisBody.vectorToWorldFrame(this.sideEquation.t,this.sideEquation.t),d.rotate(this.forwardEquation.t,this.forwardEquation.t,this.steerValue),d.rotate(this.sideEquation.t,this.sideEquation.t,this.steerValue),this.vehicle.chassisBody.toWorldFrame(this.forwardEquation.contactPointB,this.localPosition),d.copy(this.sideEquation.contactPointB,this.forwardEquation.contactPointB),this.vehicle.chassisBody.vectorToWorldFrame(this.forwardEquation.contactPointA,this.localPosition),d.copy(this.sideEquation.contactPointA,this.forwardEquation.contactPointA),d.normalize(Ko,this.forwardEquation.t),d.scale(Ko,Ko,this.engineForce),this.vehicle.chassisBody.applyForce(Ko,this.forwardEquation.contactPointA)};var Zo=$o;function $o(t,e,i){i=i||{},Uo.call(this,t,e,i),this.localAnchorA=d.fromValues(0,0),this.localAnchorB=d.fromValues(0,0),i.localAnchorA&&d.copy(this.localAnchorA,i.localAnchorA),i.localAnchorB&&d.copy(this.localAnchorB,i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB);var o=d.create(),n=d.create();this.getWorldAnchorA(o),this.getWorldAnchorB(n);var r=d.distance(o,n);this.restLength="number"==typeof i.restLength?i.restLength:r}$o.prototype=new Uo,$o.prototype.constructor=$o,$o.prototype.setWorldAnchorA=function(t){this.bodyA.toLocalFrame(this.localAnchorA,t)},$o.prototype.setWorldAnchorB=function(t){this.bodyB.toLocalFrame(this.localAnchorB,t)},$o.prototype.getWorldAnchorA=function(t){this.bodyA.toWorldFrame(t,this.localAnchorA)},$o.prototype.getWorldAnchorB=function(t){this.bodyB.toWorldFrame(t,this.localAnchorB)};var Qo=d.create(),tn=d.create(),en=d.create(),on=d.create(),nn=d.create(),rn=d.create(),sn=d.create(),an=d.create(),cn=d.create();$o.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,i=this.restLength,o=this.bodyA,n=this.bodyB,r=Qo,s=tn,a=en,c=on,h=cn,l=nn,u=rn,p=sn,f=an;this.getWorldAnchorA(l),this.getWorldAnchorB(u),d.sub(p,l,o.position),d.sub(f,u,n.position),d.sub(r,u,l);var v=d.len(r);d.normalize(s,r),d.sub(a,n.velocity,o.velocity),d.crossZV(h,n.angularVelocity,f),d.add(a,a,h),d.crossZV(h,o.angularVelocity,p),d.sub(a,a,h),d.scale(c,s,-t*(v-i)-e*d.dot(a,s)),d.sub(o.force,o.force,c),d.add(n.force,n.force,c);var y=d.crossLength(p,c),g=d.crossLength(f,c);o.angularForce-=y,n.angularForce+=g};var hn=ln;function ln(t,e,i){i=i||{},Uo.call(this,t,e,i),this.restAngle="number"==typeof i.restAngle?i.restAngle:e.angle-t.angle}ln.prototype=new Uo,ln.prototype.constructor=ln,ln.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,i=this.restAngle,o=this.bodyA,n=this.bodyB,r=-t*(n.angle-o.angle-i)-e*(n.angularVelocity-o.angularVelocity)*0;o.angularForce-=r,n.angularForce+=r};var un=[["p2@0.7.1","/home/circleci/repo"]],pn="sha1-JfJHTZvDptMUCh2iamfJ4RislUM=",fn={},dn={type:"version",registry:!0,raw:"p2@0.7.1",name:"p2",escapedName:"p2",rawSpec:"0.7.1",saveSpec:null,fetchSpec:"0.7.1"},vn=["/"],yn="https://registry.npmjs.org/p2/-/p2-0.7.1.tgz",gn="/home/circleci/repo",mn={name:"Stefan Hedman",email:"schteppe@gmail.com",url:"http://steffe.se"},bn={url:"https://github.com/schteppe/p2.js/issues"},An={"poly-decomp":"0.1.1"},En={grunt:"^0.4.5","grunt-browserify":"~2.0.1","grunt-contrib-concat":"^0.4.0","grunt-contrib-jshint":"^0.11.2","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-uglify":"~0.4.0","grunt-contrib-watch":"~0.5.0"},wn={node:"*"},Bn="https://github.com/schteppe/p2.js#readme",Pn=["p2.js","p2","physics","engine","2d"],Sn=[{type:"MIT"}],Ln={type:"git",url:"git+https://github.com/schteppe/p2.js.git"},qn={_args:un,_from:"p2@0.7.1",_id:"p2@0.7.1",_inBundle:!1,_integrity:pn,_location:"/p2",_phantomChildren:fn,_requested:dn,_requiredBy:vn,_resolved:yn,_spec:"0.7.1",_where:gn,author:mn,bugs:bn,dependencies:An,description:"A JavaScript 2D physics engine.",devDependencies:En,engines:wn,homepage:Bn,keywords:Pn,licenses:Sn,main:"./src/p2.js",name:"p2",repository:Ln,version:"0.7.1"},Mn=Object.freeze({_args:un,_from:"p2@0.7.1",_id:"p2@0.7.1",_inBundle:!1,_integrity:pn,_location:"/p2",_phantomChildren:fn,_requested:dn,_requiredBy:vn,_resolved:yn,_spec:"0.7.1",_where:gn,author:mn,bugs:bn,dependencies:An,description:"A JavaScript 2D physics engine.",devDependencies:En,engines:wn,homepage:Bn,keywords:Pn,licenses:Sn,main:"./src/p2.js",name:"p2",repository:Ln,version:"0.7.1",default:qn}),xn=Cn;function Cn(t,e,i,o){this.shapeA=e,this.shapeB=o,this.bodyA=t,this.bodyB=i}Cn.prototype.set=function(t,e,i,o){Cn.call(this,t,e,i,o)};var _n=Fn;function Fn(){ne.apply(this,arguments)}Fn.prototype=new ne,Fn.prototype.constructor=Fn,Fn.prototype.create=function(){return new xn},Fn.prototype.destroy=function(t){return t.bodyA=t.bodyB=t.shapeA=t.shapeB=null,this};var On=In;function In(){this.overlappingShapesLastState=new Ke,this.overlappingShapesCurrentState=new Ke,this.recordPool=new _n({size:16}),this.tmpDict=new Ke,this.tmpArray1=[]}In.prototype.tick=function(){for(var t=this.overlappingShapesLastState,e=this.overlappingShapesCurrentState,i=t.keys.length;i--;){var o=t.keys[i],n=t.getByKey(o);e.getByKey(o);n&&this.recordPool.release(n)}t.reset(),t.copy(e),e.reset()},In.prototype.setOverlapping=function(t,e,i,o){this.overlappingShapesLastState;var n=this.overlappingShapesCurrentState;if(!n.get(e.id,o.id)){var r=this.recordPool.get();r.set(t,e,i,o),n.set(e.id,o.id,r)}},In.prototype.getNewOverlaps=function(t){return this.getDiff(this.overlappingShapesLastState,this.overlappingShapesCurrentState,t)},In.prototype.getEndOverlaps=function(t){return this.getDiff(this.overlappingShapesCurrentState,this.overlappingShapesLastState,t)},In.prototype.bodiesAreOverlapping=function(t,e){for(var i=this.overlappingShapesCurrentState,o=i.keys.length;o--;){var n=i.keys[o],r=i.data[n];if(r.bodyA===t&&r.bodyB===e||r.bodyA===e&&r.bodyB===t)return!0}return!1},In.prototype.getDiff=function(t,e,i){var o=t,n=e;(i=i||[]).length=0;for(var r=n.keys.length;r--;){var s=n.keys[r],a=n.data[s];if(!a)throw new Error("Key "+s+" had no data!");o.data[s]||i.push(a)}return i},In.prototype.isNewOverlap=function(t,e){var i=0|t.id,o=0|e.id,n=this.overlappingShapesLastState,r=this.overlappingShapesCurrentState;return!n.get(i,o)&&!!r.get(i,o)},In.prototype.getNewBodyOverlaps=function(t){this.tmpArray1.length=0;var e=this.getNewOverlaps(this.tmpArray1);return this.getBodyDiff(e,t)},In.prototype.getEndBodyOverlaps=function(t){this.tmpArray1.length=0;var e=this.getEndOverlaps(this.tmpArray1);return this.getBodyDiff(e,t)},In.prototype.getBodyDiff=function(t,e){e=e||[];for(var i=this.tmpDict,o=t.length;o--;){var n=t[o];i.set(0|n.bodyA.id,0|n.bodyB.id,n)}for(o=i.keys.length;o--;){(n=i.getByKey(i.keys[o]))&&e.push(n.bodyA,n.bodyB)}return i.reset(),e};var kn=Rn;function Rn(){this.equations=[],this.bodies=[]}Rn.prototype.reset=function(){this.equations.length=this.bodies.length=0};var Vn=[];Rn.prototype.getBodies=function(t){var e=t||[],i=this.equations;Vn.length=0;for(var o=0;o!==i.length;o++){var n=i[o];-1===Vn.indexOf(n.bodyA.id)&&(e.push(n.bodyA),Vn.push(n.bodyA.id)),-1===Vn.indexOf(n.bodyB.id)&&(e.push(n.bodyB),Vn.push(n.bodyB.id))}return e},Rn.prototype.wantsToSleep=function(){for(var t=0;t<this.bodies.length;t++){var e=this.bodies[t];if(e.type===ot.DYNAMIC&&!e.wantsToSleep)return!1}return!0},Rn.prototype.sleep=function(){for(var t=0;t<this.bodies.length;t++){this.bodies[t].sleep()}return!0};var Tn=Nn;function Nn(t){this.body=t,this.neighbors=[],this.equations=[],this.visited=!1}Nn.prototype.reset=function(){this.equations.length=0,this.neighbors.length=0,this.visited=!1,this.body=null};var jn=Gn;function Gn(){ne.apply(this,arguments)}Gn.prototype=new ne,Gn.prototype.constructor=Gn,Gn.prototype.create=function(){return new Tn},Gn.prototype.destroy=function(t){return t.reset(),this};var Dn=Un;function Un(){ne.apply(this,arguments)}Un.prototype=new ne,Un.prototype.constructor=Un,Un.prototype.create=function(){return new kn},Un.prototype.destroy=function(t){return t.reset(),this};var zn=Wn;function Wn(t){this.nodePool=new jn({size:16}),this.islandPool=new Dn({size:8}),this.equations=[],this.islands=[],this.nodes=[],this.queue=[]}Wn.getUnvisitedNode=function(t){for(var e=t.length,i=0;i!==e;i++){var o=t[i];if(!o.visited&&o.body.type===ot.DYNAMIC)return o}return!1},Wn.prototype.visit=function(t,e,i){e.push(t.body);for(var o=t.equations.length,n=0;n!==o;n++){var r=t.equations[n];-1===i.indexOf(r)&&i.push(r)}},Wn.prototype.bfs=function(t,e,i){var o=this.queue;for(o.length=0,o.push(t),t.visited=!0,this.visit(t,e,i);o.length;)for(var n,r=o.pop();n=Wn.getUnvisitedNode(r.neighbors);)n.visited=!0,this.visit(n,e,i),n.body.type===ot.DYNAMIC&&o.push(n)},Wn.prototype.split=function(t){for(var e=t.bodies,i=this.nodes,o=this.equations;i.length;)this.nodePool.release(i.pop());for(var n=0;n!==e.length;n++){var r=this.nodePool.get();r.body=e[n],i.push(r)}for(var s=0;s!==o.length;s++){var a=o[s],c=(n=e.indexOf(a.bodyA),e.indexOf(a.bodyB)),h=i[n],l=i[c];h.neighbors.push(l),l.neighbors.push(h),h.equations.push(a),l.equations.push(a)}var u,p=this.islands;for(n=0;n<p.length;n++)this.islandPool.release(p[n]);for(p.length=0;u=Wn.getUnvisitedNode(i);){var f=this.islandPool.get();this.bfs(u,f.bodies,f.equations),p.push(f)}return p};var Xn=Mn&&qn||Mn,Yn=Hn;function Hn(t){it.apply(this),t=t||{},this.springs=[],this.bodies=[],this.disabledBodyCollisionPairs=[],this.solver=t.solver||new Le,this.narrowphase=new oi(this),this.islandManager=new zn,this.gravity=d.fromValues(0,-9.78),t.gravity&&d.copy(this.gravity,t.gravity),this.frictionGravity=d.length(this.gravity)||10,this.useWorldGravityAsFrictionGravity=!0,this.useFrictionGravityOnZeroGravity=!0,this.broadphase=t.broadphase||new Go,this.broadphase.setWorld(this),this.constraints=[],this.defaultMaterial=new ce,this.defaultContactMaterial=new le(this.defaultMaterial,this.defaultMaterial),this.lastTimeStep=1/60,this.applySpringForces=!0,this.applyDamping=!0,this.applyGravity=!0,this.solveConstraints=!0,this.contactMaterials=[],this.time=0,this.accumulator=0,this.stepping=!1,this.bodiesToBeRemoved=[],this.islandSplit=void 0===t.islandSplit||!!t.islandSplit,this.emitImpactEvent=!0,this._constraintIdCounter=0,this._bodyIdCounter=0,this.postStepEvent={type:"postStep"},this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.addSpringEvent={type:"addSpring",spring:null},this.impactEvent={type:"impact",bodyA:null,bodyB:null,shapeA:null,shapeB:null,contactEquation:null},this.postBroadphaseEvent={type:"postBroadphase",pairs:null},this.sleepMode=Hn.NO_SLEEPING,this.beginContactEvent={type:"beginContact",shapeA:null,shapeB:null,bodyA:null,bodyB:null,contactEquations:[]},this.endContactEvent={type:"endContact",shapeA:null,shapeB:null,bodyA:null,bodyB:null},this.preSolveEvent={type:"preSolve",contactEquations:null,frictionEquations:null},this.overlappingShapesLastState={keys:[]},this.overlappingShapesCurrentState={keys:[]},this.overlapKeeper=new On}Hn.prototype=new Object(it.prototype),Hn.prototype.constructor=Hn,Hn.NO_SLEEPING=1,Hn.BODY_SLEEPING=2,Hn.ISLAND_SLEEPING=4,Hn.prototype.addConstraint=function(t){this.constraints.push(t)},Hn.prototype.addContactMaterial=function(t){this.contactMaterials.push(t)},Hn.prototype.removeContactMaterial=function(t){var e=this.contactMaterials.indexOf(t);-1!==e&&p.splice(this.contactMaterials,e,1)},Hn.prototype.getContactMaterial=function(t,e){for(var i=this.contactMaterials,o=0,n=i.length;o!==n;o++){var r=i[o];if(r.materialA.id===t.id&&r.materialB.id===e.id||r.materialA.id===e.id&&r.materialB.id===t.id)return r}return!1},Hn.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&p.splice(this.constraints,e,1)};d.create(),d.create(),d.create(),d.create(),d.create(),d.create();var Jn=d.create(),Kn=d.fromValues(0,0),Zn=d.fromValues(0,0);d.fromValues(0,0),d.fromValues(0,0);Hn.prototype.step=function(t,e,i){if(i=i||10,0===(e=e||0))this.internalStep(t),this.time+=t;else{this.accumulator+=e;for(var o=0;this.accumulator>=t&&o<i;)this.internalStep(t),this.time+=t,this.accumulator-=t,o++;for(var n=this.accumulator%t/t,r=0;r!==this.bodies.length;r++){var s=this.bodies[r];d.lerp(s.interpolatedPosition,s.previousPosition,s.position,n),s.interpolatedAngle=s.previousAngle+n*(s.angle-s.previousAngle)}}};var $n=[];Hn.prototype.internalStep=function(t){this.stepping=!0;var e=this.springs.length,i=this.springs,o=this.bodies,n=this.gravity,r=this.solver,s=this.bodies.length,a=this.broadphase,c=this.narrowphase,h=this.constraints,l=Jn,u=(d.scale,d.add),f=(d.rotate,this.islandManager);if(this.overlapKeeper.tick(),this.lastTimeStep=t,this.useWorldGravityAsFrictionGravity){var v=d.length(this.gravity);0===v&&this.useFrictionGravityOnZeroGravity||(this.frictionGravity=v)}if(this.applyGravity)for(var y=0;y!==s;y++){var g=(m=o[y]).force;m.type===ot.DYNAMIC&&m.sleepState!==ot.SLEEPING&&(d.scale(l,n,m.mass*m.gravityScale),u(g,g,l))}if(this.applySpringForces)for(y=0;y!==e;y++){i[y].applyForce()}if(this.applyDamping)for(y=0;y!==s;y++){var m;(m=o[y]).type===ot.DYNAMIC&&m.applyDamping(t)}var b=a.getCollisionPairs(this),A=this.disabledBodyCollisionPairs;for(y=A.length-2;y>=0;y-=2)for(var E=b.length-2;E>=0;E-=2)(A[y]===b[E]&&A[y+1]===b[E+1]||A[y+1]===b[E]&&A[y]===b[E+1])&&b.splice(E,2);var w=h.length;for(y=0;y!==w;y++){var B=h[y];if(!B.collideConnected)for(E=b.length-2;E>=0;E-=2)(B.bodyA===b[E]&&B.bodyB===b[E+1]||B.bodyB===b[E]&&B.bodyA===b[E+1])&&b.splice(E,2)}this.postBroadphaseEvent.pairs=b,this.emit(this.postBroadphaseEvent),this.postBroadphaseEvent.pairs=null,c.reset(this);y=0;for(var P=b.length;y!==P;y+=2)for(var S=b[y],L=b[y+1],q=0,M=S.shapes.length;q!==M;q++)for(var x=S.shapes[q],C=x.position,_=x.angle,F=0,O=L.shapes.length;F!==O;F++){var I=L.shapes[F],k=I.position,R=I.angle,V=this.defaultContactMaterial;if(x.material&&I.material){var T=this.getContactMaterial(x.material,I.material);T&&(V=T)}this.runNarrowphase(c,S,x,C,_,L,I,k,R,V,this.frictionGravity)}for(y=0;y!==s;y++){(D=o[y])._wakeUpAfterNarrowphase&&(D.wakeUp(),D._wakeUpAfterNarrowphase=!1)}if(this.has("endContact")){this.overlapKeeper.getEndOverlaps($n);var N=this.endContactEvent;for(F=$n.length;F--;){var j=$n[F];N.shapeA=j.shapeA,N.shapeB=j.shapeB,N.bodyA=j.bodyA,N.bodyB=j.bodyB,this.emit(N)}$n.length=0}var G=this.preSolveEvent;G.contactEquations=c.contactEquations,G.frictionEquations=c.frictionEquations,this.emit(G),G.contactEquations=G.frictionEquations=null;w=h.length;for(y=0;y!==w;y++)h[y].update();if(c.contactEquations.length||c.frictionEquations.length||w)if(this.islandSplit){for(f.equations.length=0,p.appendArray(f.equations,c.contactEquations),p.appendArray(f.equations,c.frictionEquations),y=0;y!==w;y++)p.appendArray(f.equations,h[y].equations);f.split(this);for(y=0;y!==f.islands.length;y++){(W=f.islands[y]).equations.length&&r.solveIsland(t,W)}}else{for(r.addEquations(c.contactEquations),r.addEquations(c.frictionEquations),y=0;y!==w;y++)r.addEquations(h[y].equations);this.solveConstraints&&r.solve(t,this),r.removeAllEquations()}for(y=0;y!==s;y++){var D;(D=o[y]).integrate(t)}for(y=0;y!==s;y++)o[y].setZeroForce();if(this.emitImpactEvent&&this.has("impact")){var U=this.impactEvent;for(y=0;y!==c.contactEquations.length;y++){var z=c.contactEquations[y];z.firstImpact&&(U.bodyA=z.bodyA,U.bodyB=z.bodyB,U.shapeA=z.shapeA,U.shapeB=z.shapeB,U.contactEquation=z,this.emit(U))}}if(this.sleepMode===Hn.BODY_SLEEPING)for(y=0;y!==s;y++)o[y].sleepTick(this.time,!1,t);else if(this.sleepMode===Hn.ISLAND_SLEEPING&&this.islandSplit){for(y=0;y!==s;y++)o[y].sleepTick(this.time,!0,t);for(y=0;y<this.islandManager.islands.length;y++){var W;(W=this.islandManager.islands[y]).wantsToSleep()&&W.sleep()}}this.stepping=!1;var X=this.bodiesToBeRemoved;for(y=0;y!==X.length;y++)this.removeBody(X[y]);X.length=0,this.emit(this.postStepEvent)},Hn.prototype.runNarrowphase=function(t,e,i,o,n,r,s,a,c,h,l){if(0!=(i.collisionGroup&s.collisionMask)&&0!=(s.collisionGroup&i.collisionMask)){d.rotate(Kn,o,e.angle),d.rotate(Zn,a,r.angle),d.add(Kn,Kn,e.position),d.add(Zn,Zn,r.position);var u,p=n+e.angle,f=c+r.angle;t.enableFriction=h.friction>0,t.frictionCoefficient=h.friction,u=e.type===ot.STATIC||e.type===ot.KINEMATIC?r.mass:r.type===ot.STATIC||r.type===ot.KINEMATIC?e.mass:e.mass*r.mass/(e.mass+r.mass),t.slipForce=h.friction*l*u,t.restitution=h.restitution,t.surfaceVelocity=h.surfaceVelocity,t.frictionStiffness=h.frictionStiffness,t.frictionRelaxation=h.frictionRelaxation,t.stiffness=h.stiffness,t.relaxation=h.relaxation,t.contactSkinSize=h.contactSkinSize,t.enabledEquations=e.collisionResponse&&r.collisionResponse&&i.collisionResponse&&s.collisionResponse;var v=t[i.type|s.type],y=0;if(v){var g=i.sensor||s.sensor,m=t.frictionEquations.length;y=i.type<s.type?v.call(t,e,i,Kn,p,r,s,Zn,f,g):v.call(t,r,s,Zn,f,e,i,Kn,p,g);var b=t.frictionEquations.length-m;if(y){if(e.allowSleep&&e.type===ot.DYNAMIC&&e.sleepState===ot.SLEEPING&&r.sleepState===ot.AWAKE&&r.type!==ot.STATIC)d.squaredLength(r.velocity)+Math.pow(r.angularVelocity,2)>=2*Math.pow(r.sleepSpeedLimit,2)&&(e._wakeUpAfterNarrowphase=!0);if(r.allowSleep&&r.type===ot.DYNAMIC&&r.sleepState===ot.SLEEPING&&e.sleepState===ot.AWAKE&&e.type!==ot.STATIC)d.squaredLength(e.velocity)+Math.pow(e.angularVelocity,2)>=2*Math.pow(e.sleepSpeedLimit,2)&&(r._wakeUpAfterNarrowphase=!0);if(this.overlapKeeper.setOverlapping(e,i,r,s),this.has("beginContact")&&this.overlapKeeper.isNewOverlap(i,s)){var A=this.beginContactEvent;if(A.shapeA=i,A.shapeB=s,A.bodyA=e,A.bodyB=r,A.contactEquations.length=0,"number"==typeof y)for(var E=t.contactEquations.length-y;E<t.contactEquations.length;E++)A.contactEquations.push(t.contactEquations[E]);this.emit(A)}if("number"==typeof y&&b>1)for(E=t.frictionEquations.length-b;E<t.frictionEquations.length;E++){var w=t.frictionEquations[E];w.setSlipForce(w.getSlipForce()/b)}}}}},Hn.prototype.addSpring=function(t){this.springs.push(t);var e=this.addSpringEvent;e.spring=t,this.emit(e),e.spring=null},Hn.prototype.removeSpring=function(t){var e=this.springs.indexOf(t);-1!==e&&p.splice(this.springs,e,1)},Hn.prototype.addBody=function(t){if(-1===this.bodies.indexOf(t)){this.bodies.push(t),t.world=this;var e=this.addBodyEvent;e.body=t,this.emit(e),e.body=null}},Hn.prototype.removeBody=function(t){if(this.stepping)this.bodiesToBeRemoved.push(t);else{t.world=null;var e=this.bodies.indexOf(t);-1!==e&&(p.splice(this.bodies,e,1),this.removeBodyEvent.body=t,t.resetConstraintVelocity(),this.emit(this.removeBodyEvent),this.removeBodyEvent.body=null)}},Hn.prototype.getBodyById=function(t){for(var e=this.bodies,i=0;i<e.length;i++){var o=e[i];if(o.id===t)return o}return!1},Hn.prototype.disableBodyCollision=function(t,e){this.disabledBodyCollisionPairs.push(t,e)},Hn.prototype.enableBodyCollision=function(t,e){for(var i=this.disabledBodyCollisionPairs,o=0;o<i.length;o+=2)if(i[o]===t&&i[o+1]===e||i[o+1]===t&&i[o]===e)return void i.splice(o,2)},Hn.prototype.clear=function(){this.time=0,this.solver&&this.solver.equations.length&&this.solver.removeAllEquations();for(var t=this.constraints,e=t.length-1;e>=0;e--)this.removeConstraint(t[e]);var i=this.bodies;for(e=i.length-1;e>=0;e--)this.removeBody(i[e]);var o=this.springs;for(e=o.length-1;e>=0;e--)this.removeSpring(o[e]);var n=this.contactMaterials;for(e=n.length-1;e>=0;e--)this.removeContactMaterial(n[e]);Hn.apply(this)};var Qn=d.create(),tr=(d.fromValues(0,0),d.fromValues(0,0));Hn.prototype.hitTest=function(t,e,i){i=i||0;var o=new ot({position:t}),n=new fo,r=t,s=Qn,a=tr;o.addShape(n);for(var c=this.narrowphase,h=[],l=0,u=e.length;l!==u;l++)for(var p=e[l],f=0,v=p.shapes.length;f!==v;f++){var y=p.shapes[f];d.rotate(s,y.position,p.angle),d.add(s,s,p.position);var g=y.angle+p.angle;(y instanceof Yt&&c.circleParticle(p,y,s,g,o,n,r,0,!0)||y instanceof R&&c.particleConvex(o,n,r,0,p,y,s,g,!0)||y instanceof co&&c.particlePlane(o,n,r,0,p,y,s,g,!0)||y instanceof Nt&&c.particleCapsule(o,n,r,0,p,y,s,g,!0)||y instanceof fo&&d.squaredLength(d.sub(a,s,t))<i*i)&&h.push(p)}return h},Hn.prototype.setGlobalStiffness=function(t){for(var e=this.constraints,i=0;i!==e.length;i++)for(var o=e[i],n=0;n!==o.equations.length;n++){var r=o.equations[n];r.stiffness=t,r.needsUpdate=!0}var s=this.contactMaterials;for(i=0;i!==s.length;i++){(o=s[i]).stiffness=o.frictionStiffness=t}(o=this.defaultContactMaterial).stiffness=o.frictionStiffness=t},Hn.prototype.setGlobalRelaxation=function(t){for(var e=0;e!==this.constraints.length;e++)for(var i=this.constraints[e],o=0;o!==i.equations.length;o++){var n=i.equations[o];n.relaxation=t,n.needsUpdate=!0}for(e=0;e!==this.contactMaterials.length;e++){(i=this.contactMaterials[e]).relaxation=i.frictionRelaxation=t}(i=this.defaultContactMaterial).relaxation=i.frictionRelaxation=t};var er=new v,ir=[];Hn.prototype.raycast=function(t,e){return e.getAABB(er),this.broadphase.aabbQuery(this,er,ir),e.intersectBodies(t,ir),ir.length=0,t.hasHit()};var or,nr=u(function(t){var e=t.exports={AABB:v,AngleLockEquation:It,Body:ot,Broadphase:Rt,Capsule:Nt,Circle:Yt,Constraint:Zt,ContactEquation:Qt,ContactEquationPool:se,ContactMaterial:le,Convex:R,DistanceConstraint:pe,Equation:St,EventEmitter:it,FrictionEquation:ge,FrictionEquationPool:be,GearConstraint:Ee,GSSolver:Le,Heightfield:Me,Line:Re,LockConstraint:Ue,Material:ce,Narrowphase:oi,NaiveBroadphase:yo,Particle:fo,Plane:co,Pool:ne,RevoluteConstraint:Lo,PrismaticConstraint:Oo,Ray:H,RaycastResult:Q,Box:$e,RotationalVelocityEquation:mo,SAPBroadphase:Go,Shape:F,Solver:Be,Spring:Uo,TopDownVehicle:Wo,LinearSpring:Zo,RotationalSpring:hn,Utils:p,World:Yn,vec2:d,version:Xn.version};Object.defineProperty(e,"Rectangle",{get:function(){return console.warn("The Rectangle class has been renamed to Box."),this.Box}})}),rr=(nr.AABB,nr.AngleLockEquation,nr.Body,nr.Broadphase,nr.Capsule,nr.Circle,nr.Constraint,nr.ContactEquation,nr.ContactEquationPool,nr.ContactMaterial,nr.Convex,nr.DistanceConstraint,nr.Equation,nr.EventEmitter,nr.FrictionEquation,nr.FrictionEquationPool,nr.GearConstraint,nr.GSSolver,nr.Heightfield,nr.Line,nr.LockConstraint,nr.Material,nr.Narrowphase,nr.NaiveBroadphase,nr.Particle,nr.Plane,nr.Pool,nr.RevoluteConstraint,nr.PrismaticConstraint,nr.Ray,nr.RaycastResult,nr.Box,nr.RotationalVelocityEquation,nr.SAPBroadphase,nr.Shape,nr.Solver,nr.Spring,nr.TopDownVehicle,nr.LinearSpring,nr.RotationalSpring,nr.Utils,nr.World,nr.vec2,nr.version,u(function(t,e){(function(t,e){Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,i,o){return i&&t(e.prototype,i),o&&t(e,o),e}}(),o=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var n="",r=void 0,s=void 0;this.escapeRegExp=function(t){return t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},this.parseInt=function(t,e){return/^(\-|\+)?([0-9]+|Infinity)$/.test(t)?parseInt(t,e):NaN},this.seps="cfhistuCFHISTU",this.minLength=parseInt(i,10)>0?i:0,this.salt="string"==typeof e?e:"","string"==typeof o&&(this.alphabet=o);for(var a=0;a!==this.alphabet.length;a++)-1===n.indexOf(this.alphabet.charAt(a))&&(n+=this.alphabet.charAt(a));if(this.alphabet=n,this.alphabet.length<16)throw"error: alphabet must contain at least X unique characters".replace("X",16);if(-1!==this.alphabet.search(" "))throw"error: alphabet cannot contain spaces";for(var c=0;c!==this.seps.length;c++){var h=this.alphabet.indexOf(this.seps.charAt(c));-1===h?this.seps=this.seps.substr(0,c)+" "+this.seps.substr(c+1):this.alphabet=this.alphabet.substr(0,h)+" "+this.alphabet.substr(h+1)}this.alphabet=this.alphabet.replace(/ /g,""),this.seps=this.seps.replace(/ /g,""),this.seps=this._shuffle(this.seps,this.salt),(!this.seps.length||this.alphabet.length/this.seps.length>3.5)&&(r=Math.ceil(this.alphabet.length/3.5))>this.seps.length&&(s=r-this.seps.length,this.seps+=this.alphabet.substr(0,s),this.alphabet=this.alphabet.substr(s)),this.alphabet=this._shuffle(this.alphabet,this.salt);var l=Math.ceil(this.alphabet.length/12);this.alphabet.length<3?(this.guards=this.seps.substr(0,l),this.seps=this.seps.substr(l)):(this.guards=this.alphabet.substr(0,l),this.alphabet=this.alphabet.substr(l))}return i(t,[{key:"encode",value:function(){for(var t=arguments.length,e=Array(t),i=0;i<t;i++)e[i]=arguments[i];if(!e.length)return"";if(e[0]&&e[0].constructor===Array&&!(e=e[0]).length)return"";for(var o=0;o!==e.length;o++)if(e[o]=this.parseInt(e[o],10),!(e[o]>=0))return"";return this._encode(e)}},{key:"decode",value:function(t){return t&&t.length&&"string"==typeof t?this._decode(t,this.alphabet):[]}},{key:"encodeHex",value:function(t){if(t=t.toString(),!/^[0-9a-fA-F]+$/.test(t))return"";for(var e=t.match(/[\w\W]{1,12}/g),i=0;i!==e.length;i++)e[i]=parseInt("1"+e[i],16);return this.encode.apply(this,e)}},{key:"decodeHex",value:function(t){for(var e=[],i=this.decode(t),o=0;o!==i.length;o++)e+=i[o].toString(16).substr(1);return e}},{key:"_encode",value:function(t){for(var e=void 0,i=this.alphabet,o=0,n=0;n!==t.length;n++)o+=t[n]%(n+100);for(var r=e=i.charAt(o%i.length),s=0;s!==t.length;s++){var a=t[s],c=r+this.salt+i;i=this._shuffle(i,c.substr(0,i.length));var h=this._toAlphabet(a,i);if(e+=h,s+1<t.length){var l=(a%=h.charCodeAt(0)+s)%this.seps.length;e+=this.seps.charAt(l)}}if(e.length<this.minLength){var u=(o+e[0].charCodeAt(0))%this.guards.length,p=this.guards[u];(e=p+e).length<this.minLength&&(u=(o+e[2].charCodeAt(0))%this.guards.length,e+=p=this.guards[u])}for(var f=parseInt(i.length/2,10);e.length<this.minLength;){var d=(e=(i=this._shuffle(i,i)).substr(f)+e+i.substr(0,f)).length-this.minLength;d>0&&(e=e.substr(d/2,this.minLength))}return e}},{key:"_decode",value:function(t,e){var i=[],o=0,n=new RegExp("["+this.escapeRegExp(this.guards)+"]","g"),r=t.replace(n," "),s=r.split(" ");if(3!==s.length&&2!==s.length||(o=1),void 0!==(r=s[o])[0]){var a=r[0];r=r.substr(1),n=new RegExp("["+this.escapeRegExp(this.seps)+"]","g"),s=(r=r.replace(n," ")).split(" ");for(var c=0;c!==s.length;c++){var h=s[c],l=a+this.salt+e;e=this._shuffle(e,l.substr(0,e.length)),i.push(this._fromAlphabet(h,e))}this.encode(i)!==t&&(i=[])}return i}},{key:"_shuffle",value:function(t,e){var i=void 0;if(!e.length)return t;for(var o=(t=t.split("")).length-1,n=0,r=0,s=0;o>0;o--,n++){n%=e.length,r+=i=e.charCodeAt(n);var a=t[s=(i+n+r)%o];t[s]=t[o],t[o]=a}return t=t.join("")}},{key:"_toAlphabet",value:function(t,e){var i="";do{i=e.charAt(t%e.length)+i,t=parseInt(t/e.length,10)}while(t);return i}},{key:"_fromAlphabet",value:function(t,e){return t.split("").map(function(t){return e.indexOf(t)}).reduce(function(t,i){return t*e.length+i},0)}}]),t}();e.default=o,t.exports=e.default})(t,e)})),sr=(or=rr)&&or.__esModule&&Object.prototype.hasOwnProperty.call(or,"default")?or.default:or,ar=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},cr=function(){function t(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,i,o){return i&&t(e.prototype,i),o&&t(e,o),e}}(),hr=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},lr=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},ur=function(t){function e(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};ar(this,e);var n=lr(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.manager=t,n.id=e.ids.encode(Date.now()),n.info=Object.assign({owner:void 0},i),n.props=Object.assign({},o),n.data={},n.init(),n}return hr(e,h),cr(e,[{key:"init",value:function(){}},{key:"setProp",value:function(t,e){if(t instanceof Object){for(var i in t)this.props[i]=t[i];this.emit("props-changed",this.props)}else this.props[t]=e,this.emit("props-changed",this.props);return this}},{key:"getProp",value:function(t){return this.props[t]}},{key:"update",value:function(t){}},{key:"destroy",value:function(){return this.manager.removeBullet(this),this}},{key:"die",value:function(){return this.destroy()}},{key:"toJSON",value:function(){var t={id:this.id,info:this.info,props:this.props,type:this.type};return this.emit("to-json",t),t}},{key:"fromJSON",value:function(t){return this.id=t.id||this.id,t.info&&Object.assign(this.info,t.info),t.props&&Object.assign(this.props,t.props),this.init(),this}},{key:"emit",value:function(t){for(var e,i,o,n=arguments.length,r=Array(n>1?n-1:0),s=1;s<n;s++)r[s-1]=arguments[s];var a=(e=h.prototype.emit).call.apply(e,[this,t].concat(r));return(i=this.manager).emit.apply(i,["bullet-"+t,this].concat(r)),(o=this.manager).emit.apply(o,["bullet-"+this.id+"-"+t,this].concat(r)),a}},{key:"game",get:function(){return this.manager.game}},{key:"player",get:function(){return this.game.players.getPlayer(this.info.owner)}},{key:"type",get:function(){return this.manager.getBulletType(this)}}]),e}();function pr(t,e,i){return t*(1-i)+e*i}function fr(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return Math.round(t*Math.pow(10,e))/Math.pow(10,e)}ur.ids=new sr("bullets");var dr={PLAYER:Math.pow(2,0),WALLS:Math.pow(2,1),BULLET:Math.pow(2,2)};dr.ALL=Object.keys(dr).map(function(t){return dr[t]}).reduce(function(t,e){return t|e});var vr=function(t){function e(){return ar(this,e),lr(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return hr(e,ur),cr(e,[{key:"init",value:function(){(function t(e,i,o){null===e&&(e=Function.prototype);var n=Object.getOwnPropertyDescriptor(e,i);if(void 0===n){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,i,o)}if("value"in n)return n.value;var s=n.get;return void 0!==s?s.call(o):void 0})(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"init",this).call(this),this.data.speed=500,this.data.pathPosition=0,this.data.position={x:0,y:0},this.data.path=e.calcPath(this.game.world,{start:[this.props.start.x,this.props.start.y],direction:this.props.direction}),this.data.pathLength=this.data.path.length?this.data.path[this.data.path.length-1][2]:0}},{key:"update",value:function(t){this.data.pathPosition+=this.data.speed*t,this.data.position=e.pointOnPath(this.data.path,this.data.pathPosition),this.data.direction=e.directionOnPath(this.data.path,this.data.pathPosition),this.data.pathPosition>this.data.pathLength&&this.game.isMaster&&this.die()}}],[{key:"calcPath",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t)return[];e=Object.assign({},{maxDistance:1e3,maxBounces:5,start:[0,0],direction:0},e);var i=[],o=0,n=this.calcPath.ray=this.calcPath.ray||new nr.Ray({mode:nr.Ray.CLOSEST,collisionGroup:dr.BULLET,collisionMask:dr.WALLS}),r=this.calcPath.result=this.calcPath.result||new nr.RaycastResult,s=this.calcPath.hitPoint=this.calcPath.hitPoint||nr.vec2.create();n.from[0]=e.start[0],n.from[1]=e.start[1],n.direction[0]=Math.cos(e.direction),n.direction[1]=Math.sin(e.direction),n.to[0]=n.from[0]+n.direction[0]*(e.maxDistance-o),n.to[1]=n.from[1]+n.direction[1]*(e.maxDistance-o),n.update(),i=[[e.start[0],e.start[1],0]];for(var a=0;o<e.maxDistance&&a<e.maxBounces;)if(t.raycast(r,n))a++,r.getHitPoint(s,n),i.push([s[0],s[1],o+=r.getHitDistance(n)]),nr.vec2.copy(n.from,s),nr.vec2.reflect(n.direction,n.direction,r.normal),n.from[0]+=.001*n.direction[0],n.from[1]+=.001*n.direction[1],n.to[0]=n.from[0]+n.direction[0]*(e.maxDistance-o),n.to[1]=n.from[1]+n.direction[1]*(e.maxDistance-o),n.update(),r.reset();else{var c=e.maxDistance-o;i.push([n.to[0],n.to[1],o+=c])}return i}},{key:"pointOnPath",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i={},o=void 0,n=t.find(function(t){return t[2]>e}),r=t.length-1;r>=0;r--)if(t[r][2]<=e){o=t[r];break}if(n){var s=(e-o[2])/(n[2]-o[2]);i.x=pr(o[0],n[0],s),i.y=pr(o[1],n[1],s)}else i.x=o[0],i.y=o[1];return i}},{key:"directionOnPath",value:function(t){for(var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=void 0,o=t.find(function(t){return t[2]>e}),n=t.length-1;n>=0;n--)if(t[n][2]<=e){i=t[n];break}return o?Math.atan2(o[0]-i[0],o[1]-i[1]):0}}]),e}(),yr=function(t){function e(t){ar(this,e);var i=lr(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.game=t,i.bullets=[],i}return hr(e,h),cr(e,[{key:"createBullet",value:function(t,i,o){var n=e.BulletTypes[t];if(n){var r=new n(this,i,o);return this.bullets.push(r),this.emit("bullet-created",r),r}}},{key:"createFromJSON",value:function(t){var i=e.BulletTypes[t.type];if(i){var o=new i(this,t.info,t.props);return o.fromJSON(t),this.bullets.push(o),this.emit("bullet-created",o),o}}},{key:"getBullet",value:function(t){return t instanceof ur?this.bullets.includes(t)?t:void 0:this.bullets.find(function(e){return e.id==t})}},{key:"removeBullet",value:function(t){var e=this.getBullet(t);return this.bullets.includes(e)&&(this.bullets.splice(this.bullets.indexOf(e),1),this.emit("bullet-removed",e)),this}},{key:"clearBullets",value:function(){var t=this;return this.bullets.forEach(function(e){return t.removeBullet(e)}),this.bullets=[],this}},{key:"update",value:function(t){this.bullets.forEach(function(e){return e.update(t)})}},{key:"toJSON",value:function(){var t=this.bullets.map(function(t){return t.toJSON()});return this.emit("to-json",t),t}},{key:"fromJSON",value:function(t){var e=this;return this.clearBullets(),t.forEach(function(t){e.createBullet(t.type).fromJSON(t.data)}),this.emit("from-json",t),this}},{key:"getBulletType",value:function(t){for(var i in e.BulletTypes)if(t instanceof e.BulletTypes[i])return i}}]),e}();yr.BulletTypes={default:vr},yr.BULLET_TYPE={DEFAULT:"default"};var gr=function(t){function e(t,i,o){ar(this,e);var n=lr(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.manager=t,n.id=e.ids.encode(Date.now()),n.info={name:void 0,color:0},n.props={health:100,spawned:!1},n.position={x:0,y:0,vx:0,vy:0,direction:0},n.controls={moveX:0,moveY:0,shoot:!1,direction:0},n.body=new nr.Body({mass:10,damping:0,fixedRotation:!0}),n.body.addShape(new nr.Circle({radius:10})),n.body.shapes.forEach(function(t){t.collisionGroup=dr.PLAYER,t.collisionMask=dr.WALLS|dr.BULLET|dr.PLAYER}),n.cooldown=.15,n.tmp=0,i&&n.setInfo(i),o&&n.setProp(o),n}return hr(e,h),cr(e,[{key:"setProp",value:function(t,e){if(t instanceof Object){for(var i in t)this.props[i]=t[i];this.emit("props-changed",this.props)}else this.props[t]=e,this.emit("props-changed",this.props);return this}},{key:"setInfo",value:function(t,e){if(t instanceof Object){for(var i in t)this.info[i]=t[i];this.emit("info-changed",this.info)}else this.info[t]=e,this.emit("info-changed",this.info);return this}},{key:"setControl",value:function(t,e){if(t instanceof Object){for(var i in t)this.controls[i]=t[i];this.emit("controls-changed",this.controls)}else this.controls[t]=e,this.emit("controls-changed",this.controls);return this}},{key:"getProp",value:function(t,e){return this.props[t]}},{key:"getInfo",value:function(t,e){return this.info[t]}},{key:"getControl",value:function(t,e){return this.controls[t]}},{key:"setPosition",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.body.position[0],e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.body.position[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=arguments[4];this.body.position[0]=t,this.body.position[1]=e,this.body.velocity[0]=i,this.body.velocity[1]=o,this.position.direction=n,this._updatePosition()}},{key:"update",value:function(t){var e=this.game.config.player.movement,i=e.speed,o=e.excelerate,n=e.decelerate;0!==this.controls.moveX?this.body.velocity[0]=pr(this.body.velocity[0],i*Math.sign(this.controls.moveX),o):this.body.velocity[0]*=n,0!==this.controls.moveY?this.body.velocity[1]=pr(this.body.velocity[1],i*Math.sign(this.controls.moveY),o):this.body.velocity[1]*=n,this.tmp+=t,this.controls.shoot&&this.game.isMaster&&this.tmp>this.cooldown&&(this.tmp=0,this.game.bullets.createBullet(yr.BULLET_TYPE.DEFAULT,{owner:this.id},{start:{x:this.position.x,y:this.position.y},direction:this.controls.direction+(Math.random()-.5)*(Math.PI/32)})),this._updatePosition(),this.emit("update",t)}},{key:"_updatePosition",value:function(){this.position.x=fr(this.body.position[0]),this.position.y=fr(this.body.position[1]),this.position.vx=fr(this.body.velocity[0]),this.position.vy=fr(this.body.velocity[1])}},{key:"toJSON",value:function(){var t={id:this.id,info:this.info,props:this.props,position:this.position,controls:this.controls};return this.emit("to-json",t),t}},{key:"fromJSON",value:function(t){return this.id=t.id,this.setInfo(t.info),this.setProp(t.props),this.setControl(t.controls),Object.assign(this.position,t.position),this.emit("from-json",t),this}},{key:"emit",value:function(t){for(var e,i,o,n=arguments.length,r=Array(n>1?n-1:0),s=1;s<n;s++)r[s-1]=arguments[s];var a=(e=h.prototype.emit).call.apply(e,[this,t].concat(r));return(i=this.manager).emit.apply(i,["player-"+t,this].concat(r)),(o=this.manager).emit.apply(o,["player-"+this.id+"-"+t,this].concat(r)),a}},{key:"game",get:function(){return this.manager.game}}]),e}();gr.ids=new sr("players");var mr=function(t){function e(t){ar(this,e);var i=lr(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.game=t,i.players=[],i}return hr(e,h),cr(e,[{key:"getPlayer",value:function(t){return t instanceof gr?this.players.includes(t)?t:void 0:this.players.find(function(e){return e.id===t})}},{key:"createPlayer",value:function(t,e){var i=new gr(this,t,e);return this.players.push(i),this.game.world.addBody(i.body),this.emit("player-created",i),i}},{key:"createFromJSON",value:function(t){var e=new gr(this,t.info,t.props);return e.fromJSON(t),this.players.push(e),this.game.world.addBody(e.body),this.emit("player-created",e),e}},{key:"removePlayer",value:function(t){var e=this.getPlayer(t);return this.players.includes(e)&&(this.players.splice(this.players.indexOf(e),1),this.game.world.removeBody(e.body),this.emit("player-removed",e)),this}},{key:"clearPlayers",value:function(){var t=Array.from(this.players);return this.players.forEach(this.removePlayer.bind(this)),this.emit("players-cleared",t),this}},{key:"update",value:function(t){this.players.forEach(function(e){return e.update(t)})}},{key:"toJSON",value:function(){var t=this.players.map(function(t){return t.toJSON()});return this.emit("to-json",t),t}},{key:"fromJSON",value:function(t){var e=this;return this.clearPlayers(),t.forEach(function(t){e.createPlayer().fromJSON(t)}),this.emit("from-json",t),this}}]),e}();var br=function(){this.__data__=[],this.size=0};var Ar=function(t,e){return t===e||t!=t&&e!=e};var Er=function(t,e){for(var i=t.length;i--;)if(Ar(t[i][0],e))return i;return-1},wr=Array.prototype.splice;var Br=function(t){var e=this.__data__,i=Er(e,t);return!(i<0||(i==e.length-1?e.pop():wr.call(e,i,1),--this.size,0))};var Pr=function(t){var e=this.__data__,i=Er(e,t);return i<0?void 0:e[i][1]};var Sr=function(t){return Er(this.__data__,t)>-1};var Lr=function(t,e){var i=this.__data__,o=Er(i,t);return o<0?(++this.size,i.push([t,e])):i[o][1]=e,this};function qr(t){var e=-1,i=null==t?0:t.length;for(this.clear();++e<i;){var o=t[e];this.set(o[0],o[1])}}qr.prototype.clear=br,qr.prototype.delete=Br,qr.prototype.get=Pr,qr.prototype.has=Sr,qr.prototype.set=Lr;var Mr=qr;var xr=function(){this.__data__=new Mr,this.size=0};var Cr=function(t){var e=this.__data__,i=e.delete(t);return this.size=e.size,i};var _r=function(t){return this.__data__.get(t)};var Fr=function(t){return this.__data__.has(t)},Or="object"==typeof l&&l&&l.Object===Object&&l,Ir="object"==typeof self&&self&&self.Object===Object&&self,kr=Or||Ir||Function("return this")(),Rr=kr.Symbol,Vr=Object.prototype,Tr=Vr.hasOwnProperty,Nr=Vr.toString,jr=Rr?Rr.toStringTag:void 0;var Gr=function(t){var e=Tr.call(t,jr),i=t[jr];try{t[jr]=void 0;var o=!0}catch(t){}var n=Nr.call(t);return o&&(e?t[jr]=i:delete t[jr]),n},Dr=Object.prototype.toString;var Ur=function(t){return Dr.call(t)},zr="[object Null]",Wr="[object Undefined]",Xr=Rr?Rr.toStringTag:void 0;var Yr=function(t){return null==t?void 0===t?Wr:zr:Xr&&Xr in Object(t)?Gr(t):Ur(t)};var Hr=function(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)},Jr="[object AsyncFunction]",Kr="[object Function]",Zr="[object GeneratorFunction]",$r="[object Proxy]";var Qr,ts=function(t){if(!Hr(t))return!1;var e=Yr(t);return e==Kr||e==Zr||e==Jr||e==$r},es=kr["__core-js_shared__"],is=(Qr=/[^.]+$/.exec(es&&es.keys&&es.keys.IE_PROTO||""))?"Symbol(src)_1."+Qr:"";var os=function(t){return!!is&&is in t},ns=Function.prototype.toString;var rs=function(t){if(null!=t){try{return ns.call(t)}catch(t){}try{return t+""}catch(t){}}return""},ss=/^\[object .+?Constructor\]$/,as=Function.prototype,cs=Object.prototype,hs=as.toString,ls=cs.hasOwnProperty,us=RegExp("^"+hs.call(ls).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var ps=function(t){return!(!Hr(t)||os(t))&&(ts(t)?us:ss).test(rs(t))};var fs=function(t,e){return null==t?void 0:t[e]};var ds=function(t,e){var i=fs(t,e);return ps(i)?i:void 0},vs=ds(kr,"Map"),ys=ds(Object,"create");var gs=function(){this.__data__=ys?ys(null):{},this.size=0};var ms=function(t){var e=this.has(t)&&delete this.__data__[t];return this.size-=e?1:0,e},bs="__lodash_hash_undefined__",As=Object.prototype.hasOwnProperty;var Es=function(t){var e=this.__data__;if(ys){var i=e[t];return i===bs?void 0:i}return As.call(e,t)?e[t]:void 0},ws=Object.prototype.hasOwnProperty;var Bs=function(t){var e=this.__data__;return ys?void 0!==e[t]:ws.call(e,t)},Ps="__lodash_hash_undefined__";var Ss=function(t,e){var i=this.__data__;return this.size+=this.has(t)?0:1,i[t]=ys&&void 0===e?Ps:e,this};function Ls(t){var e=-1,i=null==t?0:t.length;for(this.clear();++e<i;){var o=t[e];this.set(o[0],o[1])}}Ls.prototype.clear=gs,Ls.prototype.delete=ms,Ls.prototype.get=Es,Ls.prototype.has=Bs,Ls.prototype.set=Ss;var qs=Ls;var Ms=function(){this.size=0,this.__data__={hash:new qs,map:new(vs||Mr),string:new qs}};var xs=function(t){var e=typeof t;return"string"==e||"number"==e||"symbol"==e||"boolean"==e?"__proto__"!==t:null===t};var Cs=function(t,e){var i=t.__data__;return xs(e)?i["string"==typeof e?"string":"hash"]:i.map};var _s=function(t){var e=Cs(this,t).delete(t);return this.size-=e?1:0,e};var Fs=function(t){return Cs(this,t).get(t)};var Os=function(t){return Cs(this,t).has(t)};var Is=function(t,e){var i=Cs(this,t),o=i.size;return i.set(t,e),this.size+=i.size==o?0:1,this};function ks(t){var e=-1,i=null==t?0:t.length;for(this.clear();++e<i;){var o=t[e];this.set(o[0],o[1])}}ks.prototype.clear=Ms,ks.prototype.delete=_s,ks.prototype.get=Fs,ks.prototype.has=Os,ks.prototype.set=Is;var Rs=ks,Vs=200;var Ts=function(t,e){var i=this.__data__;if(i instanceof Mr){var o=i.__data__;if(!vs||o.length<Vs-1)return o.push([t,e]),this.size=++i.size,this;i=this.__data__=new Rs(o)}return i.set(t,e),this.size=i.size,this};function Ns(t){var e=this.__data__=new Mr(t);this.size=e.size}Ns.prototype.clear=xr,Ns.prototype.delete=Cr,Ns.prototype.get=_r,Ns.prototype.has=Fr,Ns.prototype.set=Ts;var js=Ns,Gs="__lodash_hash_undefined__";var Ds=function(t){return this.__data__.set(t,Gs),this};var Us=function(t){return this.__data__.has(t)};function zs(t){var e=-1,i=null==t?0:t.length;for(this.__data__=new Rs;++e<i;)this.add(t[e])}zs.prototype.add=zs.prototype.push=Ds,zs.prototype.has=Us;var Ws=zs;var Xs=function(t,e){for(var i=-1,o=null==t?0:t.length;++i<o;)if(e(t[i],i,t))return!0;return!1};var Ys=function(t,e){return t.has(e)},Hs=1,Js=2;var Ks=function(t,e,i,o,n,r){var s=i&Hs,a=t.length,c=e.length;if(a!=c&&!(s&&c>a))return!1;var h=r.get(t);if(h&&r.get(e))return h==e;var l=-1,u=!0,p=i&Js?new Ws:void 0;for(r.set(t,e),r.set(e,t);++l<a;){var f=t[l],d=e[l];if(o)var v=s?o(d,f,l,e,t,r):o(f,d,l,t,e,r);if(void 0!==v){if(v)continue;u=!1;break}if(p){if(!Xs(e,function(t,e){if(!Ys(p,e)&&(f===t||n(f,t,i,o,r)))return p.push(e)})){u=!1;break}}else if(f!==d&&!n(f,d,i,o,r)){u=!1;break}}return r.delete(t),r.delete(e),u},Zs=kr.Uint8Array;var $s=function(t){var e=-1,i=Array(t.size);return t.forEach(function(t,o){i[++e]=[o,t]}),i};var Qs=function(t){var e=-1,i=Array(t.size);return t.forEach(function(t){i[++e]=t}),i},ta=1,ea=2,ia="[object Boolean]",oa="[object Date]",na="[object Error]",ra="[object Map]",sa="[object Number]",aa="[object RegExp]",ca="[object Set]",ha="[object String]",la="[object Symbol]",ua="[object ArrayBuffer]",pa="[object DataView]",fa=Rr?Rr.prototype:void 0,da=fa?fa.valueOf:void 0;var va=function(t,e,i,o,n,r,s){switch(i){case pa:if(t.byteLength!=e.byteLength||t.byteOffset!=e.byteOffset)return!1;t=t.buffer,e=e.buffer;case ua:return!(t.byteLength!=e.byteLength||!r(new Zs(t),new Zs(e)));case ia:case oa:case sa:return Ar(+t,+e);case na:return t.name==e.name&&t.message==e.message;case aa:case ha:return t==e+"";case ra:var a=$s;case ca:var c=o&ta;if(a||(a=Qs),t.size!=e.size&&!c)return!1;var h=s.get(t);if(h)return h==e;o|=ea,s.set(t,e);var l=Ks(a(t),a(e),o,n,r,s);return s.delete(t),l;case la:if(da)return da.call(t)==da.call(e)}return!1};var ya=function(t,e){for(var i=-1,o=e.length,n=t.length;++i<o;)t[n+i]=e[i];return t},ga=Array.isArray;var ma=function(t,e,i){var o=e(t);return ga(t)?o:ya(o,i(t))};var ba=function(t,e){for(var i=-1,o=null==t?0:t.length,n=0,r=[];++i<o;){var s=t[i];e(s,i,t)&&(r[n++]=s)}return r};var Aa=function(){return[]},Ea=Object.prototype.propertyIsEnumerable,wa=Object.getOwnPropertySymbols,Ba=wa?function(t){return null==t?[]:(t=Object(t),ba(wa(t),function(e){return Ea.call(t,e)}))}:Aa;var Pa=function(t,e){for(var i=-1,o=Array(t);++i<t;)o[i]=e(i);return o};var Sa=function(t){return null!=t&&"object"==typeof t},La="[object Arguments]";var qa=function(t){return Sa(t)&&Yr(t)==La},Ma=Object.prototype,xa=Ma.hasOwnProperty,Ca=Ma.propertyIsEnumerable,_a=qa(function(){return arguments}())?qa:function(t){return Sa(t)&&xa.call(t,"callee")&&!Ca.call(t,"callee")};var Fa=function(){return!1},Oa=u(function(t,e){var i=e&&!e.nodeType&&e,o=i&&t&&!t.nodeType&&t,n=o&&o.exports===i?kr.Buffer:void 0,r=(n?n.isBuffer:void 0)||Fa;t.exports=r}),Ia=9007199254740991,ka=/^(?:0|[1-9]\d*)$/;var Ra=function(t,e){var i=typeof t;return!!(e=null==e?Ia:e)&&("number"==i||"symbol"!=i&&ka.test(t))&&t>-1&&t%1==0&&t<e},Va=9007199254740991;var Ta=function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=Va},Na={};Na["[object Float32Array]"]=Na["[object Float64Array]"]=Na["[object Int8Array]"]=Na["[object Int16Array]"]=Na["[object Int32Array]"]=Na["[object Uint8Array]"]=Na["[object Uint8ClampedArray]"]=Na["[object Uint16Array]"]=Na["[object Uint32Array]"]=!0,Na["[object Arguments]"]=Na["[object Array]"]=Na["[object ArrayBuffer]"]=Na["[object Boolean]"]=Na["[object DataView]"]=Na["[object Date]"]=Na["[object Error]"]=Na["[object Function]"]=Na["[object Map]"]=Na["[object Number]"]=Na["[object Object]"]=Na["[object RegExp]"]=Na["[object Set]"]=Na["[object String]"]=Na["[object WeakMap]"]=!1;var ja=function(t){return Sa(t)&&Ta(t.length)&&!!Na[Yr(t)]};var Ga=function(t){return function(e){return t(e)}},Da=u(function(t,e){var i=e&&!e.nodeType&&e,o=i&&t&&!t.nodeType&&t,n=o&&o.exports===i&&Or.process,r=function(){try{return n&&n.binding&&n.binding("util")}catch(t){}}();t.exports=r}),Ua=Da&&Da.isTypedArray,za=Ua?Ga(Ua):ja,Wa=Object.prototype.hasOwnProperty;var Xa=function(t,e){var i=ga(t),o=!i&&_a(t),n=!i&&!o&&Oa(t),r=!i&&!o&&!n&&za(t),s=i||o||n||r,a=s?Pa(t.length,String):[],c=a.length;for(var h in t)!e&&!Wa.call(t,h)||s&&("length"==h||n&&("offset"==h||"parent"==h)||r&&("buffer"==h||"byteLength"==h||"byteOffset"==h)||Ra(h,c))||a.push(h);return a},Ya=Object.prototype;var Ha=function(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||Ya)};var Ja=function(t,e){return function(i){return t(e(i))}}(Object.keys,Object),Ka=Object.prototype.hasOwnProperty;var Za=function(t){if(!Ha(t))return Ja(t);var e=[];for(var i in Object(t))Ka.call(t,i)&&"constructor"!=i&&e.push(i);return e};var $a=function(t){return null!=t&&Ta(t.length)&&!ts(t)};var Qa=function(t){return $a(t)?Xa(t):Za(t)};var tc=function(t){return ma(t,Qa,Ba)},ec=1,ic=Object.prototype.hasOwnProperty;var oc=function(t,e,i,o,n,r){var s=i&ec,a=tc(t),c=a.length;if(c!=tc(e).length&&!s)return!1;for(var h=c;h--;){var l=a[h];if(!(s?l in e:ic.call(e,l)))return!1}var u=r.get(t);if(u&&r.get(e))return u==e;var p=!0;r.set(t,e),r.set(e,t);for(var f=s;++h<c;){var d=t[l=a[h]],v=e[l];if(o)var y=s?o(v,d,l,e,t,r):o(d,v,l,t,e,r);if(!(void 0===y?d===v||n(d,v,i,o,r):y)){p=!1;break}f||(f="constructor"==l)}if(p&&!f){var g=t.constructor,m=e.constructor;g!=m&&"constructor"in t&&"constructor"in e&&!("function"==typeof g&&g instanceof g&&"function"==typeof m&&m instanceof m)&&(p=!1)}return r.delete(t),r.delete(e),p},nc=ds(kr,"DataView"),rc=ds(kr,"Promise"),sc=ds(kr,"Set"),ac=ds(kr,"WeakMap"),cc=rs(nc),hc=rs(vs),lc=rs(rc),uc=rs(sc),pc=rs(ac),fc=Yr;(nc&&"[object DataView]"!=fc(new nc(new ArrayBuffer(1)))||vs&&"[object Map]"!=fc(new vs)||rc&&"[object Promise]"!=fc(rc.resolve())||sc&&"[object Set]"!=fc(new sc)||ac&&"[object WeakMap]"!=fc(new ac))&&(fc=function(t){var e=Yr(t),i="[object Object]"==e?t.constructor:void 0,o=i?rs(i):"";if(o)switch(o){case cc:return"[object DataView]";case hc:return"[object Map]";case lc:return"[object Promise]";case uc:return"[object Set]";case pc:return"[object WeakMap]"}return e});var dc=fc,vc=1,yc="[object Arguments]",gc="[object Array]",mc="[object Object]",bc=Object.prototype.hasOwnProperty;var Ac=function(t,e,i,o,n,r){var s=ga(t),a=ga(e),c=s?gc:dc(t),h=a?gc:dc(e),l=(c=c==yc?mc:c)==mc,u=(h=h==yc?mc:h)==mc,p=c==h;if(p&&Oa(t)){if(!Oa(e))return!1;s=!0,l=!1}if(p&&!l)return r||(r=new js),s||za(t)?Ks(t,e,i,o,n,r):va(t,e,c,i,o,n,r);if(!(i&vc)){var f=l&&bc.call(t,"__wrapped__"),d=u&&bc.call(e,"__wrapped__");if(f||d){var v=f?t.value():t,y=d?e.value():e;return r||(r=new js),n(v,y,i,o,r)}}return!!p&&(r||(r=new js),oc(t,e,i,o,n,r))};var Ec=function t(e,i,o,n,r){return e===i||(null==e||null==i||!Sa(e)&&!Sa(i)?e!=e&&i!=i:Ac(e,i,o,n,t,r))};var wc=function(t,e){return Ec(t,e)},Bc=function(t){function e(t){ar(this,e);var i=lr(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.game=t,i.size={width:0,height:0},i.bodies=[],i.spawnAreas=[],i.loadedJSON={},i}return hr(e,h),cr(e,[{key:"clearBodies",value:function(){var t=this;return this.bodies.forEach(function(e){return t.game.world.removeBody(e)}),this.bodies=[],this.emit("collisions-cleared"),this}},{key:"toJSON",value:function(){return this.loadedJSON}},{key:"fromJSON",value:function(t){var i=this;return this.clearBodies(),this.loadedJSON=t,this.size.width=t.size.width,this.size.height=t.size.height,this.bodies=e.buildCollisions(t.collisions),this.bodies.forEach(function(t){t.shapes.forEach(function(t){t.collisionGroup=dr.WALLS,t.collisionMask=dr.ALL})}),this.bodies.forEach(function(t){return i.game.world.addBody(t)}),this.emit("from-json",t),this}},{key:"getSpawnPoint",value:function(){return{x:this.size.width/2*50,y:this.size.height/2*50}}}],[{key:"buildCollisions",value:function(t){for(var e=[],i=0;i<t.length;i++){var o=t[i];if(o.visible)if(Array.isArray(o.polygon)){var n=new nr.Body({mass:0});n.position[0]=o.x,n.position[1]=o.y,n.fromPolygon(o.polygon.map(function(t){return[t.x,t.y]})),e.push(n)}else if(Array.isArray(o.polyline)){var r=new nr.Body({mass:0});r.position[0]=o.x,r.position[1]=o.y;for(var s=1;s<o.polyline.length;s++){var a=o.polyline[s-1],c=o.polyline[s],h=Math.sqrt(Math.pow(c.x-a.x,2)+Math.pow(c.y-a.y,2)),l=Math.atan2(c.y-a.y,c.x-a.x);r.addShape(new nr.Line({position:[pr(a.x,c.x,.5),pr(a.y,c.y,.5)],length:h,angle:l}))}e.push(r)}else if(o.height>0&&o.width>0){var u=new nr.Body({mass:0});u.position[0]=o.x+o.width/2,u.position[1]=o.y+o.height/2,u.addShape(new nr.Box({width:o.width,height:o.height})),e.push(u)}}return e}},{key:"parseTiledJSON",value:function(t){var e={size:{width:t.width,height:t.height},types:[],tiles:[]};e.collisions=t.layers.find(function(t){return t.objects&&"collision"==t.name&&"objectgroup"==t.type}).objects;var i={};return t.tilesets.forEach(function(t){for(var e in t.tileproperties){var o=parseInt(e)+t.firstgid;Reflect.ownKeys(t.tileproperties[e]).length>0&&(i[o]||(i[o]={}),Object.assign(i[o],t.tileproperties[e]))}}),t.layers.filter(function(t){return"tilelayer"===t.type}).forEach(function(o){for(var n=0;n<o.data.length;n++){var r=Math.floor(n/t.width),s=n-r*t.width;e.tiles[r]||(e.tiles[r]=[]),e.tiles[r][s]||(e.tiles[r][s]=[]);var a=i[o.data[n]];a&&e.tiles[r][s].push(a)}}),e.tiles=e.tiles.map(function(t){return t.map(function(t){var i=e.types.find(function(e){return wc(t,e)});return!i&&t.length>0&&e.types.push(i=t),e.types.indexOf(i)})}),e}}]),e}(),Pc={player:{movement:{speed:180,excelerate:.9,decelerate:.7},max:10}},Sc=function(t){function e(){ar(this,e);var t=lr(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.id=e.ids.encode(Date.now()),t.info={},t.isMaster=!1,t.config=JSON.parse(JSON.stringify(Pc)),t.players=new mr(t),t.map=new Bc(t),t.bullets=new yr(t),t.world=new nr.World({gravity:[0,0]}),t}return hr(e,h),cr(e,[{key:"getPlayer",value:function(){var t;return(t=this.players).getPlayer.apply(t,arguments)}},{key:"createPlayer",value:function(){var t;return(t=this.players).createPlayer.apply(t,arguments)}},{key:"removePlayer",value:function(){var t;return(t=this.players).removePlayer.apply(t,arguments)}},{key:"spawnPlayer",value:function(t){var e=this.players.getPlayer(t),i=this.map.getSpawnPoint();return e.setPosition(i.x,i.y),e.setProp("spawned",!0),this}},{key:"setInfo",value:function(t,e){if(t instanceof Object){for(var i in t)this.info[i]=t[i];this.emit("info-changed",t)}else this.info[t]=e,this.emit("info-changed",t,e);return this}},{key:"getInfo",value:function(t,e){return this.info[t]}},{key:"getDelta",value:function(){var t=new Date,e=(t-this.lastDelta)/1e3;return this.lastDelta=t,e}},{key:"update",value:function(){var t=this.getDelta();this.world.step(1/60,t,1),this.players.update(t),this.bullets.update(t),this.emit("update",t)}},{key:"toJSON",value:function(){var t={id:this.id,info:this.info,config:this.config,map:this.map.toJSON(),players:this.players.toJSON()};return this.emit("to-json",t),t}},{key:"fromJSON",value:function(t){return this.id=t.id,this.setInfo(t.info),this.players.fromJSON(t.players),this.map.fromJSON(t.map),this.emit("from-json",t),this}},{key:"isClient",get:function(){return!this.isMaster}}]),e}();Sc.ids=new sr("games"),Sc.DEFAULT_FPS=1/60,t.Game=Sc,t.Player=gr,t.PlayerManager=mr,t.Tilemap=Bc,t.Bullet=ur,t.BulletManager=yr,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=lazer-game-core.umd.min.js.map
